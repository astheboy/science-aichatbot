<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 대시보드 - AI 챗봇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 로그인 화면 -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">교사 전용 페이지</h1>
                <p class="text-gray-600">AI 챗봇을 설정하고 관리하세요</p>
            </div>
            
            <button id="google-login-btn" class="w-full bg-white border border-gray-300 text-gray-700 py-3 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Google 계정으로 로그인</span>
            </button>

            <div id="login-loading" class="hidden text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <p class="text-gray-600 mt-2">로그인 중...</p>
            </div>
        </div>
    </div>

    <!-- 대시보드 화면 -->
    <div id="dashboard-screen" class="hidden">
        <!-- 헤더 -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-800">AI 챗봇 교사 대시보드</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <img id="user-photo" class="w-8 h-8 rounded-full" alt="프로필">
                        <span id="user-name" class="text-gray-700 font-medium"></span>
                    </div>
                    <button id="logout-btn" class="text-gray-500 hover:text-gray-700 px-3 py-1 rounded-md hover:bg-gray-100">
                        로그아웃
                    </button>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="max-w-6xl mx-auto px-4 py-8">
            <!-- API 키 설정 카드 -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">Gemini API 키 설정</h2>
                        <p class="text-gray-600 text-sm mt-1">학생들이 AI 튜터를 사용할 수 있도록 API 키를 등록하세요</p>
                    </div>
                    <div id="api-status" class="px-3 py-1 rounded-full text-sm font-medium hidden">
                        <!-- API 상태가 여기에 표시됩니다 -->
                    </div>
                </div>

                <div id="api-setup-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Google Gemini API 키
                        </label>
                        <div class="flex space-x-3">
                            <textarea 
                                id="api-key-input"
                                placeholder="AIzaSy..."
                                rows="2"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                            ></textarea>
                            <button id="save-api-key-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                저장
                            </button>
                        </div>
                        <div class="mt-2 flex items-center space-x-4 text-sm text-gray-600">
                            <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-600 hover:underline flex items-center space-x-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                                <span>API 키 발급받기</span>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="api-configured" class="hidden">
                    <div class="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-md">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="text-green-700 font-medium">API 키가 성공적으로 등록되었습니다!</span>
                        </div>
                        <button id="update-api-key-btn" class="text-green-600 hover:text-green-800 text-sm font-medium">
                            수정
                        </button>
                    </div>
                </div>
            </div>

            <!-- 프롬프트 설정 카드 -->
            <div id="prompt-settings-section" class="bg-white rounded-lg shadow-sm border p-6 mb-8 hidden">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">AI 튜터 프롬프트 설정</h2>
                        <p class="text-gray-600 text-sm mt-1">AI 튜터의 역할과 응답 방식을 사용자 정의하세요</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="reset-prompt-btn" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                            기본값으로 되돌리기
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            사용자 정의 프롬프트
                        </label>
                        <textarea 
                            id="custom-prompt-input"
                            placeholder="AI 튜터가 어떻게 학생들에게 응답해야 하는지 설명하세요..."
                            rows="8"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
                        ></textarea>
                        <div class="mt-2 text-sm text-gray-600">
                            <p><strong>예시:</strong> "너는 친근하고 격려하는 과학 튜터야. 학생들이 그래비트랙스 실험을 통해 물리학 원리를 이해할 수 있도록 도와줘. 항상 긍정적이고 호기심을 유발하는 질문을 던져줘."</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button id="preview-prompt-btn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                            미리보기
                        </button>
                        <button id="save-prompt-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                            저장
                        </button>
                    </div>
                </div>

                <!-- 프롬프트 미리보기 영역 -->
                <div id="prompt-preview" class="hidden mt-6 p-4 bg-gray-50 border rounded-md">
                    <h4 class="text-sm font-medium text-gray-800 mb-2">미리보기:</h4>
                    <div id="prompt-preview-content" class="text-sm text-gray-700 whitespace-pre-wrap"></div>
                </div>
            </div>

            <!-- 교사 코드 및 사용법 카드 -->
            <div id="teacher-code-section" class="hidden">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- 교사 코드 카드 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">내 교사 코드</h3>
                        <div class="bg-gray-50 border rounded-md p-4 mb-4">
                            <div class="flex items-center justify-between">
                                <code id="teacher-code-display" class="text-lg font-mono font-semibold text-blue-600"></code>
                                <button id="copy-code-btn" class="text-gray-500 hover:text-gray-700 p-1 rounded">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">학생들에게 이 코드를 알려주세요</p>
                    </div>

                    <!-- 사용법 카드 -->
                    <div class="bg-white rounded-lg shadow-sm border p-6 card-hover">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">학생 사용법 안내</h3>
                        <div class="space-y-3 text-sm text-gray-600">
                            <div class="flex items-start space-x-2">
                                <span class="bg-blue-100 text-blue-600 text-xs font-semibold px-2 py-1 rounded-full">1</span>
                                <p>학생들에게 메인 사이트 주소를 알려주세요:<br>
                                <a href="https://science-aichatbot.web.app" class="text-blue-600 hover:underline font-medium">science-aichatbot.web.app</a></p>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="bg-blue-100 text-blue-600 text-xs font-semibold px-2 py-1 rounded-full">2</span>
                                <p>챗봇 영역에서 위의 <strong>교사 코드</strong>를 입력하고 저장하게 하세요</p>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="bg-blue-100 text-blue-600 text-xs font-semibold px-2 py-1 rounded-full">3</span>
                                <p>이제 학생들이 그래비트랙스 실험에 대해 AI 튜터와 대화할 수 있습니다!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 상태 메시지 -->
            <div id="status-message" class="mt-6 p-4 rounded-md hidden">
                <!-- 상태 메시지가 여기에 표시됩니다 -->
            </div>
        </main>
    </div>

    <script type="module">
        import { 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
        import { auth, functions } from './firebase-config.js';

        // Firebase Functions
        const updateTeacherApiKey = httpsCallable(functions, 'updateTeacherApiKey');
        const getTeacherInfo = httpsCallable(functions, 'getTeacherInfo');
        const updateTeacherPrompt = httpsCallable(functions, 'updateTeacherPrompt');

        // DOM 요소들
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const loginLoading = document.getElementById('login-loading');
        const logoutBtn = document.getElementById('logout-btn');
        const userPhoto = document.getElementById('user-photo');
        const userName = document.getElementById('user-name');
        
        const apiSetupForm = document.getElementById('api-setup-form');
        const apiConfigured = document.getElementById('api-configured');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const updateApiKeyBtn = document.getElementById('update-api-key-btn');
        const apiStatus = document.getElementById('api-status');
        
        const teacherCodeSection = document.getElementById('teacher-code-section');
        const teacherCodeDisplay = document.getElementById('teacher-code-display');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const statusMessage = document.getElementById('status-message');
        
        // 프롬프트 설정 요소들
        const promptSettingsSection = document.getElementById('prompt-settings-section');
        const customPromptInput = document.getElementById('custom-prompt-input');
        const savePromptBtn = document.getElementById('save-prompt-btn');
        const previewPromptBtn = document.getElementById('preview-prompt-btn');
        const resetPromptBtn = document.getElementById('reset-prompt-btn');
        const promptPreview = document.getElementById('prompt-preview');
        const promptPreviewContent = document.getElementById('prompt-preview-content');

        // Google 로그인
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                loginLoading.classList.remove('hidden');
                googleLoginBtn.classList.add('hidden');
                
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('로그인 실패:', error);
                showStatus('로그인에 실패했습니다. 다시 시도해주세요.', 'error');
                
                loginLoading.classList.add('hidden');
                googleLoginBtn.classList.remove('hidden');
            }
        });

        // 로그아웃
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('로그아웃 실패:', error);
            }
        });

        // API 키 저장
        saveApiKeyBtn.addEventListener('click', async () => {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showStatus('API 키를 입력해주세요.', 'error');
                return;
            }

            try {
                saveApiKeyBtn.textContent = '저장 중...';
                saveApiKeyBtn.disabled = true;

                await updateTeacherApiKey({ apiKey });
                
                showStatus('API 키가 성공적으로 저장되었습니다!', 'success');
                await loadTeacherInfo();
                
            } catch (error) {
                console.error('API 키 저장 실패:', error);
                showStatus(`저장 실패: ${error.message}`, 'error');
            } finally {
                saveApiKeyBtn.textContent = '저장';
                saveApiKeyBtn.disabled = false;
            }
        });

        // API 키 수정
        updateApiKeyBtn.addEventListener('click', () => {
            apiConfigured.classList.add('hidden');
            apiSetupForm.classList.remove('hidden');
            teacherCodeSection.classList.add('hidden');
        });

        // 교사 코드 복사
        copyCodeBtn.addEventListener('click', async () => {
            const code = teacherCodeDisplay.textContent;
            try {
                await navigator.clipboard.writeText(code);
                showStatus('교사 코드가 클립보드에 복사되었습니다!', 'success');
            } catch (error) {
                // 클립보드 API가 지원되지 않는 경우
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('교사 코드가 클립보드에 복사되었습니다!', 'success');
            }
        });

        // 프롬프트 저장
        savePromptBtn.addEventListener('click', async () => {
            const prompt = customPromptInput.value.trim();
            if (!prompt) {
                showStatus('프롬프트를 입력해주세요.', 'error');
                return;
            }

            try {
                savePromptBtn.textContent = '저장 중...';
                savePromptBtn.disabled = true;

                await updateTeacherPrompt({ prompt });
                
                showStatus('프롬프트가 성공적으로 저장되었습니다!', 'success');
                promptPreview.classList.add('hidden');
                
            } catch (error) {
                console.error('프롬프트 저장 실패:', error);
                showStatus(`저장 실패: ${error.message}`, 'error');
            } finally {
                savePromptBtn.textContent = '저장';
                savePromptBtn.disabled = false;
            }
        });

        // 프롬프트 미리보기
        previewPromptBtn.addEventListener('click', () => {
            const prompt = customPromptInput.value.trim();
            if (!prompt) {
                showStatus('먼저 프롬프트를 입력해주세요.', 'error');
                return;
            }

            promptPreviewContent.textContent = prompt;
            promptPreview.classList.remove('hidden');
        });

        // 프롬프트 초기화
        resetPromptBtn.addEventListener('click', () => {
            const defaultPrompt = "너는 친근하고 격려하는 과학 튜터야. 학생들이 그래비트랙스(GraviTrax) 실험을 통해 물리학 원리를 이해할 수 있도록 도와줘. 항상 긍정적이고 호기심을 유발하는 질문을 던져줘. 학생들의 질문에 대해 직접적인 답을 주기보다는, 스스로 생각해볼 수 있도록 힌트를 제공해줘.";
            
            if (confirm('프롬프트를 기본값으로 되돌리시겠습니까?')) {
                customPromptInput.value = defaultPrompt;
                promptPreview.classList.add('hidden');
            }
        });

        // 인증 상태 변경 감지
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 로그인됨
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                
                // 사용자 정보 표시
                userPhoto.src = user.photoURL || 'https://via.placeholder.com/32';
                userName.textContent = user.displayName || user.email;
                
                // 교사 정보 로드
                await loadTeacherInfo();
                
            } else {
                // 로그아웃됨
                loginScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
                loginLoading.classList.add('hidden');
                googleLoginBtn.classList.remove('hidden');
            }
        });

        // 교사 정보 로드
        async function loadTeacherInfo() {
            try {
                const result = await getTeacherInfo();
                const data = result.data;
                
                if (data.hasApiKey) {
                    // API 키가 등록됨
                    apiSetupForm.classList.add('hidden');
                    apiConfigured.classList.remove('hidden');
                    teacherCodeSection.classList.remove('hidden');
                    promptSettingsSection.classList.remove('hidden');
                    
                    teacherCodeDisplay.textContent = data.teacherCode;
                    
                    // 기존 프롬프트 데이터 로드
                    if (data.customPrompt) {
                        customPromptInput.value = data.customPrompt;
                    } else {
                        // 기본 프롬프트 설정
                        const defaultPrompt = "너는 친근하고 격려하는 과학 튜터야. 학생들이 그래비트랙스(GraviTrax) 실험을 통해 물리학 원리를 이해할 수 있도록 도와줘. 항상 긍정적이고 호기심을 유발하는 질문을 던져줘. 학생들의 질문에 대해 직접적인 답을 주기보다는, 스스로 생각해볼 수 있도록 힌트를 제공해줘.";
                        customPromptInput.value = defaultPrompt;
                    }
                    
                    apiStatus.textContent = 'API 연결됨';
                    apiStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700';
                    apiStatus.classList.remove('hidden');
                    
                } else {
                    // API 키 미등록
                    apiSetupForm.classList.remove('hidden');
                    apiConfigured.classList.add('hidden');
                    teacherCodeSection.classList.add('hidden');
                    promptSettingsSection.classList.add('hidden');
                    
                    apiStatus.textContent = 'API 미설정';
                    apiStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-700';
                    apiStatus.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('교사 정보 로드 실패:', error);
                showStatus('정보를 불러오는데 실패했습니다.', 'error');
            }
        }

        // 상태 메시지 표시
        function showStatus(message, type, duration = 5000) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-6 p-4 rounded-md ${getStatusClasses(type)}`;
            statusMessage.classList.remove('hidden');

            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, duration);
        }

        function getStatusClasses(type) {
            switch (type) {
                case 'success':
                    return 'bg-green-100 text-green-800 border border-green-300';
                case 'error':
                    return 'bg-red-100 text-red-800 border border-red-300';
                case 'info':
                    return 'bg-blue-100 text-blue-800 border border-blue-300';
                default:
                    return 'bg-gray-100 text-gray-800 border border-gray-300';
            }
        }
    </script>
</body>
</html>
