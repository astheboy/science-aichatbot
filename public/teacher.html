<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사 대시보드 - AI 챗봇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script>
        // QRCode 라이브러리 로딩 확인
        document.addEventListener('DOMContentLoaded', function () {
            console.log('QRious library loaded:', typeof QRious !== 'undefined');
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- 로그인 화면 -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                        </path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">교사 전용 페이지</h1>
                <p class="text-gray-600">AI 챗봇을 설정하고 관리하세요</p>
            </div>

            <button id="google-login-btn"
                class="w-full bg-white border border-gray-300 text-gray-700 py-3 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                <span>Google 계정으로 로그인</span>
            </button>

            <div id="login-loading" class="hidden text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <p class="text-gray-600 mt-2">로그인 중...</p>
            </div>
        </div>
    </div>

    <!-- 대시보드 화면 -->
    <div id="dashboard-screen" class="hidden min-h-screen bg-gray-50">
        <div class="flex h-screen">
            <!-- 좌측 사이드바 -->
            <aside class="w-64 bg-white shadow-lg border-r border-gray-200 flex flex-col">
                <!-- 사이드바 헤더 -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">AI 챗봇 관리</h2>
                            <p class="text-sm text-gray-500">교사 대시보드</p>
                        </div>
                    </div>
                </div>

                <!-- 내비게이션 메뉴 -->
                <nav class="flex-1 px-4 py-6">
                    <ul class="space-y-2">
                        <li>
                            <button
                                class="nav-item w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors flex items-center space-x-3 active"
                                data-section="settings">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span>기본 설정</span>
                            </button>
                        </li>
                        <li>
                            <button
                                class="nav-item w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors flex items-center space-x-3"
                                data-section="lessons">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                                <span>수업 관리</span>
                            </button>
                        </li>
                        <li>
                            <button
                                class="nav-item w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors flex items-center space-x-3"
                                data-section="prompts">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                    </path>
                                </svg>
                                <span>프롬프트 설정</span>
                            </button>
                        </li>
                        <li>
                            <button
                                class="nav-item w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors flex items-center space-x-3"
                                data-section="students">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                                <span>학생 대화 분석</span>
                            </button>
                        </li>
                    </ul>
                </nav>

                <!-- 사용자 정보 -->
                <div class="p-4 border-t border-gray-200">
                    <div class="flex items-center space-x-3 mb-3">
                        <img id="user-photo" class="w-10 h-10 rounded-full" alt="프로필">
                        <div class="flex-1 min-w-0">
                            <p id="user-name" class="text-sm font-medium text-gray-900 truncate"></p>
                            <p class="text-xs text-gray-500">교사 계정</p>
                        </div>
                    </div>
                    <button id="logout-btn"
                        class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors">
                        로그아웃
                    </button>
                </div>
            </aside>

            <!-- 메인 컨텐츠 영역 -->
            <main class="flex-1 overflow-y-auto bg-gray-50">
                <div class="p-8">

                    <!-- 기본 설정 섹션 -->
                    <div id="settings-section" class="space-y-6">
                        <!-- API 키 설정 카드 -->
                        <div class="bg-white rounded-lg shadow-sm border p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">Gemini API 키 설정</h2>
                                    <p class="text-gray-600 text-sm mt-1">학생들이 AI 튜터를 사용할 수 있도록 API 키를 등록하세요</p>
                                </div>
                                <div id="api-status" class="px-3 py-1 rounded-full text-sm font-medium hidden">
                                    <!-- API 상태가 여기에 표시됩니다 -->
                                </div>
                            </div>

                            <div id="api-setup-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Google Gemini API 키
                                    </label>
                                    <div class="flex space-x-3">
                                        <textarea id="api-key-input" placeholder="AIzaSy..." rows="2"
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                                        <button id="save-api-key-btn"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                            저장
                                        </button>
                                    </div>
                                    <div class="mt-2 flex items-center space-x-4 text-sm text-gray-600">
                                        <a href="https://aistudio.google.com/apikey" target="_blank"
                                            class="text-blue-600 hover:underline flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14">
                                                </path>
                                            </svg>
                                            <span>API 키 발급받기</span>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div id="api-configured" class="hidden">
                                <div
                                    class="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-md">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-green-700 font-medium">API 키가 성공적으로 등록되었습니다!</span>
                                    </div>
                                    <button id="update-api-key-btn"
                                        class="text-green-600 hover:text-green-800 text-sm font-medium">
                                        수정
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Gemini AI API 발급 방법 설명 카드 -->
                        <div class="bg-white rounded-lg shadow-sm border p-6">
                            <div class="mb-6">
                                <h2 class="text-lg font-semibold text-gray-800">💡 Gemini AI API 키 발급 방법</h2>
                                <p class="text-gray-600 text-sm mt-1">아래 단계를 따라 무료로 Gemini API 키를 발급받을 수 있습니다.</p>
                            </div>

                            <div class="space-y-4">
                                <ol class="list-decimal list-inside text-gray-700 space-y-3 text-sm">
                                    <li>
                                        <strong>Google AI Studio 접속:</strong>
                                        <a href="https://aistudio.google.com/apikey" target="_blank"
                                            class="text-blue-600 hover:underline font-medium">Google AI Studio</a>에 방문하여
                                        'Get API key' 버튼을 클릭합니다.
                                    </li>
                                    <li>
                                        <strong>Google 계정 로그인:</strong> 화면 안내에 따라 사용하시는 Google 계정으로 로그인합니다.
                                    </li>
                                    <li>
                                        <strong>API 키 생성:</strong> 'Create API key' 또는 'Create API key in new project'
                                        버튼을 클릭하여 새로운 API 키를 생성합니다.
                                    </li>
                                    <li>
                                        <strong>API 키 복사 및 붙여넣기:</strong> 생성된 긴 문자열의 API 키를 복사한 후, 이 페이지 상단의 'Gemini API
                                        키 설정' 입력란에 붙여넣고 '저장' 버튼을 누르면 완료됩니다.
                                    </li>
                                </ol>

                                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor"
                                                aria-hidden="true">
                                                <path fill-rule="evenodd"
                                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <p class="text-sm text-blue-700">
                                                API 키는 비밀번호와 같이 중요하므로, 다른 사람에게 노출되지 않도록 주의해주세요.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- AI 모델 선택 카드 -->
                        <div id="model-settings-section" class="bg-white rounded-lg shadow-sm border p-6 hidden">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">AI 모델 선택</h2>
                                    <p class="text-gray-600 text-sm mt-1">사용할 Google Gemini AI 모델을 선택하세요</p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        AI 모델 선택
                                    </label>
                                    <select id="model-select"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite</option>
                                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                        <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash-Lite</option>
                                    </select>
                                    <div class="mt-2 text-sm text-gray-600">
                                        <p><strong>추천:</strong> Gemini 2.0 Flash은 속도와 실시간 스트리밍, 비용 측면에서 가장 적절합니다.</p>
                                    </div>
                                    <!-- 모델별 사용량 안내 카드 -->
                                    <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center space-x-2">
                                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span>모델별 예상 사용량 및 비용 안내</span>
                                        </h4>
                                        <p class="text-gray-600 mb-4">
                                            아래 정보는 <strong>1개 학급(20명)</strong>이 <strong>1시간 동안 활발히 수업</strong>하는 상황을 가정한 <strong class="text-blue-600">무료 티어</strong> 기준 예상치입니다.
                                        </p>
                                        
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-left border-collapse">
                                                <thead>
                                                    <tr class="bg-gray-100">
                                                        <th class="border-b-2 border-gray-200 p-2 font-medium text-gray-600">모델명</th>
                                                        <th class="border-b-2 border-gray-200 p-2 font-medium text-gray-600 text-center">예상 비용</th>
                                                        <th class="border-b-2 border-gray-200 p-2 font-medium text-gray-600 text-center">분당 요청수 (RPM)</th>
                                                        <th class="border-b-2 border-gray-200 p-2 font-medium text-gray-600 text-center">분당 토큰 수 (TPM)</th>
                                                        <th class="border-b-2 border-gray-200 p-2 font-medium text-gray-600 text-center">일일 요청수 (RPD)</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="text-gray-700">
                                                    <tr class="hover:bg-gray-100">
                                                        <td class="border-b border-gray-200 p-2 font-mono text-xs">gemini-2.5-flash-lite</td>
                                                        <td class="border-b border-gray-200 p-2 text-green-600 font-semibold text-center">무료</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">15회</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">250,000</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">1,000회</td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-100">
                                                        <td class="border-b border-gray-200 p-2 font-mono text-xs">gemini-2.0-flash</td>
                                                        <td class="border-b border-gray-200 p-2 text-green-600 font-semibold text-center">무료</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">15회</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">1,000,000</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">200회</td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-100">
                                                        <td class="border-b border-gray-200 p-2 font-mono text-xs">gemini-2.0-flash-lite</td>
                                                        <td class="border-b border-gray-200 p-2 text-green-600 font-semibold text-center">무료</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">30회</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">1,000,000</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">200회</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <p class="text-gray-600 mt-4">일반적인 수업 환경에서는 무료 사용량 제한에 도달할 가능성이 낮습니다. 결제 계정을 등록한 경우 비율 제한 범위(Tier1)가 더 확대되니 더 자세한 정보는 아래 링크를 참고하세요.</p>
                                        <a href="https://ai.google.dev/gemini-api/docs/rate-limits?hl=ko" target="_blank" class="text-blue-600 hover:underline font-medium mt-2 inline-block">모델별 비율 제한에 대해 더 알아보기 &rarr;</a>
                                    </div>
                                </div>

                                <div class="flex justify-end space-x-3">
                                    <button id="save-model-btn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                        모델 저장
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- AI 모델 선택 카드 -->
                        <!-- 교사 코드 표시 카드 -->
                        <div id="teacher-code-section" class="bg-white rounded-lg shadow-sm border p-6 hidden">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">교사 코드</h2>
                                    <p class="text-gray-600 text-sm mt-1">이 코드로 학생들이 AI 튜터에 접속할 수 있습니다</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-3">
                                <div
                                    class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-md font-mono text-lg font-semibold text-center text-gray-800">
                                    <span id="teacher-code-display">-</span>
                                </div>
                                <button id="copy-code-btn"
                                    class="px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                    복사
                                </button>
                            </div>
                        </div>


                    </div>

                    <!-- 수업 관리 섹션 -->
                    <div id="lessons-section" class="hidden">
                        <div class="mb-6">
                            <h1 class="text-2xl font-bold text-gray-900">수업 관리</h1>
                            <p class="text-gray-600 mt-2">AI 튜터를 활용한 수업을 생성하고 QR코드로 학생들과 공유하세요.</p>
                        </div>

                        <!-- 새 수업 생성 카드 -->
                        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">새 수업 생성</h2>
                                    <p class="text-gray-600 text-sm mt-1">과목을 선택하고 수업 제목을 입력하여 새로운 수업을 만드세요.</p>
                                </div>
                            </div>

                            <form id="create-lesson-form" class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            수업 제목
                                        </label>
                                        <input type="text" id="lesson-title-input" placeholder="예: 분수의 나눗셈, 조선시대 문화"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            과목 선택
                                        </label>
                                        <select id="lesson-subject-select"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required>
                                            <option value="">과목을 선택하세요</option>
                                            <option value="korean">국어</option>
                                            <option value="math">수학</option>
                                            <option value="social">사회</option>
                                            <option value="science">과학</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        수업 설명 (선택사항)
                                    </label>
                                    <textarea id="lesson-description-input" rows="3"
                                        placeholder="학생들에게 전달할 수업 안내 메시지를 입력하세요."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit" id="create-lesson-btn"
                                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                        수업 생성
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- 활성 수업 목록 -->
                        <div class="bg-white rounded-lg shadow-sm border">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-lg font-semibold text-gray-800">내 수업 목록</h2>
                                    <button id="refresh-lessons-btn"
                                        class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                                        새로고침
                                    </button>
                                </div>
                            </div>

                            <div class="p-6">
                                <div id="lessons-loading" class="text-center py-8 hidden">
                                    <div
                                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                    </div>
                                    <p class="text-gray-600 mt-2">수업 목록을 불러오는 중...</p>
                                </div>

                                <div id="lessons-empty" class="text-center py-8 hidden">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                        </path>
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900">아직 생성된 수업이 없습니다</h3>
                                    <p class="mt-1 text-sm text-gray-500">위에서 새 수업을 생성해보세요.</p>
                                </div>

                                <div id="lessons-list" class="space-y-4">
                                    <!-- 수업 목록이 여기에 동적으로 추가됩니다 -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 프롬프트 설정 섹션 -->
                    <div id="prompts-section" class="hidden">
                        <div class="mb-6">
                            <h1 class="text-2xl font-bold text-gray-900">AI 튜터 프롬프트 설정</h1>
                            <p class="text-gray-600 mt-2">과목별로 학생 응답 유형에 따라 다른 AI 튜터 전략을 설정할 수 있습니다.</p>
                        </div>

                        <!-- 과목 선택 카드 -->
                        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">과목 선택</h2>
                                    <p class="text-gray-600 text-sm mt-1">먼저 설정할 과목을 선택해주세요</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4">
                                <label class="block text-sm font-medium text-gray-700">과목 선택</label>
                                <select id="prompt-subject-select"
                                    class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <option value="">과목을 선택하세요</option>
                                    <option value="korean">국어</option>
                                    <option value="math">수학</option>
                                    <option value="social">사회</option>
                                    <option value="science">과학</option>
                                </select>
                            </div>
                            <p class="text-xs text-gray-600 mt-2">선택한 과목에 맞는 학생 응답 유형별 프롬프트를 설정할 수 있습니다.</p>
                        </div>

                        <!-- 선택 안내 메시지 -->
                        <div id="no-subject-selected"
                            class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">과목을 선택해주세요</h3>
                            <p class="mt-1 text-sm text-gray-500">위에서 과목을 선택하시면 해당 과목의 AI 튜터 프롬프트 설정이 나타납니다.</p>
                        </div>

                        <!-- 유형별 프롬프트 설정 카드 -->
                        <div id="adaptive-prompt-settings-section"
                            class="bg-white rounded-lg shadow-sm border p-6 hidden">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">유형별 AI 튜터 프롬프트 설정</h2>
                                    <p class="text-gray-600 text-sm mt-1">학생 응답 유형에 따라 다른 AI 튜터 전략을 설정할 수 있습니다</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="reset-adaptive-prompts-btn"
                                        class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                                        모두 기본값으로 되돌리기
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <!-- 동적 탭 네비게이션과 컨텐츠가 여기에 생성됩니다 -->
                                <div class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                        <!-- 동적 탭 버튼들이 여기에 생성됩니다 -->
                                    </nav>
                                </div>

                                <!-- 동적 탭 컨텐츠들이 여기에 생성됩니다 -->

                                <div class="flex justify-end space-x-3 mt-6">
                                    <button id="save-adaptive-prompts-btn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                        모든 프롬프트 저장
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 학생 대화 분석 섹션 -->
                    <div id="students-section" class="hidden">
                        <div class="mb-6">
                            <h1 class="text-2xl font-bold text-gray-900">학생 대화 분석</h1>
                            <p class="text-gray-600 mt-2">학생들의 AI 튜터 대화 기록을 확인하고 분석 결과를 볼 수 있습니다.</p>
                        </div>

                        <!-- 수업 선택 -->
                        <div class="bg-white rounded-lg shadow-sm border mb-6">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-lg font-semibold text-gray-800">수업 선택</h2>
                                    <button id="refresh-lessons-for-analysis-btn"
                                        class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                                        새로고침
                                    </button>
                                </div>
                            </div>

                            <div class="p-6">
                                <div id="analysis-lessons-loading" class="text-center py-8 hidden">
                                    <div
                                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                    </div>
                                    <p class="text-gray-600 mt-2">수업 목록을 불러오는 중...</p>
                                </div>

                                <div id="analysis-lessons-empty" class="text-center py-8 hidden">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                        </path>
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900">아직 생성된 수업이 없습니다</h3>
                                    <p class="mt-1 text-sm text-gray-500">수업을 먼저 생성해주세요.</p>
                                </div>

                                <div id="analysis-lessons-list"
                                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <!-- 수업 목록이 여기에 동적으로 추가됩니다 -->
                                </div>
                            </div>
                        </div>

                        <!-- 학생 세션 목록 -->
                        <div id="lesson-students-section" class="bg-white rounded-lg shadow-sm border hidden">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 class="text-lg font-semibold text-gray-800" id="selected-lesson-title">수업명
                                        </h2>
                                        <p class="text-sm text-gray-600" id="selected-lesson-info">수업 정보</p>
                                    </div>
                                    <button id="back-to-lessons-btn"
                                        class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                                        수업 목록으로 돌아가기
                                    </button>
                                </div>
                            </div>

                            <div class="p-6">
                                <div id="lesson-students-loading" class="text-center py-8 hidden">
                                    <div
                                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                    </div>
                                    <p class="text-gray-600 mt-2">학생 목록을 불러오는 중...</p>
                                </div>

                                <div id="lesson-students-empty" class="text-center py-8 hidden">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                        </path>
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900">이 수업에 참여한 학생이 없습니다</h3>
                                    <p class="mt-1 text-sm text-gray-500">학생들이 AI 튜터를 사용하면 여기에 표시됩니다.</p>
                                </div>

                                <div id="lesson-students-list" class="space-y-3">
                                    <!-- 학생 세션 목록이 여기에 동적으로 추가됩니다 -->
                                </div>
                            </div>
                        </div>

                        <!-- 선택된 학생의 대화 상세 -->
                        <div id="conversation-detail" class="hidden mt-6">
                            <div class="bg-white rounded-lg shadow-sm border">
                                <div class="p-6 border-b border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h2 class="text-lg font-semibold text-gray-800" id="selected-student-name">
                                                학생 대화 내용</h2>
                                            <p class="text-sm text-gray-600" id="selected-session-info">세션 정보</p>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <button id="analyze-conversation-btn"
                                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">
                                                AI 분석 생성
                                            </button>
                                            <button id="close-conversation-btn"
                                                class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                                닫기
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-6 space-y-8">
                                    <!-- 대화 기록 -->
                                    <div>
                                        <h3 class="text-md font-semibold text-gray-800 mb-4">대화 기록</h3>
                                        <div id="conversation-messages"
                                            class="max-h-96 overflow-y-auto bg-gray-50 rounded-lg p-4 space-y-3">
                                            <!-- 대화 메시지들이 여기에 표시됩니다 -->
                                        </div>
                                    </div>

                                    <!-- AI 분석 결과 -->
                                    <div>
                                        <div class="flex items-center justify-between mb-4">
                                            <h3 class="text-md font-semibold text-gray-800">AI 분석 결과</h3>
                                            <div class="flex items-center space-x-2" id="analysis-actions"
                                                style="display: none;">
                                                <button id="copy-analysis-btn"
                                                    class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                                        </path>
                                                    </svg>
                                                    <span>복사</span>
                                                </button>
                                                <button id="download-analysis-btn"
                                                    class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded-md hover:bg-green-200 font-medium flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                                        </path>
                                                    </svg>
                                                    <span>CSV 다운로드</span>
                                                </button>
                                            </div>
                                        </div>

                                        <div id="analysis-content"
                                            class="bg-gray-50 rounded-lg p-4 min-h-32 whitespace-pre-wrap">
                                            <p class="text-gray-600 italic">분석을 생성하려면 'AI 분석 생성' 버튼을 클릭하세요.</p>
                                        </div>

                                        <div id="analysis-loading"
                                            class="hidden bg-gray-50 rounded-lg p-4 min-h-32 flex items-center justify-center">
                                            <div class="text-center">
                                                <div
                                                    class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                                </div>
                                                <p class="text-gray-600 mt-2">AI가 대화를 분석하고 있습니다...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 상태 메시지 -->
                    <div id="status-message" class="mt-6 p-4 rounded-md hidden">
                        <!-- 상태 메시지가 여기에 표시됩니다 -->
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            import {
                signInWithPopup,
                GoogleAuthProvider,
                signOut,
                onAuthStateChanged
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
            import { httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
            import { auth, functions } from './firebase-config.js';

            // Firebase Functions
            const updateTeacherApiKey = httpsCallable(functions, 'updateTeacherApiKey');
            const getTeacherSettings = httpsCallable(functions, 'getTeacherSettings');
            const updateTeacherModel = httpsCallable(functions, 'updateTeacherModel');
            const updateTeacherPrompts = httpsCallable(functions, 'updateTeacherPrompts');
            const getSubjectResponseTypes = httpsCallable(functions, 'getSubjectResponseTypes');
            const createLesson = httpsCallable(functions, 'createLesson');
            const getLessons = httpsCallable(functions, 'getLessons');
            const getStudentSessions = httpsCallable(functions, 'getStudentSessions');
            const getStudentConversation = httpsCallable(functions, 'getStudentConversation');
            const analyzeStudentConversations = httpsCallable(functions, 'analyzeStudentConversations');

            // DOM 요소들
            const loginScreen = document.getElementById('login-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const loginLoading = document.getElementById('login-loading');
            const logoutBtn = document.getElementById('logout-btn');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');

            const apiSetupForm = document.getElementById('api-setup-form');
            const apiConfigured = document.getElementById('api-configured');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const updateApiKeyBtn = document.getElementById('update-api-key-btn');
            const apiStatus = document.getElementById('api-status');

            const teacherCodeSection = document.getElementById('teacher-code-section');
            const teacherCodeDisplay = document.getElementById('teacher-code-display');
            const copyCodeBtn = document.getElementById('copy-code-btn');
            const statusMessage = document.getElementById('status-message');

            // 새로운 설정 요소들
            const modelSettingsSection = document.getElementById('model-settings-section');
            const modelSelect = document.getElementById('model-select');
            const saveModelBtn = document.getElementById('save-model-btn');

            const adaptivePromptSettingsSection = document.getElementById('adaptive-prompt-settings-section');
            const saveAdaptivePromptsBtn = document.getElementById('save-adaptive-prompts-btn');
            const resetAdaptivePromptsBtn = document.getElementById('reset-adaptive-prompts-btn');

            // 탭 버튼들
            const promptTabBtns = document.querySelectorAll('.prompt-tab-btn');
            const promptTabContents = document.querySelectorAll('.prompt-tab-content');

            // 전역 변수들
            let currentSettings = null;
            let currentTab = 'DEFAULT';
            let currentSubjectResponseTypes = null;
            let currentSelectedSubject = '';

            // 프롬프트 설정 관련 요소들
            const promptSubjectSelect = document.getElementById('prompt-subject-select');

            // 과목 선택 이벤트 핸들러
            promptSubjectSelect.addEventListener('change', async (e) => {
                const selectedSubject = e.target.value;
                if (selectedSubject) {
                    // 선택 안내 메시지 숨김
                    document.getElementById('no-subject-selected').classList.add('hidden');
                    // 프롬프트 설정 카드 표시
                    adaptivePromptSettingsSection.classList.remove('hidden');

                    await loadSubjectResponseTypes(selectedSubject);
                } else {
                    // 과목 선택 해제 시 기본 상태로 돌아감
                    document.getElementById('no-subject-selected').classList.remove('hidden');
                    adaptivePromptSettingsSection.classList.add('hidden');
                    clearPromptTabs();
                }
            });

            // 과목 이름 매핑
            const subjectNames = {
                'korean': '국어',
                'math': '수학',
                'science': '과학',
                'social': '사회'
            };

            // 과목별 응답 유형 로드 및 탭 생성
            async function loadSubjectResponseTypes(subject) {
                try {
                    showStatus('과목별 응답 유형을 불러오는 중...', 'info', 2000);

                    const result = await getSubjectResponseTypes({ subject });
                    console.log('받은 응답 유형 데이터:', result.data);

                    // responseTypes 처리 - 객체인 경우 배열로 변환
                    let responseTypes = result.data.responseTypes;

                    if (!responseTypes) {
                        console.error('responseTypes가 존재하지 않습니다:', result.data);
                        showStatus('과목별 응답 유형 데이터가 존재하지 않습니다.', 'error');
                        clearPromptTabs();
                        return;
                    }

                    // responseTypes가 객체인 경우 배열로 변환
                    if (!Array.isArray(responseTypes) && typeof responseTypes === 'object') {
                        console.log('responseTypes가 객체 형태입니다. 배열로 변환합니다:', responseTypes);
                        responseTypes = Object.keys(responseTypes).map(key => {
                            const responseType = responseTypes[key];
                            return {
                                id: key,
                                name: responseType.name || key,
                                description: responseType.description || '',
                                examples: responseType.examples || []
                            };
                        });
                        console.log('변환된 responseTypes 배열:', responseTypes);
                    }

                    // 배열이 아닌 경우 에러
                    if (!Array.isArray(responseTypes)) {
                        console.error('responseTypes를 배열로 변환할 수 없습니다:', responseTypes);
                        showStatus('과목별 응답 유형 데이터 형식이 올바르지 않습니다.', 'error');
                        clearPromptTabs();
                        return;
                    }

                    // 빈 배열 체크
                    if (responseTypes.length === 0) {
                        console.warn('responseTypes가 빈 배열입니다.');
                        showStatus('해당 과목에 대한 응답 유형이 없습니다.', 'error');
                        clearPromptTabs();
                        return;
                    }

                    currentSubjectResponseTypes = responseTypes;
                    currentSelectedSubject = subject;

                    // 동적으로 탭 생성
                    generateDynamicTabs(currentSubjectResponseTypes);

                    // 생성된 탭들에 기존 프롬프트 데이터 로드
                    // 과목별 기본 프롬프트는 result.data.defaultPrompts에서 제공됨
                    const subjectDefaultPrompts = result.data.defaultPrompts || {};
                    console.log('과목별 기본 프롬프트:', subjectDefaultPrompts);

                    // 커스텀 프롬프트는 현재 과목에 맞게 필터링하여 사용
                    const allCustomPrompts = currentSettings ? currentSettings.customPrompts || {} : {};
                    // 현재 과목에 맞는 커스텀 프롬프트가 있는지 확인
                    const customPrompts = allCustomPrompts[subject] || {};
                    console.log('현재 과목의 커스텀 프롬프트:', customPrompts);

                    loadPromptTabs(customPrompts, subjectDefaultPrompts);

                    // 첫 번째 탭으로 전환
                    if (currentSubjectResponseTypes.length > 0) {
                        const firstTabId = currentSubjectResponseTypes[0].id;
                        switchTab(firstTabId);
                    }

                    const subjectDisplayName = subjectNames[subject] || subject;
                    showStatus(`${subjectDisplayName} 과목의 응답 유형이 로드되었습니다.`, 'success', 2000);

                } catch (error) {
                    console.error('과목별 응답 유형 로드 실패:', error);
                    showStatus('과목별 응답 유형을 불러오는데 실패했습니다.', 'error');
                    clearPromptTabs();
                }
            }

            // 동적 탭 생성
            function generateDynamicTabs(responseTypes) {
                // responseTypes 매개변수 검증
                if (!Array.isArray(responseTypes)) {
                    console.error('generateDynamicTabs: responseTypes가 배열이 아닙니다:', responseTypes);
                    return;
                }

                if (responseTypes.length === 0) {
                    console.warn('generateDynamicTabs: responseTypes가 빈 배열입니다.');
                    return;
                }

                const tabNavContainer = document.querySelector('[aria-label="Tabs"]');
                if (!tabNavContainer) {
                    console.error('generateDynamicTabs: 탭 네비게이션 컨테이너를 찾을 수 없습니다.');
                    return;
                }

                const tabContentContainer = tabNavContainer.parentElement?.parentElement;
                if (!tabContentContainer) {
                    console.error('generateDynamicTabs: 탭 컨텐츠 컨테이너를 찾을 수 없습니다.');
                    return;
                }

                // 기존 탭 제거
                tabNavContainer.innerHTML = '';

                // 기존 탭 컨텐츠 제거 (첫 번째 탭 네비게이션과 저장 버튼 제외)
                const existingContents = tabContentContainer.querySelectorAll('.prompt-tab-content');
                existingContents.forEach(content => content.remove());

                let isFirstTab = true;
                responseTypes.forEach(responseType => {
                    // responseType 객체 검증
                    if (!responseType || typeof responseType !== 'object') {
                        console.warn('generateDynamicTabs: 잘못된 responseType:', responseType);
                        return;
                    }

                    if (!responseType.id || !responseType.name) {
                        console.warn('generateDynamicTabs: responseType에 필수 필드가 없습니다:', responseType);
                        return;
                    }
                    // 탭 버튼 생성
                    const tabButton = document.createElement('button');
                    tabButton.className = isFirstTab
                        ? 'prompt-tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm'
                        : 'prompt-tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm';
                    tabButton.setAttribute('data-tab', responseType.id);
                    tabButton.textContent = responseType.name;

                    tabButton.addEventListener('click', () => {
                        switchTab(responseType.id);
                    });

                    tabNavContainer.appendChild(tabButton);

                    // 탭 컨텐츠 생성
                    const tabContent = document.createElement('div');
                    tabContent.className = isFirstTab ? 'prompt-tab-content' : 'prompt-tab-content hidden';
                    tabContent.setAttribute('data-tab', responseType.id);

                    tabContent.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-md font-semibold text-gray-800 mb-2">${responseType.name} 프롬프트</h3>
                        <p class="text-sm text-gray-600 mb-3">${responseType.description}</p>
                        ${responseType.examples && responseType.examples.length > 0 ? `
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-3">
                                <p class="text-xs font-medium text-blue-800 mb-2">다른 예시 프롬프트들:</p>
                                <div class="text-xs text-blue-700">
                                    ${responseType.examples.slice(1).map((example, idx) => `<p class="mb-1">• ${example}</p>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <textarea id="prompt-${responseType.id}" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y" placeholder="${responseType.name}에 대한 프롬프트를 입력하세요..."></textarea>
                `;

                    // 저장 버튼 앞에 삽입
                    const saveButtonContainer = tabContentContainer.querySelector('.flex.justify-end');
                    tabContentContainer.insertBefore(tabContent, saveButtonContainer);

                    isFirstTab = false;
                });

                // 전역 탭 요소 참조 업데이트
                window.promptTabBtns = document.querySelectorAll('.prompt-tab-btn');
                window.promptTabContents = document.querySelectorAll('.prompt-tab-content');
            }

            // 탭 초기화
            function clearPromptTabs() {
                const tabNavContainer = document.querySelector('[aria-label="Tabs"]');
                const tabContentContainer = tabNavContainer.parentElement.parentElement;

                // 탭 네비게이션 초기화
                tabNavContainer.innerHTML = '<p class="text-sm text-gray-500">과목을 선택하면 해당 과목의 응답 유형별 프롬프트를 설정할 수 있습니다.</p>';

                // 탭 컨텐츠 제거
                const existingContents = tabContentContainer.querySelectorAll('.prompt-tab-content');
                existingContents.forEach(content => content.remove());

                currentSubjectResponseTypes = null;
                currentSelectedSubject = '';
                currentTab = null;
            }

            // Google 로그인
            googleLoginBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    loginLoading.classList.remove('hidden');
                    googleLoginBtn.classList.add('hidden');

                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('로그인 실패:', error);
                    showStatus('로그인에 실패했습니다. 다시 시도해주세요.', 'error');

                    loginLoading.classList.add('hidden');
                    googleLoginBtn.classList.remove('hidden');
                }
            });

            // 로그아웃
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error('로그아웃 실패:', error);
                }
            });

            // API 키 저장
            saveApiKeyBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showStatus('API 키를 입력해주세요.', 'error');
                    return;
                }

                try {
                    saveApiKeyBtn.textContent = '저장 중...';
                    saveApiKeyBtn.disabled = true;

                    await updateTeacherApiKey({ apiKey });

                    showStatus('API 키가 성공적으로 저장되었습니다!', 'success');
                    await loadTeacherInfo();

                } catch (error) {
                    console.error('API 키 저장 실패:', error);
                    showStatus(`저장 실패: ${error.message}`, 'error');
                } finally {
                    saveApiKeyBtn.textContent = '저장';
                    saveApiKeyBtn.disabled = false;
                }
            });

            // API 키 수정
            updateApiKeyBtn.addEventListener('click', () => {
                apiConfigured.classList.add('hidden');
                apiSetupForm.classList.remove('hidden');
                teacherCodeSection.classList.add('hidden');
            });

            // 교사 코드 복사
            copyCodeBtn.addEventListener('click', async () => {
                const code = teacherCodeDisplay.textContent;
                try {
                    await navigator.clipboard.writeText(code);
                    showStatus('교사 코드가 클립보드에 복사되었습니다!', 'success');
                } catch (error) {
                    // 클립보드 API가 지원되지 않는 경우
                    const textArea = document.createElement('textarea');
                    textArea.value = code;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showStatus('교사 코드가 클립보드에 복사되었습니다!', 'success');
                }
            });

            // 이전 버전 프롬프트 저장 기능 삭제됨

            // 이전 버전 프롬프트 미리보기 및 초기화 기능 삭제됨

            // 인증 상태 변경 감지
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // 로그인됨
                    loginScreen.classList.add('hidden');
                    dashboardScreen.classList.remove('hidden');

                    // 사용자 정보 표시
                    userPhoto.src = user.photoURL || 'https://via.placeholder.com/32';
                    userName.textContent = user.displayName || user.email;

                    // 교사 정보 로드
                    await loadTeacherInfo();

                } else {
                    // 로그아웃됨
                    loginScreen.classList.remove('hidden');
                    dashboardScreen.classList.add('hidden');
                    loginLoading.classList.add('hidden');
                    googleLoginBtn.classList.remove('hidden');
                }
            });

            // 교사 설정 로드
            async function loadTeacherInfo() {
                try {
                    const result = await getTeacherSettings();
                    const data = result.data;
                    currentSettings = data;
                    console.log('교사 설정 로드:', data);

                    if (data.hasApiKey) {
                        // API 키가 등록됨
                        apiSetupForm.classList.add('hidden');
                        apiConfigured.classList.remove('hidden');
                        teacherCodeSection.classList.remove('hidden');
                        modelSettingsSection.classList.remove('hidden');

                        // 선택 안내 메시지를 보이도록 설정
                        document.getElementById('no-subject-selected').classList.remove('hidden');
                        // 과목이 선택되기 전까지는 프롬프트 탭 컨테이너 숨김
                        adaptivePromptSettingsSection.classList.add('hidden');

                        teacherCodeDisplay.textContent = data.teacherCode;

                        // 모델 선택 박스 설정
                        modelSelect.value = data.modelName || 'gemini-2.0-flash-exp';

                        // 과목이 선택되지 않은 상태에서는 프롬프트 탭을 초기화
                        clearPromptTabs();

                        apiStatus.textContent = 'API 연결됨';
                        apiStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700';
                        apiStatus.classList.remove('hidden');

                    } else {
                        // API 키 미등록
                        apiSetupForm.classList.remove('hidden');
                        apiConfigured.classList.add('hidden');
                        teacherCodeSection.classList.add('hidden');
                        modelSettingsSection.classList.add('hidden');
                        adaptivePromptSettingsSection.classList.add('hidden');

                        apiStatus.textContent = 'API 미설정';
                        apiStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-700';
                        apiStatus.classList.remove('hidden');
                    }

                } catch (error) {
                    console.error('교사 정보 로드 실패:', error);
                    showStatus('정보를 불러오는데 실패했습니다.', 'error');
                }
            }

            // 탭 버튼 이벤트 리스너
            promptTabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                });
            });

            // 탭 전환 - 동적으로 생성된 탭들을 위해 실시간으로 요소를 찾아서 처리
            function switchTab(tabId) {
                currentTab = tabId;

                // 현재 DOM에서 탭 버튼들을 다시 조회
                const currentTabBtns = document.querySelectorAll('.prompt-tab-btn');
                const currentTabContents = document.querySelectorAll('.prompt-tab-content');

                // 탭 버튼 스타일 업데이트
                currentTabBtns.forEach(btn => {
                    if (btn.dataset.tab === tabId) {
                        btn.className = 'prompt-tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm';
                    } else {
                        btn.className = 'prompt-tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm';
                    }
                });

                // 탭 컨텐트 보이기/숨기기
                currentTabContents.forEach(content => {
                    if (content.dataset.tab === tabId) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            }

            // 프롬프트 탭 로드 - 동적 탭과 기본 탭 모두 지원
            function loadPromptTabs(customPrompts = {}, defaultPrompts = {}) {
                // 전체 textarea 요소들을 찾아서 처리
                const allTextareas = document.querySelectorAll('textarea[id^="prompt-"]');

                allTextareas.forEach(textarea => {
                    const promptId = textarea.id.replace('prompt-', '');
                    const customPrompt = customPrompts[promptId];
                    const defaultPrompt = defaultPrompts[promptId];

                    // 커스텀 프롬프트가 있으면 사용, 없으면 기본 프롬프트 사용
                    textarea.value = customPrompt || defaultPrompt || '';
                });
            }

            // AI 모델 저장
            saveModelBtn.addEventListener('click', async () => {
                const selectedModel = modelSelect.value;
                if (!selectedModel) {
                    showStatus('모델을 선택해주세요.', 'error');
                    return;
                }

                try {
                    saveModelBtn.textContent = '저장 중...';
                    saveModelBtn.disabled = true;

                    await updateTeacherModel({ modelName: selectedModel });

                    showStatus(`AI 모델이 ${selectedModel}로 업데이트되었습니다!`, 'success');

                } catch (error) {
                    console.error('모델 저장 실패:', error);
                    showStatus(`저장 실패: ${error.message}`, 'error');
                } finally {
                    saveModelBtn.textContent = '모델 저장';
                    saveModelBtn.disabled = false;
                }
            });

            // 유형별 프롬프트 저장
            saveAdaptivePromptsBtn.addEventListener('click', async () => {
                // 동적 응답 유형 또는 기본 유형 사용
                let promptTypes;
                if (currentSubjectResponseTypes && currentSubjectResponseTypes.length > 0) {
                    promptTypes = currentSubjectResponseTypes.map(rt => rt.id);
                } else {
                    // 기본 타입들 (과목 선택이 안 된 경우)
                    promptTypes = ['DEFAULT', 'CONCEPT_QUESTION', 'EXPLORATION_DEADLOCK', 'FAILURE_REPORT', 'SUCCESS_WITHOUT_PRINCIPLE', 'HYPOTHESIS_INQUIRY'];
                }

                const prompts = {};

                // 모든 프롬프트 수집
                for (const type of promptTypes) {
                    const textarea = document.getElementById(`prompt-${type}`);
                    if (textarea && textarea.value.trim()) {
                        prompts[type] = textarea.value.trim();
                    }
                }

                // 과목이 선택되지 않았다면 경고
                if (!currentSelectedSubject) {
                    showStatus('과목을 먼저 선택해주세요.', 'error');
                    return;
                }

                try {
                    saveAdaptivePromptsBtn.textContent = '저장 중...';
                    saveAdaptivePromptsBtn.disabled = true;

                    await updateTeacherPrompts({ prompts, subject: currentSelectedSubject });

                    const subjectDisplayName = subjectNames[currentSelectedSubject] || currentSelectedSubject;
                    showStatus(`${subjectDisplayName} 과목의 모든 프롬프트가 성공적으로 저장되었습니다!`, 'success');

                } catch (error) {
                    console.error('유형별 프롬프트 저장 실패:', error);
                    showStatus(`저장 실패: ${error.message}`, 'error');
                } finally {
                    saveAdaptivePromptsBtn.textContent = '모든 프롬프트 저장';
                    saveAdaptivePromptsBtn.disabled = false;
                }
            });

            // 유형별 프롬프트 초기화
            resetAdaptivePromptsBtn.addEventListener('click', () => {
                if (!confirm('모든 프롬프트를 기본값으로 되돌리시겠습니까?')) {
                    return;
                }

                if (!currentSelectedSubject) {
                    showStatus('과목을 먼저 선택해주세요.', 'error');
                    return;
                }

                // 동적 응답 유형에 따른 기본값 설정
                if (currentSubjectResponseTypes && currentSubjectResponseTypes.length > 0) {
                    currentSubjectResponseTypes.forEach(rt => {
                        const textarea = document.getElementById(`prompt-${rt.id}`);
                        if (textarea) {
                            textarea.value = ''; // 또는 기본 프롬프트가 있다면 설정
                        }
                    });
                    const subjectDisplayName = subjectNames[currentSelectedSubject] || currentSelectedSubject;
                    showStatus(`${subjectDisplayName} 과목의 모든 프롬프트가 기본값으로 되돌렸습니다.`, 'info');
                } else if (currentSettings && currentSettings.defaultPrompts) {
                    // 기본 유형들 사용
                    const promptTypes = ['DEFAULT', 'CONCEPT_QUESTION', 'EXPLORATION_DEADLOCK', 'FAILURE_REPORT', 'SUCCESS_WITHOUT_PRINCIPLE', 'HYPOTHESIS_INQUIRY'];
                    promptTypes.forEach(type => {
                        const textarea = document.getElementById(`prompt-${type}`);
                        if (textarea) {
                            textarea.value = currentSettings.defaultPrompts[type] || '';
                        }
                    });
                    showStatus('모든 프롬프트가 기본값으로 되돌렸습니다.', 'info');
                }
            });

            // 상태 메시지 표시
            function showStatus(message, type, duration = 5000) {
                statusMessage.textContent = message;
                statusMessage.className = `mt-6 p-4 rounded-md ${getStatusClasses(type)}`;
                statusMessage.classList.remove('hidden');

                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, duration);
            }

            function getStatusClasses(type) {
                switch (type) {
                    case 'success':
                        return 'bg-green-100 text-green-800 border border-green-300';
                    case 'error':
                        return 'bg-red-100 text-red-800 border border-red-300';
                    case 'info':
                        return 'bg-blue-100 text-blue-800 border border-blue-300';
                    default:
                        return 'bg-gray-100 text-gray-800 border border-gray-300';
                }
            }

            // === SPA 네비게이션 기능 ===

            // 네비게이션 요소들
            const navItems = document.querySelectorAll('.nav-item');
            const settingsSection = document.getElementById('settings-section');
            const lessonsSection = document.getElementById('lessons-section');
            const promptsSection = document.getElementById('prompts-section');
            const studentsSection = document.getElementById('students-section');

            // 현재 활성 섹션
            let currentSection = 'settings';

            // 네비게이션 클릭 이벤트
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    switchSection(section);
                });
            });

            // 섹션 전환 함수
            function switchSection(sectionName) {
                currentSection = sectionName;

                // 네비게이션 버튼 활성화 상태 업데이트
                navItems.forEach(item => {
                    if (item.dataset.section === sectionName) {
                        item.classList.add('active');
                        item.classList.add('bg-blue-50', 'text-blue-600');
                    } else {
                        item.classList.remove('active');
                        item.classList.remove('bg-blue-50', 'text-blue-600');
                    }
                });

                // 섹션 보이기/숨기기
                settingsSection.classList.add('hidden');
                lessonsSection.classList.add('hidden');
                promptsSection.classList.add('hidden');
                studentsSection.classList.add('hidden');

                switch (sectionName) {
                    case 'settings':
                        settingsSection.classList.remove('hidden');
                        break;
                    case 'lessons':
                        lessonsSection.classList.remove('hidden');
                        if (currentSettings && currentSettings.hasApiKey) {
                            loadLessons();
                        }
                        break;
                    case 'prompts':
                        promptsSection.classList.remove('hidden');
                        // 프롬프트 섹션에서 adaptivePromptSettingsSection을 표시
                        if (currentSettings && currentSettings.hasApiKey) {
                            adaptivePromptSettingsSection.classList.remove('hidden');
                        }
                        break;
                    case 'students':
                        studentsSection.classList.remove('hidden');
                        if (currentSettings && currentSettings.hasApiKey) {
                            loadLessonsForAnalysis();
                        }
                        break;
                }
            }

            // === 학생 분석 기능 ===

            // 학생 분석 관련 요소들 - 기존 세션 기반
            const refreshSessionsBtn = document.getElementById('refresh-sessions-btn');
            const sessionsLoading = document.getElementById('sessions-loading');
            const sessionsEmpty = document.getElementById('sessions-empty');
            const sessionsList = document.getElementById('sessions-list');

            // 수업별 분석 관련 요소들 - 새로운 UI
            const refreshLessonsForAnalysisBtn = document.getElementById('refresh-lessons-for-analysis-btn');
            const analysisLessonsLoading = document.getElementById('analysis-lessons-loading');
            const analysisLessonsEmpty = document.getElementById('analysis-lessons-empty');
            const analysisLessonsList = document.getElementById('analysis-lessons-list');
            const lessonStudentsSection = document.getElementById('lesson-students-section');
            const selectedLessonTitle = document.getElementById('selected-lesson-title');
            const selectedLessonInfo = document.getElementById('selected-lesson-info');
            const backToLessonsBtn = document.getElementById('back-to-lessons-btn');
            const lessonStudentsLoading = document.getElementById('lesson-students-loading');
            const lessonStudentsEmpty = document.getElementById('lesson-students-empty');
            const lessonStudentsList = document.getElementById('lesson-students-list');
            const conversationDetail = document.getElementById('conversation-detail');
            const selectedStudentName = document.getElementById('selected-student-name');
            // const selectedSessionInfo = document.getElementById('selected-session-info');
            const conversationMessages = document.getElementById('conversation-messages');
            const analysisContent = document.getElementById('analysis-content');
            const analysisLoading = document.getElementById('analysis-loading');
            const analyzeConversationBtn = document.getElementById('analyze-conversation-btn');
            const closeConversationBtn = document.getElementById('close-conversation-btn');

            // 현재 선택된 세션 정보
            let currentSelectedSession = null;

            // 새로고침 버튼 이벤트
            if (refreshSessionsBtn) {
                refreshSessionsBtn.addEventListener('click', () => {
                    loadStudentSessions();
                });
            }

            // 수업별 분석 새로고침 버튼 이벤트
            refreshLessonsForAnalysisBtn.addEventListener('click', () => {
                loadLessonsForAnalysis();
            });

            // 수업 목록으로 돌아가기 버튼 이벤트
            backToLessonsBtn.addEventListener('click', () => {
                lessonStudentsSection.classList.add('hidden');
                conversationDetail.classList.add('hidden');
                currentSelectedSession = null;
                // 수업 선택 카드 다시 표시
                document.querySelector('.bg-white.rounded-lg.shadow-sm.border.mb-6').classList.remove('hidden');
            });

            // 대화 닫기 버튼 이벤트
            closeConversationBtn.addEventListener('click', () => {
                conversationDetail.classList.add('hidden');
                currentSelectedSession = null;
            });

            // 분석 결과 복사/다운로드 버튼
            const copyAnalysisBtn = document.getElementById('copy-analysis-btn');
            const downloadAnalysisBtn = document.getElementById('download-analysis-btn');
            const analysisActions = document.getElementById('analysis-actions');

            // 전역 변수로 분석 데이터 저장
            let currentAnalysisData = null;

            // AI 분석 생성 버튼 이벤트
            analyzeConversationBtn.addEventListener('click', async () => {
                if (!currentSelectedSession) return;

                try {
                    analysisContent.classList.add('hidden');
                    analysisLoading.classList.remove('hidden');
                    analyzeConversationBtn.disabled = true;
                    analysisActions.style.display = 'none';

                    const result = await analyzeStudentConversations({
                        sessionId: currentSelectedSession.sessionId
                    });

                    // 분석 데이터 저장 (기존 분석인지 확인)
                    const generatedTime = result.data.isExistingAnalysis && result.data.generatedAt
                        ? new Date(result.data.generatedAt).toLocaleString('ko-KR')
                        : new Date().toLocaleString('ko-KR');

                    currentAnalysisData = {
                        analysis: result.data.analysis,
                        sessionInfo: result.data.sessionInfo,
                        generatedAt: generatedTime,
                        isExistingAnalysis: result.data.isExistingAnalysis || false
                    };

                    // 분석 결과 표시 (마크다운 없이 순수 텍스트로)
                    analysisContent.textContent = result.data.analysis;

                    // 기존 분석인 경우 사용자에게 알림
                    if (result.data.isExistingAnalysis) {
                        showStatus(`기존 분석 결과를 불러왔습니다. (생성일시: ${generatedTime})`, 'info');
                    } else {
                        showStatus('새로운 AI 분석이 생성되었습니다!', 'success');
                    }

                    analysisLoading.classList.add('hidden');
                    analysisContent.classList.remove('hidden');
                    analysisActions.style.display = 'flex';

                } catch (error) {
                    console.error('분석 생성 실패:', error);
                    showStatus(`분석 생성 실패: ${error.message}`, 'error');

                    analysisLoading.classList.add('hidden');
                    analysisContent.classList.remove('hidden');
                } finally {
                    analyzeConversationBtn.disabled = false;
                }
            });

            // 분석 결과 복사 버튼 이벤트
            copyAnalysisBtn.addEventListener('click', async () => {
                if (!currentAnalysisData) {
                    showStatus('복사할 분석 결과가 없습니다.', 'error');
                    return;
                }

                try {
                    const textToCopy = `${currentAnalysisData.sessionInfo.studentName} 학생 영재성 평가 분석 (생성시각: ${currentAnalysisData.generatedAt})\n\n${currentAnalysisData.analysis}`;

                    await navigator.clipboard.writeText(textToCopy);
                    showStatus('분석 결과가 클립보드에 복사되었습니다!', 'success');
                } catch (error) {
                    // 클립보드 API가 지원되지 않는 경우
                    const textArea = document.createElement('textarea');
                    textArea.value = `${currentAnalysisData.sessionInfo.studentName} 학생 영재성 평가 분석 (생성시각: ${currentAnalysisData.generatedAt})\n\n${currentAnalysisData.analysis}`;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showStatus('분석 결과가 클립보드에 복사되었습니다!', 'success');
                }
            });

            // CSV 다운로드 버튼 이벤트
            downloadAnalysisBtn.addEventListener('click', () => {
                if (!currentAnalysisData) {
                    showStatus('다운로드할 분석 결과가 없습니다.', 'error');
                    return;
                }

                try {
                    // CSV 형식으로 데이터 변환
                    const csvData = convertAnalysisToCSV(currentAnalysisData);

                    // Blob 생성 및 다운로드
                    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);

                    link.setAttribute('href', url);
                    link.setAttribute('download', `${currentAnalysisData.sessionInfo.studentName}_영재성평가_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showStatus('CSV 파일이 다운로드되었습니다!', 'success');

                } catch (error) {
                    console.error('CSV 다운로드 오류:', error);
                    showStatus('CSV 다운로드 중 오류가 발생했습니다.', 'error');
                }
            });

            // 분석 결과를 CSV 형식으로 변환하는 함수
            function convertAnalysisToCSV(analysisData) {
                const { analysis, sessionInfo, generatedAt } = analysisData;

                // CSV 헤더
                const headers = [
                    '학생명',
                    '세션ID',
                    '대화횟수',
                    '응답유형',
                    '분석생성시각',
                    '분석내용'
                ];

                // CSV 데이터 행
                const row = [
                    escapeCSVValue(sessionInfo.studentName),
                    escapeCSVValue(sessionInfo.sessionId),
                    sessionInfo.conversationCount,
                    escapeCSVValue(sessionInfo.responseTypes.join(', ')),
                    escapeCSVValue(generatedAt),
                    escapeCSVValue(analysis)
                ];

                // CSV 문자열 생성
                const csvContent = [headers.join(','), row.join(',')].join('\n');

                // BOM 추가로 한글 깨짐 방지
                return '\uFEFF' + csvContent;
            }

            // CSV 값 이스케이프 함수
            function escapeCSVValue(value) {
                if (value === null || value === undefined) {
                    return '';
                }

                const stringValue = String(value);

                // 콤마, 따옴표, 줄바꿈이 포함된 경우 따옴표로 감싸고 내부 따옴표를 이스케이프
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }

                return stringValue;
            }

            // 학생 세션 목록 로드
            async function loadStudentSessions() {
                try {
                    sessionsLoading.classList.remove('hidden');
                    sessionsEmpty.classList.add('hidden');
                    sessionsList.innerHTML = '';

                    const result = await getStudentSessions();
                    const sessions = result.data.sessions || [];

                    sessionsLoading.classList.add('hidden');

                    if (sessions.length === 0) {
                        sessionsEmpty.classList.remove('hidden');
                        return;
                    }

                    // 세션 목록 렌더링
                    sessions.forEach(session => {
                        const sessionElement = createSessionElement(session);
                        sessionsList.appendChild(sessionElement);
                    });

                } catch (error) {
                    console.error('세션 목록 로드 실패:', error);
                    showStatus('학생 세션 목록을 불러오는데 실패했습니다.', 'error');
                    sessionsLoading.classList.add('hidden');
                    sessionsEmpty.classList.remove('hidden');
                }
            }

            // 세션 요소 생성
            function createSessionElement(session) {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors';

                // 날짜 처리 개선
                let lastActive = '시간 정보 없음';
                if (session.lastActive) {
                    try {
                        const date = new Date(session.lastActive);
                        if (!isNaN(date.getTime())) {
                            lastActive = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('날짜 파싱 오류:', error);
                    }
                }

                const messageCount = session.messageCount || 0;

                div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900">${session.studentName}</h4>
                        <p class="text-sm text-gray-500">대화 메시지 수: ${messageCount}개</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `;

                // 클릭 이벤트 추가
                div.addEventListener('click', () => {
                    loadStudentConversation(session);
                });

                return div;
            }

            // 학생 대화 상세 로드
            async function loadStudentConversation(session) {
                try {
                    currentSelectedSession = session;

                    // 세션 정보 표시
                    selectedStudentName.textContent = `${session.studentName}의 대화`;

                    // 날짜 처리 개선
                    let lastActiveText = '시간 정보 없음';
                    if (session.lastActive) {
                        try {
                            const date = new Date(session.lastActive);
                            if (!isNaN(date.getTime())) {
                                lastActiveText = date.toLocaleString('ko-KR');
                            }
                        } catch (error) {
                            console.log('날짜 파싱 오류:', error);
                        }
                    }

                    // selectedSessionInfo.textContent = `마지막 활동: ${lastActiveText}`;

                    // 대화 내용 로드 중 표시
                    conversationMessages.innerHTML = '<p class="text-gray-600 text-center py-4">대화 내용을 불러오는 중...</p>';
                    analysisContent.innerHTML = '<p class="text-gray-600 italic">분석을 생성하려면 \'AI 분석 생성\' 버튼을 클릭하세요.</p>';

                    conversationDetail.classList.remove('hidden');

                    // 대화 내용 로드
                    const result = await getStudentConversation({
                        sessionId: session.sessionId
                    });

                    const conversations = result.data.conversations || [];

                    // 대화 메시지 렌더링
                    conversationMessages.innerHTML = '';

                    if (conversations.length === 0) {
                        conversationMessages.innerHTML = '<p class="text-gray-600 text-center py-4">아직 대화가 없습니다.</p>';
                        return;
                    }

                    conversations.forEach(conv => {
                        const messageElement = createMessageElement(conv);
                        conversationMessages.appendChild(messageElement);
                    });

                } catch (error) {
                    console.error('대화 내용 로드 실패:', error);
                    showStatus('대화 내용을 불러오는데 실패했습니다.', 'error');
                    conversationMessages.innerHTML = '<p class="text-red-600 text-center py-4">대화 내용을 불러올 수 없습니다.</p>';
                }
            }

            // 메시지 요소 생성
            function createMessageElement(conversation) {
                const div = document.createElement('div');
                div.className = 'space-y-2';

                // 메시지 타임스탬프 처리 개선
                let timestamp = '시간 정보 없음';
                if (conversation.timestamp) {
                    try {
                        const date = new Date(conversation.timestamp);
                        if (!isNaN(date.getTime())) {
                            timestamp = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('메시지 날짜 파싱 오류:', error);
                    }
                }

                div.innerHTML = `
                <!-- 학생 메시지 -->
                <div class="flex justify-end">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 bg-blue-500 text-white rounded-lg">
                        <p class="text-sm">${conversation.userMessage}</p>
                        <p class="text-xs text-blue-100 mt-1">${timestamp}</p>
                    </div>
                </div>
                
                <!-- AI 응답 -->
                <div class="flex justify-start">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 bg-gray-200 text-gray-800 rounded-lg">
                        <p class="text-sm whitespace-pre-wrap">${conversation.aiResponse}</p>
                        ${conversation.responseType ? `<p class="text-xs text-gray-600 mt-1">응답 유형: ${conversation.responseType}</p>` : ''}
                    </div>
                </div>
            `;

                return div;
            }

            // === 수업 관리 기능 ===

            // 수업 관리 관련 요소들
            const createLessonForm = document.getElementById('create-lesson-form');
            const lessonTitleInput = document.getElementById('lesson-title-input');
            const lessonSubjectSelect = document.getElementById('lesson-subject-select');
            const lessonDescriptionInput = document.getElementById('lesson-description-input');
            const createLessonBtn = document.getElementById('create-lesson-btn');
            const refreshLessonsBtn = document.getElementById('refresh-lessons-btn');
            const lessonsLoading = document.getElementById('lessons-loading');
            const lessonsEmpty = document.getElementById('lessons-empty');
            const lessonsList = document.getElementById('lessons-list');

            // 새 수업 생성 폼 제출
            createLessonForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const title = lessonTitleInput.value.trim();
                const subject = lessonSubjectSelect.value;
                const description = lessonDescriptionInput.value.trim();

                if (!title || !subject) {
                    showStatus('수업 제목과 과목을 모두 입력해주세요.', 'error');
                    return;
                }

                try {
                    createLessonBtn.textContent = '생성 중...';
                    createLessonBtn.disabled = true;

                    const result = await createLesson({
                        title,
                        subject,
                        description: description || null
                    });

                    showStatus('새 수업이 성공적으로 생성되었습니다!', 'success');

                    // 폼 리셋
                    createLessonForm.reset();

                    // 수업 목록 새로고침
                    await loadLessons();

                } catch (error) {
                    console.error('수업 생성 실패:', error);
                    showStatus(`수업 생성 실패: ${error.message}`, 'error');
                } finally {
                    createLessonBtn.textContent = '수업 생성';
                    createLessonBtn.disabled = false;
                }
            });

            // 수업 목록 새로고침 버튼
            refreshLessonsBtn.addEventListener('click', () => {
                loadLessons();
            });

            // 수업별 학생 세션 로드 기능
            async function loadLessonsForAnalysis() {
                try {
                    // 수업 목록 로딩 표시
                    analysisLessonsLoading.classList.remove('hidden');
                    analysisLessonsEmpty.classList.add('hidden');
                    analysisLessonsList.innerHTML = '';

                    // 대화 상세가 열려있으면 닫기
                    conversationDetail.classList.add('hidden');
                    lessonStudentsSection.classList.add('hidden');

                    // 수업 선택 섹션 표시
                    document.querySelector('.bg-white.rounded-lg.shadow-sm.border.mb-6').classList.remove('hidden');

                    // 수업 목록 가져오기
                    const result = await getLessons();
                    const lessons = result.data.lessons || [];

                    // 로딩 종료
                    analysisLessonsLoading.classList.add('hidden');

                    // 수업이 없는 경우
                    if (lessons.length === 0) {
                        analysisLessonsEmpty.classList.remove('hidden');
                        return;
                    }

                    // 수업 목록 렌더링
                    lessons.forEach(lesson => {
                        const lessonCard = createLessonCardForAnalysis(lesson);
                        analysisLessonsList.appendChild(lessonCard);
                    });

                } catch (error) {
                    console.error('분석용 수업 목록 로드 실패:', error);
                    showStatus('수업 목록을 불러오는데 실패했습니다.', 'error');
                    analysisLessonsLoading.classList.add('hidden');
                    analysisLessonsEmpty.classList.remove('hidden');
                }
            }

            // 분석용 수업 카드 생성
            function createLessonCardForAnalysis(lesson) {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-lg p-6 border border-gray-200 hover:border-blue-300 transition-colors card-hover';

                // 생성일 포맷팅
                let createdAtText = '생성일 정보 없음';
                if (lesson.createdAt) {
                    try {
                        const date = new Date(lesson.createdAt);
                        if (!isNaN(date.getTime())) {
                            createdAtText = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('날짜 파싱 오류:', error);
                    }
                }

                const subjectName = subjectNames[lesson.subject] || lesson.subject;
                const studentCount = lesson.studentCount || 0;

                div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-900">${lesson.title}</h3>
                    <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${subjectName}</span>
                </div>
                <p class="text-sm text-gray-600 mb-3">${lesson.description || '설명이 없습니다.'}</p>
                <div class="flex items-center justify-between text-sm text-gray-500">
                    <span>생성일: ${createdAtText}</span>
                    <span class="font-medium ${studentCount > 0 ? 'text-green-600' : ''}">
                        참여 학생: ${studentCount}명
                    </span>
                </div>
            `;

                // 수업 클릭 이벤트 - 해당 수업의 학생 세션 목록 로드
                div.addEventListener('click', () => {
                    loadLessonStudents(lesson);
                });

                return div;
            }

            // 수업별 학생 세션 로드
            async function loadLessonStudents(lesson) {
                try {
                    // 수업 선택 카드 숨기기
                    document.querySelector('.bg-white.rounded-lg.shadow-sm.border.mb-6').classList.add('hidden');

                    // 학생 목록 카드 표시
                    lessonStudentsSection.classList.remove('hidden');

                    // 선택된 수업 정보 표시
                    selectedLessonTitle.textContent = lesson.title;
                    const subjectName = subjectNames[lesson.subject] || lesson.subject;
                    selectedLessonInfo.textContent = `과목: ${subjectName} | 수업 코드: ${lesson.lessonCode}`;

                    // 로딩 표시
                    lessonStudentsLoading.classList.remove('hidden');
                    lessonStudentsEmpty.classList.add('hidden');
                    lessonStudentsList.innerHTML = '';

                    // 학생 세션 로드
                    const result = await getStudentSessions({ lessonId: lesson.id });
                    const sessions = result.data.sessions || [];

                    // 로딩 종료
                    lessonStudentsLoading.classList.add('hidden');

                    // 학생이 없는 경우
                    if (sessions.length === 0) {
                        lessonStudentsEmpty.classList.remove('hidden');
                        return;
                    }

                    // 세션을 lastActivity 기준으로 내림차순 정렬 (최신 활동이 먼저)
                    sessions.sort((a, b) => {
                        const aTime = a.lastActivity ? new Date(a.lastActivity) : new Date(0);
                        const bTime = b.lastActivity ? new Date(b.lastActivity) : new Date(0);
                        return bTime - aTime;
                    });

                    // 학생 목록 렌더링
                    sessions.forEach(session => {
                        const sessionElement = createLessonStudentElement(session);
                        lessonStudentsList.appendChild(sessionElement);
                    });

                } catch (error) {
                    console.error('수업별 학생 세션 로드 실패:', error);
                    showStatus('학생 세션 목록을 불러오는데 실패했습니다.', 'error');
                    lessonStudentsLoading.classList.add('hidden');
                    lessonStudentsEmpty.classList.remove('hidden');
                }
            }

            // 수업별 학생 요소 생성
            function createLessonStudentElement(session) {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors';

                // 날짜 처리 개선
                let lastActive = '시간 정보 없음';
                if (session.lastActive) {
                    try {
                        const date = new Date(session.lastActive);
                        if (!isNaN(date.getTime())) {
                            lastActive = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('날짜 파싱 오류:', error);
                    }
                }

                const messageCount = session.messageCount || 0;

                div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900">${session.studentName}</h4>
                        <p class="text-sm text-gray-500">대화 메시지 수: ${messageCount}개</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `;

                // 클릭 이벤트 추가
                div.addEventListener('click', () => {
                    loadStudentConversation(session);
                });

                return div;
            }

            // 수업 목록 로드
            async function loadLessons() {
                try {
                    lessonsLoading.classList.remove('hidden');
                    lessonsEmpty.classList.add('hidden');
                    lessonsList.innerHTML = '';

                    const result = await getLessons();
                    const lessons = result.data.lessons || [];

                    lessonsLoading.classList.add('hidden');

                    if (lessons.length === 0) {
                        lessonsEmpty.classList.remove('hidden');
                        return;
                    }

                    // 수업 목록 렌더링
                    lessons.forEach(lesson => {
                        const lessonElement = createLessonElement(lesson);
                        lessonsList.appendChild(lessonElement);
                    });

                } catch (error) {
                    console.error('수업 목록 로드 실패:', error);
                    showStatus('수업 목록을 불러오는데 실패했습니다.', 'error');
                    lessonsLoading.classList.add('hidden');
                    lessonsEmpty.classList.remove('hidden');
                }
            }

            // 과목 이름 매핑은 상단에서 이미 선언됨

            // 수업 요소 생성
            function createLessonElement(lesson) {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-6 border border-gray-200 hover:border-blue-300 transition-colors';

                // 생성일 포맷팅
                let createdAtText = '생성일 정보 없음';
                if (lesson.createdAt) {
                    try {
                        const date = new Date(lesson.createdAt);
                        if (!isNaN(date.getTime())) {
                            createdAtText = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('날짜 파싱 오류:', error);
                    }
                }

                const subjectName = subjectNames[lesson.subject] || lesson.subject;

                div.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <h3 class="text-lg font-semibold text-gray-900">${lesson.title}</h3>
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${subjectName}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">${lesson.description || '설명이 없습니다.'}</p>
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            <span>생성일: ${createdAtText}</span>
                            <span>수업 코드: <code class="bg-gray-200 px-1 rounded font-mono">${lesson.lessonCode}</code></span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <div class="flex items-center space-x-3">
                        <button class="copy-lesson-code-btn text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200 font-medium" data-code="${lesson.lessonCode}">
                            수업 코드 복사
                        </button>
                        <button class="show-qr-btn text-sm bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200 font-medium" data-lesson-id="${lesson.id}" data-code="${lesson.lessonCode}" data-title="${lesson.title}">
                            QR 코드 보기
                        </button>
                    </div>
                    <div class="text-xs text-gray-500">
                        참여 학생: <span class="font-medium">${lesson.studentCount || 0}명</span>
                    </div>
                </div>
            `;

                // 수업 코드 복사 버튼 이벤트
                const copyBtn = div.querySelector('.copy-lesson-code-btn');
                copyBtn.addEventListener('click', async () => {
                    const code = copyBtn.dataset.code;
                    try {
                        await navigator.clipboard.writeText(code);
                        showStatus('수업 코드가 클립보드에 복사되었습니다!', 'success');
                    } catch (error) {
                        // 클립보드 API가 지원되지 않는 경우
                        const textArea = document.createElement('textarea');
                        textArea.value = code;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showStatus('수업 코드가 클립보드에 복사되었습니다!', 'success');
                    }
                });

                // QR 코드 보기 버튼 이벤트
                const qrBtn = div.querySelector('.show-qr-btn');
                qrBtn.addEventListener('click', () => {
                    showQRCodeModal({
                        lessonCode: qrBtn.dataset.code,
                        title: qrBtn.dataset.title
                    });
                });

                return div;
            }

            // QR 코드 모달 생성 및 표시
            function showQRCodeModal(lesson) {
                // 기존 모달이 있으면 제거
                const existingModal = document.getElementById('qr-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                // 모달 HTML 생성
                const modal = document.createElement('div');
                modal.id = 'qr-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';

                modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-full overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">${lesson.title}</h3>
                        <button id="close-qr-modal" class="text-gray-400 hover:text-gray-600 p-1">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-center">
                        <div class="mb-4">
                            <h4 class="text-lg font-medium text-gray-700 mb-3">📱 QR 코드로 수업 참여</h4>
                            <div id="qr-code-container" class="flex justify-center mb-4 p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors" title="클릭하면 크게 볼 수 있습니다">
                                <!-- QR 코드가 여기에 생성됩니다 -->
                            </div>
                            <button id="enlarge-qr-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 font-medium mb-4 flex items-center space-x-2 mx-auto">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                                </svg>
                                <span>크게 보기</span>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                            <p class="text-sm text-blue-700 mb-2 font-medium">수업 코드</p>
                            <code class="text-xl font-mono font-bold text-blue-800">${lesson.lessonCode}</code>
                        </div>
                        
                        <div class="space-y-2 text-sm text-gray-600 mb-6">
                            <p class="font-medium">📋 사용 방법</p>
                            <p>• QR 코드를 스캔하거나</p>
                            <p>• 학생이 직접 수업 코드를 입력하면 참여 가능합니다</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button id="copy-lesson-code-btn" class="bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 font-medium flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <span>코드 복사</span>
                            </button>
                            <button id="copy-lesson-link-btn" class="bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 font-medium flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.1a3.994 3.994 0 011.536-2.846"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.172 13.828a4 4 0 005.656 0l4-4a4 4 0 10-5.656-5.656l-1.1 1.1a3.994 3.994 0 01-2.846 1.536"></path>
                                </svg>
                                <span>링크 복사</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 확대 QR 코드 모달 -->
                <div id="enlarged-qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-60">
                    <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900">QR 코드</h4>
                            <button id="close-enlarged-qr" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="enlarged-qr-container" class="mb-4">
                            <!-- 확대된 QR 코드가 여기에 생성됩니다 -->
                        </div>
                        <p class="text-sm text-gray-600">QR 코드를 스캔하여 수업에 참여하세요</p>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);

                // QR 코드 생성
                const qrContainer = document.getElementById('qr-code-container');
                const canvas = document.createElement('canvas');

                // 메인 사이트 URL + 수업 코드를 포함한 링크 생성
                const lessonUrl = `https://science-aichatbot.web.app/?lesson=${lesson.lessonCode}`;

                // QRious 라이브러리가 로드될 때까지 기다리기
                const generateQR = () => {
                    if (typeof QRious === 'undefined') {
                        // QRious가 아직 로드되지 않았으면 100ms 후 재시도
                        setTimeout(generateQR, 100);
                        return;
                    }

                    try {
                        const qr = new QRious({
                            element: canvas,
                            value: lessonUrl,
                            size: 240,
                            background: '#ffffff',
                            foreground: '#1f2937'
                        });
                        qrContainer.appendChild(canvas);
                    } catch (error) {
                        console.error('QR 코드 생성 오류:', error);
                        qrContainer.innerHTML = '<p class="text-red-600">QR 코드 생성에 실패했습니다.</p>';
                    }
                };

                generateQR();

                // 모달 닫기
                const closeBtn = document.getElementById('close-qr-modal');
                closeBtn.addEventListener('click', () => {
                    modal.remove();
                });

                // 모달 배경 클릭시 닫기
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                // QR 코드 컨테이너 클릭으로 확대
                qrContainer.addEventListener('click', showEnlargedQR);

                // QR 코드 확대 버튼
                const enlargeBtn = document.getElementById('enlarge-qr-btn');
                enlargeBtn.addEventListener('click', showEnlargedQR);

                function showEnlargedQR() {
                    const enlargedModal = document.getElementById('enlarged-qr-modal');
                    const enlargedContainer = document.getElementById('enlarged-qr-container');

                    // 확대된 QR 코드 생성
                    enlargedContainer.innerHTML = '';
                    const enlargedCanvas = document.createElement('canvas');

                    const generateEnlargedQR = () => {
                        if (typeof QRious === 'undefined') {
                            setTimeout(generateEnlargedQR, 100);
                            return;
                        }

                        try {
                            const enlargedQr = new QRious({
                                element: enlargedCanvas,
                                value: lessonUrl,
                                size: 320,
                                background: '#ffffff',
                                foreground: '#1f2937'
                            });
                            enlargedContainer.appendChild(enlargedCanvas);
                        } catch (error) {
                            console.error('확대 QR 코드 생성 오류:', error);
                            enlargedContainer.innerHTML = '<p class="text-red-600">QR 코드 생성에 실패했습니다.</p>';
                        }
                    };

                    generateEnlargedQR();

                    enlargedModal.classList.remove('hidden');
                }

                // 확대 모달 닫기
                const closeEnlargedBtn = document.getElementById('close-enlarged-qr');
                closeEnlargedBtn.addEventListener('click', () => {
                    document.getElementById('enlarged-qr-modal').classList.add('hidden');
                });

                // 확대 모달 배경 클릭시 닫기
                document.getElementById('enlarged-qr-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'enlarged-qr-modal') {
                        document.getElementById('enlarged-qr-modal').classList.add('hidden');
                    }
                });

                // 수업 코드 복사
                const copyCodeBtn = document.getElementById('copy-lesson-code-btn');
                copyCodeBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(lesson.lessonCode);
                        showStatus('수업 코드가 클립보드에 복사되었습니다!', 'success');
                    } catch (error) {
                        // 클립보드 API가 지원되지 않는 경우
                        const textArea = document.createElement('textarea');
                        textArea.value = lesson.lessonCode;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showStatus('수업 코드가 클립보드에 복사되었습니다!', 'success');
                    }
                });

                // 수업 링크 복사
                const copyLinkBtn = document.getElementById('copy-lesson-link-btn');
                copyLinkBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(lessonUrl);
                        showStatus('수업 링크가 클립보드에 복사되었습니다!', 'success');
                    } catch (error) {
                        // 클립보드 API가 지원되지 않는 경우
                        const textArea = document.createElement('textarea');
                        textArea.value = lessonUrl;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showStatus('수업 링크가 클립보드에 복사되었습니다!', 'success');
                    }
                });
            }

            // 기존 loadTeacherInfo 함수 수정하여 섹션별 UI 업데이트
            const originalLoadTeacherInfo = loadTeacherInfo;
            loadTeacherInfo = async function () {
                await originalLoadTeacherInfo();

                // 현재 섹션에 따라 UI 업데이트
                if (currentSection === 'prompts') {
                    if (currentSettings && currentSettings.hasApiKey) {
                        adaptivePromptSettingsSection.classList.remove('hidden');
                    }
                }
            };
        </script>
</body>

</html>