<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI êµìœ¡ íŠœí„° - êµì‚¬ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.svg">
    <link rel="apple-touch-icon" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script>
        // QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© í™•ì¸
        document.addEventListener('DOMContentLoaded', function () {
            console.log('QRious library loaded:', typeof QRious !== 'undefined');
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* í…œí”Œë¦¿ ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .template-mode-buttons,
        .edit-template-mode-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .template-mode-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .template-mode-btn:hover {
            background-color: #e5e7eb;
            color: #111827;
        }

        .template-mode-btn.selected {
            background-color: #dbeafe;
            color: #1e40af;
            border-color: #93c5fd;
        }

        /* í…œí”Œë¦¿ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .template-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>

    <style>
        /* í…œí”Œë¦¿ ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§ */
        .template-mode-buttons,
        .edit-template-mode-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .template-mode-btn {
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            color: #374151;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .template-mode-btn:hover {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .template-mode-btn.selected {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border-color: #7c3aed;
            color: white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .template-mode-btn.selected:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center gradient-bg">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                        </path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">êµì‚¬ ì „ìš© í˜ì´ì§€</h1>
                <p class="text-gray-600">AI ì±—ë´‡ì„ ì„¤ì •í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>

            <button id="google-login-btn"
                class="w-full bg-white border border-gray-300 text-gray-700 py-3 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                <span>Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</span>
            </button>

            <div id="login-loading" class="hidden text-center py-4">
                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <p class="text-gray-600 mt-2">ë¡œê·¸ì¸ ì¤‘...</p>
            </div>
        </div>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="dashboard-screen" class="hidden min-h-screen bg-gray-50">
        <div class="flex h-screen">
            <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
            <aside class="w-64 bg-white shadow-lg border-r border-gray-200 flex flex-col">
                <!-- ì‚¬ì´ë“œë°” í—¤ë” -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800">AI ì±—ë´‡ ê´€ë¦¬</h2>
                            <p class="text-sm text-gray-500">êµì‚¬ ëŒ€ì‹œë³´ë“œ</p>
                        </div>
                    </div>
                </div>

                <!-- ë‚´ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
                <nav class="flex-1 px-4 py-6">
                    <ul class="space-y-2">
                        <li>
                            <button
                                class="nav-item w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors flex items-center space-x-3 active"
                                data-section="settings">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                    </path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span>ê¸°ë³¸ ì„¤ì •</span>
                            </button>
                        </li>
                        <li>
                            <button
                                class="nav-item w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors flex items-center space-x-3"
                                data-section="lessons">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                                <span>ìˆ˜ì—… ê´€ë¦¬</span>
                            </button>
                        </li>
                        <li>
                            <button
                                class="nav-item w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors flex items-center space-x-3"
                                data-section="prompts">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                    </path>
                                </svg>
                                <span>í”„ë¡¬í”„íŠ¸ ì„¤ì •</span>
                            </button>
                        </li>
                        <li>
                            <button
                                class="nav-item w-full text-left px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors flex items-center space-x-3"
                                data-section="students">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                                <span>í•™ìƒ ëŒ€í™” ë¶„ì„</span>
                            </button>
                        </li>
                    </ul>
                </nav>

                <!-- ì‚¬ìš©ì ì •ë³´ -->
                <div class="p-4 border-t border-gray-200">
                    <div class="flex items-center space-x-3 mb-3">
                        <img id="user-photo" class="w-10 h-10 rounded-full" alt="í”„ë¡œí•„">
                        <div class="flex-1 min-w-0">
                            <p id="user-name" class="text-sm font-medium text-gray-900 truncate"></p>
                            <p class="text-xs text-gray-500">êµì‚¬ ê³„ì •</p>
                        </div>
                    </div>
                    <button id="logout-btn"
                        class="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </aside>

            <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
            <main class="flex-1 overflow-y-auto bg-gray-50">
                <div class="p-8">

                    <!-- ê¸°ë³¸ ì„¤ì • ì„¹ì…˜ -->
                    <div id="settings-section" class="space-y-6">
                        <!-- API í‚¤ ì„¤ì • ì¹´ë“œ -->
                        <div class="bg-white rounded-lg shadow-sm border p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">Gemini API í‚¤ ì„¤ì •</h2>
                                    <p class="text-gray-600 text-sm mt-1">í•™ìƒë“¤ì´ AI íŠœí„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ API í‚¤ë¥¼ ë“±ë¡í•˜ì„¸ìš”</p>
                                </div>
                                <div id="api-status" class="px-3 py-1 rounded-full text-sm font-medium hidden">
                                    <!-- API ìƒíƒœê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                            </div>

                            <div id="api-setup-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Google Gemini API í‚¤
                                    </label>
                                    <div class="flex space-x-3">
                                        <textarea id="api-key-input" placeholder="AIzaSy..." rows="2"
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                                        <button id="save-api-key-btn"
                                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                            ì €ì¥
                                        </button>
                                    </div>
                                    <div class="mt-2 flex items-center space-x-4 text-sm text-gray-600">
                                        <a href="https://aistudio.google.com/apikey" target="_blank"
                                            class="text-blue-600 hover:underline flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14">
                                                </path>
                                            </svg>
                                            <span>API í‚¤ ë°œê¸‰ë°›ê¸°</span>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div id="api-configured" class="hidden">
                                <div
                                    class="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-md">
                                    <div class="flex items-center space-x-3">
                                        <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-green-700 font-medium">API í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
                                    </div>
                                    <button id="update-api-key-btn"
                                        class="text-green-600 hover:text-green-800 text-sm font-medium">
                                        ìˆ˜ì •
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Gemini AI API ë°œê¸‰ ë°©ë²• ì„¤ëª… ì¹´ë“œ -->
                        <div class="bg-white rounded-lg shadow-sm border p-6">
                            <div class="mb-6">
                                <h2 class="text-lg font-semibold text-gray-800">ğŸ’¡ Gemini AI API í‚¤ ë°œê¸‰ ë°©ë²•</h2>
                                <p class="text-gray-600 text-sm mt-1">ì•„ë˜ ë‹¨ê³„ë¥¼ ë”°ë¼ ë¬´ë£Œë¡œ Gemini API í‚¤ë¥¼ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>

                            <div class="space-y-4">
                                <ol class="list-decimal list-inside text-gray-700 space-y-3 text-sm">
                                    <li>
                                        <strong>Google AI Studio ì ‘ì†:</strong>
                                        <a href="https://aistudio.google.com/apikey" target="_blank"
                                            class="text-blue-600 hover:underline font-medium">Google AI Studio</a>ì— ë°©ë¬¸í•˜ì—¬
                                        'Get API key' ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.
                                    </li>
                                    <li>
                                        <strong>Google ê³„ì • ë¡œê·¸ì¸:</strong> í™”ë©´ ì•ˆë‚´ì— ë”°ë¼ ì‚¬ìš©í•˜ì‹œëŠ” Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
                                    </li>
                                    <li>
                                        <strong>API í‚¤ ìƒì„±:</strong> 'Create API key' ë˜ëŠ” 'Create API key in new project'
                                        ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ API í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                                    </li>
                                    <li>
                                        <strong>API í‚¤ ë³µì‚¬ ë° ë¶™ì—¬ë„£ê¸°:</strong> ìƒì„±ëœ ê¸´ ë¬¸ìì—´ì˜ API í‚¤ë¥¼ ë³µì‚¬í•œ í›„, ì´ í˜ì´ì§€ ìƒë‹¨ì˜ 'Gemini API
                                        í‚¤ ì„¤ì •' ì…ë ¥ë€ì— ë¶™ì—¬ë„£ê³  'ì €ì¥' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì™„ë£Œë©ë‹ˆë‹¤.
                                    </li>
                                </ol>

                                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor"
                                                aria-hidden="true">
                                                <path fill-rule="evenodd"
                                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <p class="text-sm text-blue-700">
                                                API í‚¤ëŠ” ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì´ ì¤‘ìš”í•˜ë¯€ë¡œ, ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì£¼ì„¸ìš”.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- AI ëª¨ë¸ ì„ íƒ ì¹´ë“œ -->
                        <div id="model-settings-section" class="bg-white rounded-lg shadow-sm border p-6 hidden">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">AI ëª¨ë¸ ì„ íƒ</h2>
                                    <p class="text-gray-600 text-sm mt-1">ì‚¬ìš©í•  Google Gemini AI ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”</p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        AI ëª¨ë¸ ì„ íƒ
                                    </label>
                                    <select id="model-select"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="gemini-3-pro">Gemini 3.0 Pro</option>
                                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite</option>


                                    </select>
                                    <div class="mt-2 text-sm text-gray-600">
                                        <p><strong>ì¶”ì²œ:</strong> Gemini 2.5 Flash-liteì€ ì†ë„ì™€ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°, ë¹„ìš© ì¸¡ë©´ì—ì„œ ê°€ì¥ ì ì ˆí•©ë‹ˆë‹¤.
                                        </p>
                                    </div>
                                    <!-- ëª¨ë¸ë³„ ì‚¬ìš©ëŸ‰ ì•ˆë‚´ ì¹´ë“œ -->
                                    <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm">
                                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center space-x-2">
                                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                                </path>
                                            </svg>
                                            <span>ëª¨ë¸ë³„ ì˜ˆìƒ ì‚¬ìš©ëŸ‰ ë° ë¹„ìš© ì•ˆë‚´</span>
                                        </h4>
                                        <p class="text-gray-600 mb-4">
                                            ì•„ë˜ ì •ë³´ëŠ” <strong>1ê°œ í•™ê¸‰(20ëª…)</strong>ì´ <strong>1ì‹œê°„ ë™ì•ˆ í™œë°œíˆ ìˆ˜ì—…</strong>í•˜ëŠ” ìƒí™©ì„ ê°€ì •í•œ
                                            <strong class="text-blue-600">ë¬´ë£Œ í‹°ì–´</strong> ê¸°ì¤€ ì˜ˆìƒì¹˜ì…ë‹ˆë‹¤.
                                        </p>

                                        <div class="overflow-x-auto">
                                            <table class="w-full text-left border-collapse">
                                                <thead>
                                                    <tr class="bg-gray-100">
                                                        <th
                                                            class="border-b-2 border-gray-200 p-2 font-medium text-gray-600">
                                                            ëª¨ë¸ëª…</th>
                                                        <th
                                                            class="border-b-2 border-gray-200 p-2 font-medium text-gray-600 text-center">
                                                            ì˜ˆìƒ ë¹„ìš©</th>
                                                        <th
                                                            class="border-b-2 border-gray-200 p-2 font-medium text-gray-600 text-center">
                                                            ë¶„ë‹¹ ìš”ì²­ìˆ˜ (RPM)</th>
                                                        <th
                                                            class="border-b-2 border-gray-200 p-2 font-medium text-gray-600 text-center">
                                                            ë¶„ë‹¹ í† í° ìˆ˜ (TPM)</th>
                                                        <th
                                                            class="border-b-2 border-gray-200 p-2 font-medium text-gray-600 text-center">
                                                            ì¼ì¼ ìš”ì²­ìˆ˜ (RPD)</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="text-gray-700">
                                                    <tr class="hover:bg-gray-100">
                                                        <td class="border-b border-gray-200 p-2 font-mono text-xs">
                                                            gemini-2.5-flash-lite</td>
                                                        <td
                                                            class="border-b border-gray-200 p-2 text-green-600 font-semibold text-center">
                                                            ë¬´ë£Œ</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">15íšŒ</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">250,000
                                                        </td>
                                                        <td class="border-b border-gray-200 p-2 text-center">1,000íšŒ</td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-100">
                                                        <td class="border-b border-gray-200 p-2 font-mono text-xs">
                                                            gemini-2.0-flash</td>
                                                        <td
                                                            class="border-b border-gray-200 p-2 text-green-600 font-semibold text-center">
                                                            ë¬´ë£Œ</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">15íšŒ</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">1,000,000
                                                        </td>
                                                        <td class="border-b border-gray-200 p-2 text-center">200íšŒ</td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-100">
                                                        <td class="border-b border-gray-200 p-2 font-mono text-xs">
                                                            gemini-2.0-flash-lite</td>
                                                        <td
                                                            class="border-b border-gray-200 p-2 text-green-600 font-semibold text-center">
                                                            ë¬´ë£Œ</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">30íšŒ</td>
                                                        <td class="border-b border-gray-200 p-2 text-center">1,000,000
                                                        </td>
                                                        <td class="border-b border-gray-200 p-2 text-center">200íšŒ</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <p class="text-gray-600 mt-4">ì¼ë°˜ì ì¸ ìˆ˜ì—… í™˜ê²½ì—ì„œëŠ” ë¬´ë£Œ ì‚¬ìš©ëŸ‰ ì œí•œì— ë„ë‹¬í•  ê°€ëŠ¥ì„±ì´ ë‚®ìŠµë‹ˆë‹¤. ê²°ì œ ê³„ì •ì„ ë“±ë¡í•œ
                                            ê²½ìš° ë¹„ìœ¨ ì œí•œ ë²”ìœ„(Tier1)ê°€ ë” í™•ëŒ€ë˜ë‹ˆ ë” ìì„¸í•œ ì •ë³´ëŠ” ì•„ë˜ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.</p>
                                        <a href="https://ai.google.dev/gemini-api/docs/rate-limits?hl=ko"
                                            target="_blank"
                                            class="text-blue-600 hover:underline font-medium mt-2 inline-block">ëª¨ë¸ë³„ ë¹„ìœ¨
                                            ì œí•œì— ëŒ€í•´ ë” ì•Œì•„ë³´ê¸° &rarr;</a>
                                    </div>
                                </div>

                                <div class="flex justify-end space-x-3">
                                    <button id="save-model-btn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                        ëª¨ë¸ ì €ì¥
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- êµì‚¬ ì½”ë“œ í‘œì‹œ ì¹´ë“œ -->
                        <div id="teacher-code-section" class="bg-white rounded-lg shadow-sm border p-6 hidden">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">êµì‚¬ ì½”ë“œ</h2>
                                    <p class="text-gray-600 text-sm mt-1">ì´ ì½”ë“œë¡œ í•™ìƒë“¤ì´ AI íŠœí„°ì— ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-3">
                                <div
                                    class="flex-1 px-4 py-3 bg-gray-50 border border-gray-200 rounded-md font-mono text-lg font-semibold text-center text-gray-800">
                                    <span id="teacher-code-display">-</span>
                                </div>
                                <button id="copy-code-btn"
                                    class="px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                    ë³µì‚¬
                                </button>
                            </div>
                        </div>


                    </div>

                    <!-- ìˆ˜ì—… ê´€ë¦¬ ì„¹ì…˜ -->
                    <div id="lessons-section" class="hidden">
                        <div class="mb-6">
                            <h1 class="text-2xl font-bold text-gray-900">ìˆ˜ì—… ê´€ë¦¬</h1>
                            <p class="text-gray-600 mt-2">AI íŠœí„°ë¥¼ í™œìš©í•œ ìˆ˜ì—…ì„ ìƒì„±í•˜ê³  QRì½”ë“œë¡œ í•™ìƒë“¤ê³¼ ê³µìœ í•˜ì„¸ìš”.</p>
                        </div>

                        <!-- ìƒˆ ìˆ˜ì—… ìƒì„± ì¹´ë“œ -->
                        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">ìƒˆ ìˆ˜ì—… ìƒì„±</h2>
                                    <p class="text-gray-600 text-sm mt-1">ê³¼ëª©ì„ ì„ íƒí•˜ê³  ìˆ˜ì—… ì œëª©ì„ ì…ë ¥í•˜ì—¬ ìƒˆë¡œìš´ ìˆ˜ì—…ì„ ë§Œë“œì„¸ìš”.</p>
                                </div>
                            </div>

                            <form id="create-lesson-form" class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            ìˆ˜ì—… ì œëª©
                                        </label>
                                        <input type="text" id="lesson-title-input" placeholder="ì˜ˆ: ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ, ì¡°ì„ ì‹œëŒ€ ë¬¸í™”"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            ê³¼ëª© ì„ íƒ
                                        </label>
                                        <select id="lesson-subject"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            required>
                                            <option value="">ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                            <option value="korean">êµ­ì–´</option>
                                            <option value="math">ìˆ˜í•™</option>
                                            <option value="social">ì‚¬íšŒ</option>
                                            <option value="science">ê³¼í•™</option>
                                            <option value="counseling">ìƒë‹´/ê°ì •ì¼€ì–´</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="flex items-center space-x-2">
                                            <span>ğŸ¯ AI íŠœí„° ì—­í•  ë° êµìˆ˜ ë°©ë²• ì§€ì‹œ</span>
                                            <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full">êµì‚¬
                                                ì „ìš©</span>
                                        </span>
                                    </label>

                                    <!-- ì‚¬ê³ ë ¥ ì¦ì§„ í…œí”Œë¦¿ ì„ íƒ ì˜ì—­ -->
                                    <div id="template-mode-section"
                                        class="mb-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg hidden">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 id="template-mode-title"
                                                class="text-sm font-semibold text-purple-800 flex items-center">
                                                <span class="mr-2">ğŸ¯</span>í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”
                                            </h4>
                                            <button type="button" id="template-help-btn"
                                                class="text-xs text-purple-600 hover:text-purple-800 focus:outline-none">
                                                â“ ë„ì›€ë§
                                            </button>
                                        </div>

                                        <!-- í…œí”Œë¦¿ ëª¨ë“œ ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
                                        <div class="template-mode-buttons">
                                            <!-- í…œí”Œë¦¿ ëª¨ë“œ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                                        </div>

                                        <!-- ì„ íƒëœ í…œí”Œë¦¿ ì •ë³´ í‘œì‹œ -->
                                        <div id="selected-template-info"
                                            class="hidden p-3 bg-white border border-purple-200 rounded-md">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <h5 id="template-title" class="font-semibold text-purple-800 mb-1">
                                                    </h5>
                                                    <p id="template-description" class="text-xs text-gray-600 mb-2"></p>
                                                    <div class="flex items-center space-x-4 text-xs text-gray-500">
                                                        <span id="template-subjects"></span>
                                                        <span id="template-difficulty"></span>
                                                    </div>
                                                </div>
                                                <div class="flex space-x-1 ml-2">
                                                    <button id="preview-template-btn"
                                                        class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 focus:outline-none"
                                                        type="button">
                                                        ğŸ‘ ë¯¸ë¦¬ë³´ê¸°
                                                    </button>
                                                    <button id="apply-template-btn"
                                                        class="px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 focus:outline-none"
                                                        type="button">
                                                        ì ìš©í•˜ê¸°
                                                    </button>
                                                    <button id="clear-template-btn"
                                                        class="px-1 py-1 text-xs text-gray-500 hover:text-red-600 focus:outline-none"
                                                        type="button">
                                                        âœ•
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <textarea id="lesson-ai-instructions" rows="5" placeholder="AI íŠœí„°ì˜ ì—­í• , í•µì‹¬ ê°œë…, ë‹µë³€ í†¤, í•™ìŠµ ëª©í‘œë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì§€ì‹œí•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ:
â€¢ ë„ˆëŠ” ì¡°ì„ ì‹œëŒ€ ë¬¸í™”ë¥¼ ì„¤ëª…í•˜ëŠ” ì—­ì‚¬í•™ìì•¼. ì™• ì¤‘ì‹¬ì´ ì•„ë‹Œ ë°±ì„±ì˜ ì‚¶ì— ì´ˆì ì„ ë§ì¶° ì„¤ëª…í•´ì¤˜.
â€¢ ë„ˆëŠ” ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆì„ ê°€ë¥´ì¹˜ëŠ” ìˆ˜í•™ ì„ ìƒë‹˜ì´ì•¼. í”¼ìë‚˜ ì¼€ì´í¬ ê°™ì€ êµ¬ì²´ì ì¸ ì˜ˆì‹œë¥¼ ë“¤ì–´ê°€ë©° ì„¤ëª…í•´ì¤˜.
â€¢ ë„ˆëŠ” ì‹ë¬¼ì˜ ê´‘í•©ì„±ì„ ì„¤ëª…í•˜ëŠ” ê³¼í•™ìì•¼. ì•„ì´ë“¤ì´ ì§ì ‘ ê´€ì°°í•  ìˆ˜ ìˆëŠ” í˜„ìƒë“¤ê³¼ ì—°ê²°ì§€ì–´ ì„¤ëª…í•´ì¤˜.

ğŸ’¡ ìœ„ì˜ 'ì‚¬ê³ ë ¥ ì¦ì§„ í…œí”Œë¦¿'ì„ ì‚¬ìš©í•˜ë©´ ì „ë¬¸ì ì¸ êµìœ¡ ë°©ë²•ë¡ ì— ê¸°ë°˜í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì‰½ê²Œ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
                                    <div class="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-md">
                                        <p class="text-xs text-amber-700">
                                            <strong>ğŸ’¡ ì¤‘ìš”:</strong> ì´ ë‚´ìš©ì€ AI íŠœí„°ì˜ ë™ì‘ì„ ì œì–´í•˜ëŠ” ë‚´ë¶€ ì§€ì‹œì‚¬í•­ìœ¼ë¡œ, í•™ìƒì—ê²ŒëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="flex items-center space-x-2">
                                            <span>ğŸ“ ìˆ˜ì—… ì„¤ëª…</span>
                                            <span
                                                class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">í•™ìƒì—ê²Œ
                                                í‘œì‹œ</span>
                                        </span>
                                    </label>
                                    <textarea id="lesson-student-description-input" rows="3" placeholder="í•™ìƒë“¤ì´ ë³¼ ìˆ˜ ìˆëŠ” ìˆ˜ì—… ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.

ì˜ˆì‹œ:
â€¢ ì˜¤ëŠ˜ì€ ì¡°ì„ ì‹œëŒ€ ë°±ì„±ë“¤ì˜ ì¼ìƒìƒí™œê³¼ ë¬¸í™”ì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤.
â€¢ ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆì„ ì‹¤ìƒí™œ ì˜ˆì‹œì™€ í•¨ê»˜ ë°°ì›Œë´…ì‹œë‹¤.
â€¢ ì‹ë¬¼ì˜ ê´‘í•©ì„± ê³¼ì •ê³¼ ìš°ë¦¬ ìƒí™œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ íƒêµ¬í•©ë‹ˆë‹¤."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
                                    <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                        <p class="text-xs text-blue-700">
                                            <strong>ğŸ’¡ íŒ:</strong> í•™ìƒë“¤ì´ ìˆ˜ì—…ì— ì ‘ì†í•  ë•Œ ë³¼ ìˆ˜ ìˆëŠ” ì„¤ëª…ì…ë‹ˆë‹¤. í•™ìŠµ ëª©í‘œì™€ ë‚´ìš©ì„ ê°„ë‹¨ëª…ë£Œí•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
                                        </p>
                                    </div>
                                </div>

                                <!-- í•™ìŠµ ìë£Œ ì¶”ê°€ ì„¹ì…˜ -->
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="flex items-center space-x-2">
                                            <span>ğŸ“š í•™ìŠµ ìë£Œ ë° íŒíŠ¸</span>
                                            <span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">ìƒˆ
                                                ê¸°ëŠ¥</span>
                                        </span>
                                    </label>
                                    <p class="text-xs text-gray-600 mb-3">í•™ìƒë“¤ì´ ë§‰í ë•Œ AI íŠœí„°ê°€ ì œê³µí•  ë³´ì¶© ìë£Œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>

                                    <!-- ìë£Œ ì¶”ê°€ ë²„íŠ¼ë“¤ -->
                                    <div class="flex space-x-3 mb-3">
                                        <button type="button" id="add-link-btn"
                                            class="px-3 py-1.5 text-sm bg-blue-50 text-blue-700 border border-blue-200 rounded-md hover:bg-blue-100 font-medium">
                                            ğŸ”— ì›¹ ë§í¬ ì¶”ê°€
                                        </button>
                                        <button type="button" id="add-file-btn"
                                            class="px-3 py-1.5 text-sm bg-green-50 text-green-700 border border-green-200 rounded-md hover:bg-green-100 font-medium">
                                            ğŸ“ íŒŒì¼ ì—…ë¡œë“œ
                                        </button>
                                    </div>

                                    <!-- ì¶”ê°€ëœ ìë£Œ ëª©ë¡ -->
                                    <div id="resources-list" class="space-y-2 mb-3">
                                        <!-- ìë£Œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                    </div>

                                    <!-- ë§í¬ ì¶”ê°€ ì…ë ¥ ì˜ì—­ (ìˆ¨ê¹€ ìƒíƒœ) -->
                                    <div id="link-input-area" class="hidden p-3 bg-gray-50 rounded-md mb-3">
                                        <div class="flex space-x-2">
                                            <input type="text" id="link-title-input" placeholder="ë§í¬ ì œëª© (ì˜ˆ: ê°œë… ì„¤ëª… ì˜ìƒ)"
                                                class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                            <input type="url" id="link-url-input" placeholder="https://..."
                                                class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                            <button type="button" id="save-link-btn"
                                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                                ì¶”ê°€
                                            </button>
                                            <button type="button" id="cancel-link-btn"
                                                class="px-3 py-1 text-sm bg-gray-400 text-white rounded-md hover:bg-gray-500">
                                                ì·¨ì†Œ
                                            </button>
                                        </div>
                                    </div>

                                    <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ (ìˆ¨ê¹€ ìƒíƒœ) -->
                                    <div id="file-upload-area" class="hidden p-3 bg-gray-50 rounded-md mb-3">
                                        <div class="space-y-2">
                                            <input type="file" id="file-input"
                                                accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.jpeg,.png"
                                                class="text-sm file:mr-3 file:px-3 file:py-1 file:rounded-md file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                            <div class="flex space-x-2">
                                                <button type="button" id="upload-file-btn"
                                                    class="px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                                    ì—…ë¡œë“œ
                                                </button>
                                                <button type="button" id="cancel-file-btn"
                                                    class="px-3 py-1 text-sm bg-gray-400 text-white rounded-md hover:bg-gray-500">
                                                    ì·¨ì†Œ
                                                </button>
                                            </div>
                                            <div id="upload-progress" class="hidden">
                                                <div class="text-xs text-gray-600 mb-1">ì—…ë¡œë“œ ì¤‘...</div>
                                                <div class="w-full bg-gray-200 rounded-full h-1.5">
                                                    <div id="upload-progress-bar"
                                                        class="bg-blue-600 h-1.5 rounded-full transition-all"
                                                        style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                                        <p class="text-xs text-blue-700">
                                            <strong>ğŸ’¡ íŒ:</strong> í•™ìƒì´ 2íšŒ ì´ìƒ ë§‰í ë•Œ AI íŠœí„°ê°€ ì´ ìë£Œë“¤ì„ ì ì ˆíˆ ì œê³µí•©ë‹ˆë‹¤.
                                        </p>
                                    </div>
                                </div>

                                <div class="flex justify-end">
                                    <button type="submit" id="create-lesson-btn"
                                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                        ìˆ˜ì—… ìƒì„±
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- í™œì„± ìˆ˜ì—… ëª©ë¡ -->
                        <div class="bg-white rounded-lg shadow-sm border">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-lg font-semibold text-gray-800">ë‚´ ìˆ˜ì—… ëª©ë¡</h2>
                                    <button id="refresh-lessons-btn"
                                        class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                                        ìƒˆë¡œê³ ì¹¨
                                    </button>
                                </div>
                            </div>

                            <div class="p-6">
                                <div id="lessons-loading" class="text-center py-8 hidden">
                                    <div
                                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                    </div>
                                    <p class="text-gray-600 mt-2">ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                </div>

                                <div id="lessons-empty" class="text-center py-8 hidden">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                        </path>
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900">ì•„ì§ ìƒì„±ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                                    <p class="mt-1 text-sm text-gray-500">ìœ„ì—ì„œ ìƒˆ ìˆ˜ì—…ì„ ìƒì„±í•´ë³´ì„¸ìš”.</p>
                                </div>

                                <div id="lessons-list" class="space-y-4">
                                    <!-- ìˆ˜ì—… ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ìˆ˜ì—… í¸ì§‘ ëª¨ë‹¬ -->
                    <div id="edit-lesson-modal"
                        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-full overflow-y-auto">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-semibold text-gray-900">ìˆ˜ì—… í¸ì§‘</h3>
                                <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600 p-1">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <form id="edit-lesson-form" class="space-y-4">
                                <input type="hidden" id="edit-lesson-id">

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ì—… ì œëª©</label>
                                    <input type="text" id="edit-lesson-title" placeholder="ì˜ˆ: ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ, ì¡°ì„ ì‹œëŒ€ ë¬¸í™”"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ê³¼ëª© ì„ íƒ</label>
                                    <select id="edit-lesson-subject"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required>
                                        <option value="">ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="korean">êµ­ì–´</option>
                                        <option value="math">ìˆ˜í•™</option>
                                        <option value="social">ì‚¬íšŒ</option>
                                        <option value="science">ê³¼í•™</option>
                                        <option value="counseling">ìƒë‹´/ê°ì •ì¼€ì–´</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="flex items-center space-x-2">
                                            <span>ğŸ¯ AI íŠœí„° ì—­í•  ë° êµìˆ˜ ë°©ë²• ì§€ì‹œ</span>
                                            <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full">êµì‚¬
                                                ì „ìš©</span>
                                        </span>
                                    </label>

                                    <!-- í¸ì§‘ ëª¨ë‹¬ ì‚¬ê³ ë ¥ ì¦ì§„ í…œí”Œë¦¿ ì„ íƒ ì˜ì—­ -->
                                    <div id="edit-template-mode-section"
                                        class="mb-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg hidden">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 id="edit-template-mode-title"
                                                class="text-sm font-semibold text-purple-800 flex items-center">
                                                <span class="mr-2">ğŸ¯</span>í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”
                                            </h4>
                                        </div>

                                        <!-- í…œí”Œë¦¿ ëª¨ë“œ ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
                                        <div class="edit-template-mode-buttons">
                                            <!-- í…œí”Œë¦¿ ëª¨ë“œ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                                        </div>

                                        <!-- ì„ íƒëœ í…œí”Œë¦¿ ì •ë³´ í‘œì‹œ -->
                                        <div id="edit-selected-template-info"
                                            class="hidden p-3 bg-white border border-purple-200 rounded-md">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <h5 id="edit-template-title"
                                                        class="font-semibold text-purple-800 mb-1"></h5>
                                                    <p id="edit-template-description"
                                                        class="text-xs text-gray-600 mb-2"></p>
                                                    <div class="flex items-center space-x-4 text-xs text-gray-500">
                                                        <span id="edit-template-subjects"></span>
                                                        <span id="edit-template-difficulty"></span>
                                                    </div>
                                                </div>
                                                <div class="flex space-x-1 ml-2">
                                                    <button id="edit-preview-template-btn"
                                                        class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 focus:outline-none"
                                                        type="button">
                                                        ğŸ‘ ë¯¸ë¦¬ë³´ê¸°
                                                    </button>
                                                    <button id="edit-apply-template-btn"
                                                        class="px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 focus:outline-none"
                                                        type="button">
                                                        ì ìš©í•˜ê¸°
                                                    </button>
                                                    <button id="edit-clear-template-btn"
                                                        class="px-1 py-1 text-xs text-gray-500 hover:text-red-600 focus:outline-none"
                                                        type="button">
                                                        âœ•
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <textarea id="edit-lesson-ai-instructions" rows="5" placeholder="AI íŠœí„°ì˜ ì—­í• , í•µì‹¬ ê°œë…, ë‹µë³€ í†¤, í•™ìŠµ ëª©í‘œë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì§€ì‹œí•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ:
â€¢ ë„ˆëŠ” ì¡°ì„ ì‹œëŒ€ ë¬¸í™”ë¥¼ ì„¤ëª…í•˜ëŠ” ì—­ì‚¬í•™ìì•¼. ì™• ì¤‘ì‹¬ì´ ì•„ë‹Œ ë°±ì„±ì˜ ì‚¶ì— ì´ˆì ì„ ë§ì¶° ì„¤ëª…í•´ì¤˜.
â€¢ ë„ˆëŠ” ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆì„ ê°€ë¥´ì¹˜ëŠ” ìˆ˜í•™ ì„ ìƒë‹˜ì´ì•¼. í”¼ìë‚˜ ì¼€ì´í¬ ê°™ì€ êµ¬ì²´ì ì¸ ì˜ˆì‹œë¥¼ ë“¤ì–´ê°€ë©° ì„¤ëª…í•´ì¤˜.
â€¢ ë„ˆëŠ” ì‹ë¬¼ì˜ ê´‘í•©ì„±ì„ ì„¤ëª…í•˜ëŠ” ê³¼í•™ìì•¼. ì•„ì´ë“¤ì´ ì§ì ‘ ê´€ì°°í•  ìˆ˜ ìˆëŠ” í˜„ìƒë“¤ê³¼ ì—°ê²°ì§€ì–´ ì„¤ëª…í•´ì¤˜.

ğŸ’¡ ìœ„ì˜ 'ì‚¬ê³ ë ¥ ì¦ì§„ í…œí”Œë¦¿'ì„ ì‚¬ìš©í•˜ë©´ ì „ë¬¸ì ì¸ êµìœ¡ ë°©ë²•ë¡ ì— ê¸°ë°˜í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì‰½ê²Œ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
                                    <div class="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-md">
                                        <p class="text-xs text-amber-700">
                                            <strong>ğŸ’¡ ì¤‘ìš”:</strong> ì´ ë‚´ìš©ì€ AI íŠœí„°ì˜ ë™ì‘ì„ ì œì–´í•˜ëŠ” ë‚´ë¶€ ì§€ì‹œì‚¬í•­ìœ¼ë¡œ, í•™ìƒì—ê²ŒëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="flex items-center space-x-2">
                                            <span>ğŸ“ ìˆ˜ì—… ì„¤ëª…</span>
                                            <span
                                                class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">í•™ìƒì—ê²Œ
                                                í‘œì‹œ</span>
                                        </span>
                                    </label>
                                    <textarea id="edit-lesson-student-description" rows="3" placeholder="í•™ìƒë“¤ì´ ë³¼ ìˆ˜ ìˆëŠ” ìˆ˜ì—… ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.

ì˜ˆì‹œ:
â€¢ ì˜¤ëŠ˜ì€ ì¡°ì„ ì‹œëŒ€ ë°±ì„±ë“¤ì˜ ì¼ìƒìƒí™œê³¼ ë¬¸í™”ì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤.
â€¢ ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆì„ ì‹¤ìƒí™œ ì˜ˆì‹œì™€ í•¨ê»˜ ë°°ì›Œë´…ì‹œë‹¤.
â€¢ ì‹ë¬¼ì˜ ê´‘í•©ì„± ê³¼ì •ê³¼ ìš°ë¦¬ ìƒí™œì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ íƒêµ¬í•©ë‹ˆë‹¤."
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
                                    <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                        <p class="text-xs text-blue-700">
                                            <strong>ğŸ’¡ íŒ:</strong> í•™ìƒë“¤ì´ ìˆ˜ì—…ì— ì ‘ì†í•  ë•Œ ë³¼ ìˆ˜ ìˆëŠ” ì„¤ëª…ì…ë‹ˆë‹¤. í•™ìŠµ ëª©í‘œì™€ ë‚´ìš©ì„ ê°„ë‹¨ëª…ë£Œí•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
                                        </p>
                                    </div>
                                </div>

                                <!-- í•™ìŠµ ìë£Œ ê´€ë¦¬ ì„¹ì…˜ (í¸ì§‘ ëª¨ë‹¬) -->
                                <div class="border-t pt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <span class="flex items-center space-x-2">
                                            <span>ğŸ“š í•™ìŠµ ìë£Œ ë° íŒíŠ¸</span>
                                            <span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">ìƒˆ
                                                ê¸°ëŠ¥</span>
                                        </span>
                                    </label>
                                    <p class="text-xs text-gray-600 mb-3">í•™ìƒë“¤ì´ ë§‰í ë•Œ AI íŠœí„°ê°€ ì œê³µí•  ë³´ì¶© ìë£Œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”.</p>

                                    <!-- ìë£Œ ì¶”ê°€ ë²„íŠ¼ë“¤ -->
                                    <div class="flex space-x-3 mb-3">
                                        <button type="button" id="edit-add-link-btn"
                                            class="px-3 py-1.5 text-sm bg-blue-50 text-blue-700 border border-blue-200 rounded-md hover:bg-blue-100 font-medium">
                                            ğŸ”— ì›¹ ë§í¬ ì¶”ê°€
                                        </button>
                                        <button type="button" id="edit-add-file-btn"
                                            class="px-3 py-1.5 text-sm bg-green-50 text-green-700 border border-green-200 rounded-md hover:bg-green-100 font-medium">
                                            ğŸ“ íŒŒì¼ ì—…ë¡œë“œ
                                        </button>
                                    </div>

                                    <!-- ì¶”ê°€ëœ ìë£Œ ëª©ë¡ -->
                                    <div id="edit-resources-list" class="space-y-2 mb-3">
                                        <!-- ìë£Œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                    </div>

                                    <!-- ë§í¬ ì¶”ê°€ ì…ë ¥ ì˜ì—­ (ìˆ¨ê¹€ ìƒíƒœ) -->
                                    <div id="edit-link-input-area" class="hidden p-3 bg-gray-50 rounded-md mb-3">
                                        <div class="flex space-x-2">
                                            <input type="text" id="edit-link-title-input"
                                                placeholder="ë§í¬ ì œëª© (ì˜ˆ: ê°œë… ì„¤ëª… ì˜ìƒ)"
                                                class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                            <input type="url" id="edit-link-url-input" placeholder="https://..."
                                                class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                            <button type="button" id="edit-save-link-btn"
                                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                                ì¶”ê°€
                                            </button>
                                            <button type="button" id="edit-cancel-link-btn"
                                                class="px-3 py-1 text-sm bg-gray-400 text-white rounded-md hover:bg-gray-500">
                                                ì·¨ì†Œ
                                            </button>
                                        </div>
                                    </div>

                                    <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ (ìˆ¨ê¹€ ìƒíƒœ) -->
                                    <div id="edit-file-upload-area" class="hidden p-3 bg-gray-50 rounded-md mb-3">
                                        <div class="space-y-2">
                                            <input type="file" id="edit-file-input"
                                                accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.jpeg,.png"
                                                class="text-sm file:mr-3 file:px-3 file:py-1 file:rounded-md file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                            <div class="flex space-x-2">
                                                <button type="button" id="edit-upload-file-btn"
                                                    class="px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                                    ì—…ë¡œë“œ
                                                </button>
                                                <button type="button" id="edit-cancel-file-btn"
                                                    class="px-3 py-1 text-sm bg-gray-400 text-white rounded-md hover:bg-gray-500">
                                                    ì·¨ì†Œ
                                                </button>
                                            </div>
                                            <div id="edit-upload-progress" class="hidden">
                                                <div class="text-xs text-gray-600 mb-1">ì—…ë¡œë“œ ì¤‘...</div>
                                                <div class="w-full bg-gray-200 rounded-full h-1.5">
                                                    <div id="edit-upload-progress-bar"
                                                        class="bg-blue-600 h-1.5 rounded-full transition-all"
                                                        style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center pt-4 border-t">
                                    <button type="button" id="delete-lesson-btn"
                                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 font-medium">
                                        ìˆ˜ì—… ì‚­ì œ
                                    </button>
                                    <div class="flex space-x-3">
                                        <button type="button" id="cancel-edit-btn"
                                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 font-medium">
                                            ì·¨ì†Œ
                                        </button>
                                        <button type="submit" id="save-lesson-btn"
                                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                            ìˆ˜ì • ì™„ë£Œ
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- í”„ë¡¬í”„íŠ¸ ì„¤ì • ì„¹ì…˜ -->
                    <div id="prompts-section" class="hidden">
                        <div class="mb-6">
                            <h1 class="text-2xl font-bold text-gray-900">AI íŠœí„° í”„ë¡¬í”„íŠ¸ ì„¤ì •</h1>
                            <p class="text-gray-600 mt-2">ê³¼ëª©ë³„ë¡œ í•™ìƒ ì‘ë‹µ ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ AI íŠœí„° ì „ëµì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>

                        <!-- ê³¼ëª© ì„ íƒ ì¹´ë“œ -->
                        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">ê³¼ëª© ì„ íƒ</h2>
                                    <p class="text-gray-600 text-sm mt-1">ë¨¼ì € ì„¤ì •í•  ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4">
                                <label class="block text-sm font-medium text-gray-700">ê³¼ëª© ì„ íƒ</label>
                                <select id="prompt-subject-select"
                                    class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    <option value="">ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="korean">êµ­ì–´</option>
                                    <option value="math">ìˆ˜í•™</option>
                                    <option value="social">ì‚¬íšŒ</option>
                                    <option value="science">ê³¼í•™</option>
                                    <option value="counseling">ìƒë‹´/ê°ì •ì¼€ì–´</option>
                                </select>
                            </div>
                            <p class="text-xs text-gray-600 mt-2">ì„ íƒí•œ ê³¼ëª©ì— ë§ëŠ” í•™ìƒ ì‘ë‹µ ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>

                        <!-- ì„ íƒ ì•ˆë‚´ ë©”ì‹œì§€ -->
                        <div id="no-subject-selected"
                            class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-8 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
                            <p class="mt-1 text-sm text-gray-500">ìœ„ì—ì„œ ê³¼ëª©ì„ ì„ íƒí•˜ì‹œë©´ í•´ë‹¹ ê³¼ëª©ì˜ AI íŠœí„° í”„ë¡¬í”„íŠ¸ ì„¤ì •ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                        </div>

                        <!-- ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ ì„¤ì • ì¹´ë“œ -->
                        <div id="adaptive-prompt-settings-section"
                            class="bg-white rounded-lg shadow-sm border p-6 hidden">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">ìœ í˜•ë³„ AI íŠœí„° í”„ë¡¬í”„íŠ¸ ì„¤ì •</h2>
                                    <p class="text-gray-600 text-sm mt-1">í•™ìƒ ì‘ë‹µ ìœ í˜•ì— ë”°ë¼ ë‹¤ë¥¸ AI íŠœí„° ì „ëµì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button id="reset-adaptive-prompts-btn"
                                        class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                                        ëª¨ë‘ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <!-- ë™ì  íƒ­ ë„¤ë¹„ê²Œì´ì…˜ê³¼ ì»¨í…ì¸ ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                                <div class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                        <!-- ë™ì  íƒ­ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                                    </nav>
                                </div>

                                <!-- ë™ì  íƒ­ ì»¨í…ì¸ ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->

                                <div class="flex justify-end space-x-3 mt-6">
                                    <button id="save-adaptive-prompts-btn"
                                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                                        ëª¨ë“  í”„ë¡¬í”„íŠ¸ ì €ì¥
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- í•™ìƒ ëŒ€í™” ë¶„ì„ ì„¹ì…˜ -->
                    <div id="students-section" class="hidden">
                        <div class="mb-6">
                            <h1 class="text-2xl font-bold text-gray-900">í•™ìƒ ëŒ€í™” ë¶„ì„</h1>
                            <p class="text-gray-600 mt-2">í•™ìƒë“¤ì˜ AI íŠœí„° ëŒ€í™” ê¸°ë¡ì„ í™•ì¸í•˜ê³  ë¶„ì„ ê²°ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>

                        <!-- ìˆ˜ì—… ì„ íƒ -->
                        <div class="bg-white rounded-lg shadow-sm border mb-6">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-lg font-semibold text-gray-800">ìˆ˜ì—… ì„ íƒ</h2>
                                    <button id="refresh-lessons-for-analysis-btn"
                                        class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                                        ìƒˆë¡œê³ ì¹¨
                                    </button>
                                </div>
                            </div>

                            <div class="p-6">
                                <div id="analysis-lessons-loading" class="text-center py-8 hidden">
                                    <div
                                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                    </div>
                                    <p class="text-gray-600 mt-2">ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                </div>

                                <div id="analysis-lessons-empty" class="text-center py-8 hidden">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                        </path>
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900">ì•„ì§ ìƒì„±ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                                    <p class="mt-1 text-sm text-gray-500">ìˆ˜ì—…ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.</p>
                                </div>

                                <div id="analysis-lessons-list"
                                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <!-- ìˆ˜ì—… ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>

                        <!-- í•™ìƒ ì„¸ì…˜ ëª©ë¡ -->
                        <div id="lesson-students-section" class="bg-white rounded-lg shadow-sm border hidden">
                            <div class="p-6 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 class="text-lg font-semibold text-gray-800" id="selected-lesson-title">ìˆ˜ì—…ëª…
                                        </h2>
                                        <p class="text-sm text-gray-600" id="selected-lesson-info">ìˆ˜ì—… ì •ë³´</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="relative" id="bulk-download-dropdown">
                                            <button id="bulk-download-btn"
                                                class="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 font-medium flex items-center space-x-2">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                                    </path>
                                                </svg>
                                                <span>ì¼ê´„ ë‹¤ìš´ë¡œë“œ</span>
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </button>
                                            <div id="bulk-download-menu"
                                                class="hidden absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-10">
                                                <div class="py-1">
                                                    <a href="#" id="download-all-lessons"
                                                        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <span id="download-all-lessons-text">ğŸ“Š ì´ ìˆ˜ì—… ë°ì´í„° (CSV)</span>
                                                    </a>
                                                    <a href="#" id="download-lesson-summary"
                                                        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        ğŸ“‹ ì´ ìˆ˜ì—… ìš”ì•½ ë³´ê³ ì„œ
                                                    </a>
                                                    <a href="#" id="download-participation-report"
                                                        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        ğŸ“ˆ í•™ìƒ ì°¸ì—¬ë„ ë¶„ì„
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <button id="back-to-lessons-btn"
                                            class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium">
                                            ìˆ˜ì—… ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="p-6">
                                <div id="lesson-students-loading" class="text-center py-8 hidden">
                                    <div
                                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                    </div>
                                    <p class="text-gray-600 mt-2">í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                </div>

                                <div id="lesson-students-empty" class="text-center py-8 hidden">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                        </path>
                                    </svg>
                                    <h3 class="mt-2 text-sm font-medium text-gray-900">ì´ ìˆ˜ì—…ì— ì°¸ì—¬í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</h3>
                                    <p class="mt-1 text-sm text-gray-500">í•™ìƒë“¤ì´ AI íŠœí„°ë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>

                                <div id="lesson-students-list" class="space-y-3">
                                    <!-- í•™ìƒ ì„¸ì…˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>

                        <!-- ì„ íƒëœ í•™ìƒì˜ ëŒ€í™” ìƒì„¸ -->
                        <div id="conversation-detail" class="hidden mt-6">
                            <div class="bg-white rounded-lg shadow-sm border">
                                <div class="p-6 border-b border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h2 class="text-lg font-semibold text-gray-800" id="selected-student-name">
                                                í•™ìƒ ëŒ€í™” ë‚´ìš©</h2>
                                            <p class="text-sm text-gray-600" id="selected-session-info">ì„¸ì…˜ ì •ë³´</p>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            <button id="analyze-conversation-btn"
                                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">
                                                AI ë¶„ì„ ìƒì„±
                                            </button>
                                            <button id="close-conversation-btn"
                                                class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                                ë‹«ê¸°
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-6 space-y-8">
                                    <!-- ëŒ€í™” ê¸°ë¡ -->
                                    <div>
                                        <h3 class="text-md font-semibold text-gray-800 mb-4">ëŒ€í™” ê¸°ë¡</h3>
                                        <div id="conversation-messages"
                                            class="max-h-96 overflow-y-auto bg-gray-50 rounded-lg p-4 space-y-3">
                                            <!-- ëŒ€í™” ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                        </div>
                                    </div>

                                    <!-- AI ë¶„ì„ ê²°ê³¼ -->
                                    <div>
                                        <div class="flex items-center justify-between mb-4">
                                            <h3 class="text-md font-semibold text-gray-800">AI ë¶„ì„ ê²°ê³¼</h3>
                                            <div class="flex items-center space-x-2" id="analysis-actions"
                                                style="display: none;">
                                                <button id="copy-analysis-btn"
                                                    class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                                        </path>
                                                    </svg>
                                                    <span>ë³µì‚¬</span>
                                                </button>
                                                <button id="download-analysis-btn"
                                                    class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded-md hover:bg-green-200 font-medium flex items-center space-x-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                                        </path>
                                                    </svg>
                                                    <span>CSV ë‹¤ìš´ë¡œë“œ</span>
                                                </button>
                                            </div>
                                        </div>

                                        <div id="analysis-content"
                                            class="bg-gray-50 rounded-lg p-4 min-h-32 whitespace-pre-wrap">
                                            <p class="text-gray-600 italic">ë¶„ì„ì„ ìƒì„±í•˜ë ¤ë©´ 'AI ë¶„ì„ ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                                        </div>

                                        <div id="analysis-loading"
                                            class="hidden bg-gray-50 rounded-lg p-4 min-h-32 flex items-center justify-center">
                                            <div class="text-center">
                                                <div
                                                    class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600">
                                                </div>
                                                <p class="text-gray-600 mt-2">AIê°€ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
                    <div id="status-message" class="mt-6 p-4 rounded-md hidden">
                        <!-- ìƒíƒœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            import {
                signInWithPopup,
                GoogleAuthProvider,
                signOut,
                onAuthStateChanged
            } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
            import { httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
            import { ref, uploadBytesResumable, getDownloadURL, getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
            import { auth, functions } from './firebase-config.js';

            // Storageë¥¼ ì§ì ‘ ì´ˆê¸°í™”
            const storage = getStorage();

            // Firebase Functions
            const updateTeacherApiKey = httpsCallable(functions, 'updateTeacherApiKey');
            const getTeacherSettings = httpsCallable(functions, 'getTeacherSettings');
            const updateTeacherModel = httpsCallable(functions, 'updateTeacherModel');
            const updateTeacherPrompts = httpsCallable(functions, 'updateTeacherPrompts');
            const getSubjectResponseTypes = httpsCallable(functions, 'getSubjectResponseTypes');
            const createLesson = httpsCallable(functions, 'createLesson');
            const getLessons = httpsCallable(functions, 'getLessons');
            const getStudentSessions = httpsCallable(functions, 'getStudentSessions');
            const getStudentConversation = httpsCallable(functions, 'getStudentConversation');
            const analyzeStudentConversations = httpsCallable(functions, 'analyzeStudentConversations');
            const deleteSession = httpsCallable(functions, 'deleteSession');

            // DOM ìš”ì†Œë“¤
            const loginScreen = document.getElementById('login-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const loginLoading = document.getElementById('login-loading');
            const logoutBtn = document.getElementById('logout-btn');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');

            const apiSetupForm = document.getElementById('api-setup-form');
            const apiConfigured = document.getElementById('api-configured');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const updateApiKeyBtn = document.getElementById('update-api-key-btn');
            const apiStatus = document.getElementById('api-status');

            const teacherCodeSection = document.getElementById('teacher-code-section');
            const teacherCodeDisplay = document.getElementById('teacher-code-display');
            const copyCodeBtn = document.getElementById('copy-code-btn');
            const statusMessage = document.getElementById('status-message');

            // ìƒˆë¡œìš´ ì„¤ì • ìš”ì†Œë“¤
            const modelSettingsSection = document.getElementById('model-settings-section');
            const modelSelect = document.getElementById('model-select');
            const saveModelBtn = document.getElementById('save-model-btn');

            const adaptivePromptSettingsSection = document.getElementById('adaptive-prompt-settings-section');
            const saveAdaptivePromptsBtn = document.getElementById('save-adaptive-prompts-btn');
            const resetAdaptivePromptsBtn = document.getElementById('reset-adaptive-prompts-btn');

            // íƒ­ ë²„íŠ¼ë“¤
            const promptTabBtns = document.querySelectorAll('.prompt-tab-btn');
            const promptTabContents = document.querySelectorAll('.prompt-tab-content');

            // ì „ì—­ ë³€ìˆ˜ë“¤
            let currentSettings = null;
            let currentTab = 'DEFAULT';
            let currentSubjectResponseTypes = null;
            let currentSelectedSubject = '';

            // í”„ë¡¬í”„íŠ¸ ì„¤ì • ê´€ë ¨ ìš”ì†Œë“¤
            const promptSubjectSelect = document.getElementById('prompt-subject-select');

            // ê³¼ëª© ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            promptSubjectSelect.addEventListener('change', async (e) => {
                const selectedSubject = e.target.value;
                if (selectedSubject) {
                    // ì„ íƒ ì•ˆë‚´ ë©”ì‹œì§€ ìˆ¨ê¹€
                    document.getElementById('no-subject-selected').classList.add('hidden');
                    // í”„ë¡¬í”„íŠ¸ ì„¤ì • ì¹´ë“œ í‘œì‹œ
                    adaptivePromptSettingsSection.classList.remove('hidden');

                    await loadSubjectResponseTypes(selectedSubject);
                } else {
                    // ê³¼ëª© ì„ íƒ í•´ì œ ì‹œ ê¸°ë³¸ ìƒíƒœë¡œ ëŒì•„ê°
                    document.getElementById('no-subject-selected').classList.remove('hidden');
                    adaptivePromptSettingsSection.classList.add('hidden');
                    clearPromptTabs();
                }
            });

            // ê³¼ëª© ì´ë¦„ ë§¤í•‘
            const subjectNames = {
                'korean': 'êµ­ì–´',
                'math': 'ìˆ˜í•™',
                'science': 'ê³¼í•™',
                'social': 'ì‚¬íšŒ',
                'counseling': 'ìƒë‹´/ê°ì •ì¼€ì–´'
            };

            // ì‚¬ê³ ë ¥ ì¦ì§„ í…œí”Œë¦¿ ëª¨ë“œ ë°ì´í„°
            const THINKING_MODES = {
                inquiry: {
                    id: 'inquiry',
                    name: 'ğŸ” íƒêµ¬ ëª¨ë“œ',
                    subtitle: 'Inquiry Mode',
                    description: 'ê³¼í•™ì  íƒêµ¬ë‚˜ ì‚¬íšŒ í˜„ìƒ íƒêµ¬ì—ì„œ AIê°€ ì„ ë°° ì—°êµ¬ì› ì—­í• ',
                    subjects: ['science', 'social'],
                    difficulty: 'ì¤‘ê¸‰',
                    keywords: ['íƒêµ¬', 'ê´€ì°°', 'ê°€ì„¤', 'ì‹¤í—˜', 'ê²€ì¦'],
                    template: `**ì—­í• **: ë„ˆëŠ” í˜¸ê¸°ì‹¬ ë§ê³  ì¹œì ˆí•œ ì„ ë°° ê³¼í•™ íƒí—˜ê°€ì•¼.

**ëª©í‘œ**: í•™ìƒì´ '{í•™ìŠµì£¼ì œ}'ì— ëŒ€í•´ ìŠ¤ìŠ¤ë¡œ íƒêµ¬ ì§ˆë¬¸ì„ ë§Œë“¤ê³ , ê°€ì„¤ì„ ì„¸ìš°ë©°, ê°„ë‹¨í•œ ì‹¤í—˜ì„ ì„¤ê³„í•˜ì—¬ ê²°ë¡ ì„ ë‚´ë¦¬ëŠ” ê³¼ì •ì„ ì™„ì„±í•˜ë„ë¡ ë„ì™€ì•¼ í•´.

**í•µì‹¬ ê·œì¹™**:
1. ì ˆëŒ€ë¡œ ì •ë‹µì„ ì§ì ‘ ì•Œë ¤ì£¼ë©´ ì•ˆ ë¼.
2. í•­ìƒ í•™ìƒì˜ ê´€ì°°ê³¼ ìƒê°ì—ì„œ ì¶œë°œí•´ì•¼ í•´. "ë¬´ì—‡ì„ ë°œê²¬í–ˆë‹ˆ?", "ì™œ ê·¸ë ‡ê²Œ ìƒê°í–ˆì–´?" ì™€ ê°™ì´ ì§ˆë¬¸í•´ì¤˜.
3. í•™ìƒì´ ë§‰ë§‰í•´í•˜ë©´, "ë‹¤ë¥¸ ì¡°ê±´ì„ ìƒê°í•´ë³¼ê¹Œ?", "ë§Œì•½ ë‹¤ë¥¸ ìƒí™©ì´ë¼ë©´ ì–´ë–»ê²Œ ë ê¹Œ?" ì™€ ê°™ì´ ì‚¬ê³ ë¥¼ í™•ì¥í•˜ëŠ” íŒíŠ¸ë¥¼ ì§ˆë¬¸ í˜•íƒœë¡œ ì œê³µí•´.
4. ëª¨ë“  ë‹µë³€ì€ ë°˜ë“œì‹œ í•™ìƒì˜ ë‹¤ìŒ í–‰ë™ì´ë‚˜ ìƒê°ì„ ìœ ë„í•˜ëŠ” ì§ˆë¬¸ìœ¼ë¡œ ëë‚˜ì•¼ í•´.

**ìƒí˜¸ì‘ìš© ë°©ì‹**: í•™ìƒì˜ ì–´ë–¤ ê°€ì„¤ì´ë“  "ì•„ì£¼ í¥ë¯¸ë¡œìš´ ìƒê°ì´ì•¼!", "ê·¸ë ‡ê²Œ ìƒê°í•´ ë³¼ ìˆ˜ë„ ìˆê² êµ¬ë‚˜!" ì™€ ê°™ì´ ê¸ì •ì ìœ¼ë¡œ ë°˜ì‘í•˜ë©° íƒêµ¬ ì˜ìš•ì„ ë¶ë‹ì•„ ì¤˜.

**í•™ìŠµ ë‚´ìš©**: ì´ íƒêµ¬ì˜ í•µì‹¬ ê°œë…ë“¤ì„ ì§ì ‘ ì‚¬ìš©í•˜ê¸°ë³´ë‹¤ëŠ” í•™ìƒì´ ê²½í—˜ê³¼ ê´€ì°°ì„ í†µí•´ ì´ ê°œë…ë“¤ì„ ìŠ¤ìŠ¤ë¡œ ì„¤ëª…í•˜ê²Œ ìœ ë„í•´ì¤˜.`
                },
                debate: {
                    id: 'debate',
                    name: 'ğŸ’¬ í† ë¡  ëª¨ë“œ',
                    subtitle: 'Debate Mode',
                    description: 'ì‚¬íšŒì  ìŸì ì´ë‚˜ ë¬¸í•™ í•´ì„ì—ì„œ AIê°€ ì¤‘ë¦½ì  í† ë¡  ì§„í–‰ì ì—­í• ',
                    subjects: ['social', 'korean'],
                    difficulty: 'ê³ ê¸‰',
                    keywords: ['í† ë¡ ', 'ë…¼ë¦¬', 'ê·¼ê±°', 'ë°˜ë°•', 'ê· í˜•'],
                    template: `**ì—­í• **: ë„ˆëŠ” ë…¼ë¦¬ì ì´ê³  ê³µì •í•œ í† ë¡  ì§„í–‰ì(ëª¨ë”ë ˆì´í„°)ì•¼.

**ëª©í‘œ**: í•™ìƒì´ '{í•™ìŠµì£¼ì œ}'ë¼ëŠ” ë…¼ì œì— ëŒ€í•´ ìì‹ ì˜ ì…ì¥ì„ ì •í•˜ê³ , íƒ€ë‹¹í•œ ê·¼ê±°ë¥¼ ë“¤ì–´ ì£¼ì¥ì„ í¼ì¹˜ëŠ” ëŠ¥ë ¥ì„ ê¸°ë¥´ë„ë¡ ë„ì™€ì•¼ í•´.

**í•µì‹¬ ê·œì¹™**:
1. ë„ˆì˜ ì˜ê²¬ì„ ë“œëŸ¬ë‚´ì§€ ë§ê³  í•­ìƒ ì¤‘ë¦½ì„ ì§€ì¼œì•¼ í•´.
2. í•™ìƒì˜ ì£¼ì¥ì— ëŒ€í•´ í•­ìƒ "ì™œ ê·¸ë ‡ê²Œ ìƒê°í•˜ë‹ˆ? ë„ˆì˜ ì£¼ì¥ì„ ë’·ë°›ì¹¨í•˜ëŠ” ê·¼ê±°ë‚˜ ì˜ˆì‹œê°€ ìˆì„ê¹Œ?"ë¼ê³  ì§ˆë¬¸í•˜ë©° ê·¼ê±°ë¥¼ ìš”êµ¬í•´ì•¼ í•´.
3. í•™ìƒì´ í•œìª½ìœ¼ë¡œ ì¹˜ìš°ì¹œ ì£¼ì¥ì„ í•˜ë©´, "ë„¤ ì˜ê²¬ê³¼ ë‹¤ë¥¸ ê´€ì ë„ ìˆì–´. ì˜ˆë¥¼ ë“¤ì–´..." ì™€ ê°™ì´ ê· í˜• ì¡íŒ ë°˜ëŒ€ ê´€ì ì„ ì œì‹œí•˜ì—¬ ì‚¬ê³ ë¥¼ ìê·¹í•´ì•¼ í•´.
4. í† ë¡  ë§ˆì§€ë§‰ì—ëŠ” í•™ìƒì˜ ì£¼ì¥ê³¼ ê·¼ê±°ë¥¼ ê°„ëµí•˜ê²Œ ìš”ì•½í•´ì£¼ê³ , "ì˜¤ëŠ˜ í† ë¡ ì„ í†µí•´ ì–´ë–¤ ìƒê°ì´ ë” ëª…í™•í•´ì¡Œë‹ˆ?"ë¼ê³  ë¬¼ìœ¼ë©° ì„±ì°°ì˜ ê¸°íšŒë¥¼ ì¤˜.

**ìƒí˜¸ì‘ìš© ë°©ì‹**: ì°¨ë¶„í•˜ê³  ì´ì„±ì ì¸ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ë©°, í•™ìƒì˜ ì˜ê²¬ì„ ì¡´ì¤‘í•˜ëŠ” íƒœë„ë¥¼ ë³´ì—¬ì¤˜.

**í•™ìŠµ ë‚´ìš©**: ì´ í† ë¡ ì—ì„œ í•™ìƒë“¤ì´ ë‹¤ì–‘í•œ ê°€ì¹˜ë¥¼ ê³ ë ¤í•˜ë©° í† ë¡ í•˜ë„ë¡ ìœ ë„í•´ì¤˜.`
                },
                problemSolving: {
                    id: 'problemSolving',
                    name: 'ğŸ§© ë¬¸ì œí•´ê²° ëª¨ë“œ',
                    subtitle: 'Problem-Solving Mode',
                    description: 'ìˆ˜í•™/ì½”ë”© ë¬¸ì œì—ì„œ AIê°€ í˜ì–´ í”„ë¡œê·¸ë˜ë¨¸ë‚˜ ìˆ˜í•™ ì½”ì¹˜ ì—­í• ',
                    subjects: ['math'],
                    difficulty: 'ì¤‘ê¸‰',
                    keywords: ['ë¬¸ì œí•´ê²°', 'ë‹¨ê³„', 'ê³„íš', 'ê²€í† ', 'í´ë¦¬ì•„'],
                    template: `**ì—­í• **: ë„ˆëŠ” ì¹œì ˆí•˜ê³  ì¸ë‚´ì‹¬ ìˆëŠ” ìˆ˜í•™ ë¬¸ì œ í•´ê²° ì½”ì¹˜ì•¼. í´ë¦¬ì•„ì˜ ë¬¸ì œ í•´ê²° 4ë‹¨ê³„ë¥¼ ì™„ë²½íˆ ì´í•´í•˜ê³  ìˆì–´.

**ëª©í‘œ**: í•™ìƒì´ '{í•™ìŠµì£¼ì œ}' ë¬¸ì œë¥¼ ìŠ¤ìŠ¤ë¡œ í’€ ìˆ˜ ìˆë„ë¡ ë„ì™€ì•¼ í•´.

**í•µì‹¬ ê·œì¹™**:
1. ì ˆëŒ€ ë‹µì´ë‚˜ ê³„ì‚° ê³¼ì •ì„ ì§ì ‘ ë³´ì—¬ì£¼ë©´ ì•ˆ ë¼. í•™ìƒì´ ê³„ì‚° ì‹¤ìˆ˜ë¥¼ í•´ë„ "ì–´ë””ì„œ í‹€ë ¸ë„¤"ë¼ê³  ë§í•˜ì§€ ë§ê³ , "ê³„ì‚° ê³¼ì •ì„ ë‹¤ì‹œ í•œë²ˆ ì°¨ê·¼ì°¨ê·¼ ì‚´í´ë³¼ê¹Œ?"ë¼ê³  ìœ ë„í•´ì•¼ í•´.
2. ë°˜ë“œì‹œ í´ë¦¬ì•„ì˜ 4ë‹¨ê³„(ë¬¸ì œ ì´í•´ â†’ ê³„íš ìˆ˜ë¦½ â†’ ê³„íš ì‹¤í–‰ â†’ ë°˜ì„±)ì— ë”°ë¼ ì§ˆë¬¸í•´ì•¼ í•´.
   - (1ë‹¨ê³„) "ì´ ë¬¸ì œì—ì„œ ìš°ë¦¬ê°€ êµ¬í•´ì•¼ í•  ê²ƒì€ ë¬´ì—‡ì´ì§€? ì£¼ì–´ì§„ ì •ë³´ëŠ” ë¬´ì—‡ì´ ìˆì„ê¹Œ?"
   - (2ë‹¨ê³„) "ì´ ë¬¸ì œë¥¼ í’€ê¸° ìœ„í•´ ì–´ë–¤ ë°©ë²•ë¶€í„° ì‹œì‘í•´ë³¼ ìˆ˜ ìˆì„ê¹Œ? ê·¸ë¦¼ì„ ê·¸ë ¤ë³¼ê¹Œ?"
   - (3ë‹¨ê³„) "ì¢‹ì€ ê³„íšì´ì•¼. ê·¸ ê³„íšëŒ€ë¡œ í•œë²ˆ ì°¨ê·¼ì°¨ê·¼ ê³„ì‚°í•´ë³¼ë˜?"
   - (4ë‹¨ê³„) "ì •ë‹µì„ êµ¬í–ˆêµ¬ë‚˜! ì–´ë–»ê²Œ ê·¸ ë‹µì´ ë‚˜ì™”ëŠ”ì§€ ì„¤ëª…í•´ì¤„ ìˆ˜ ìˆë‹ˆ? ë‹¤ë¥¸ ë°©ë²•ì€ ì—†ì„ê¹Œ?"

**ìƒí˜¸ì‘ìš© ë°©ì‹**: í•™ìƒì´ ë§‰ë§‰í•´í•  ë•Œ "ê´œì°®ì•„, ì–´ë ¤ìš´ ë¬¸ì œëŠ” ì›ë˜ í•œ ë²ˆì— í’€ë¦¬ì§€ ì•Šì•„. ìš°ë¦¬ í•¨ê»˜ ë‹¨ì„œë¥¼ ì°¾ì•„ë³´ì" ì™€ ê°™ì´ ê²©ë ¤í•˜ëŠ” ë§íˆ¬ë¥¼ ì‚¬ìš©í•´.

**í•™ìŠµ ë‚´ìš©**: ì´ ë¬¸ì œì˜ í•µì‹¬ ê°œë…ë“¤ì˜ ê´€ê³„ë¥¼ í•™ìƒì´ ìŠ¤ìŠ¤ë¡œ ë°œê²¬í•˜ë„ë¡ ì§ˆë¬¸ì„ ì„¤ê³„í•´ì¤˜.`
                },
                creative: {
                    id: 'creative',
                    name: 'ğŸ¨ ì°½ì‘ ëª¨ë“œ',
                    subtitle: 'Creative Mode',
                    description: 'ê¸€ì§“ê¸°, ê·¸ë¦¼ ê·¸ë¦¬ê¸° ë“±ì—ì„œ AIê°€ ì˜ê°ì˜ ì›ì²œ ì—­í• ',
                    subjects: ['korean'],
                    difficulty: 'ì´ˆê¸‰',
                    keywords: ['ì°½ì‘', 'ìƒìƒë ¥', 'ì•„ì´ë””ì–´', 'í‘œí˜„', 'ì˜ê°'],
                    template: `**ì—­í• **: ë„ˆëŠ” ìƒìƒë ¥ì´ í’ë¶€í•˜ê³  ê¸ì •ì ì¸ ì•„ì´ë””ì–´ íŒŒíŠ¸ë„ˆì•¼.

**ëª©í‘œ**: í•™ìƒì´ '{í•™ìŠµì£¼ì œ}'ë¼ëŠ” ì£¼ì œë¡œ ì°½ì‘ í™œë™ì„ í•  ìˆ˜ ìˆë„ë¡ ìƒìƒë ¥ì„ ìê·¹í•˜ê³  ì•„ì´ë””ì–´ë¥¼ êµ¬ì²´í™”í•˜ëŠ” ê²ƒì„ ë„ì™€ì•¼ í•´.

**í•µì‹¬ ê·œì¹™**:
1. ì ˆëŒ€ í•™ìƒì˜ ì•„ì´ë””ì–´ë¥¼ "ê·¸ê±´ ì¢€ ì´ìƒí•œë°" ì™€ ê°™ì´ ë¹„íŒí•˜ê±°ë‚˜ í‰ê°€í•˜ë©´ ì•ˆ ë¼.
2. í•­ìƒ "ì™€, ì •ë§ ì¬ë¯¸ìˆëŠ” ìƒê°ì´ë‹¤! ë” ìì„¸íˆ ì´ì•¼ê¸°í•´ì¤„ë˜?" ì™€ ê°™ì´ ê¸ì •ì ìœ¼ë¡œ ë°˜ì‘í•´ì•¼ í•´.
3. í•™ìƒì˜ ì´ì•¼ê¸°ê°€ ë§‰íˆë©´, ìƒˆë¡œìš´ ê´€ì ì˜ ì§ˆë¬¸ì„ ë˜ì ¸ì¤˜.
4. ì˜¤ê°ì„ í™œìš©í•˜ëŠ” ì§ˆë¬¸ì„ ë˜ì ¸ì¤˜. "ê·¸ ì¥ì†Œì—ì„œëŠ” ì–´ë–¤ ì†Œë¦¬ê°€ ë“¤ë¦´ê¹Œ?", "ê·¸ë•Œ ê¸°ë¶„ì€ ì–´ë–¨ê¹Œ?"

**ìƒí˜¸ì‘ìš© ë°©ì‹**: ì¦ê²ê³  ìœ ì¾Œí•œ ë§íˆ¬ë¡œ í•™ìƒì˜ ì°½ì˜ì ì¸ ì‹œë„ë¥¼ ì¹­ì°¬í•˜ê³  ê²©ë ¤í•´ì¤˜.

**í•™ìŠµ ë‚´ìš©**: ì´ í™œë™ì˜ í•µì‹¬ì€ ë…¼ë¦¬ë³´ë‹¤ëŠ” 'ì°½ì˜ì„±'ê³¼ 'í‘œí˜„ë ¥'ì´ì•¼. í•™ìƒì´ ììœ ë¡­ê²Œ ìƒìƒì˜ ë‚˜ë˜ë¥¼ í¼ì¹˜ë„ë¡ ìµœëŒ€í•œ í—ˆìš©ì ì¸ ë¶„ìœ„ê¸°ë¥¼ ë§Œë“¤ì–´ì¤˜.`
                },
                rolePlaying: {
                    id: 'rolePlaying',
                    name: 'ğŸ­ ì—­í• ê·¹ ëª¨ë“œ',
                    subtitle: 'Role-Playing Mode',
                    description: 'AIê°€ ì—­ì‚¬ì  ì¸ë¬¼, ì „ë¬¸ê°€ ë“± íŠ¹ì • ì—­í• ì„ ë§¡ì•„ ìƒí˜¸ì‘ìš©',
                    subjects: ['social', 'korean'],
                    difficulty: 'ê³ ê¸‰',
                    keywords: ['ì—­í• ê·¹', 'ëª°ì…', 'ì¸í„°ë·°', 'ìºë¦­í„°', 'ìƒí™©'],
                    template: `**ì—­í• **: ë„ˆëŠ” '{ì—­í• ì„¤ì •}' ì´ì•¼.

**ëª©í‘œ**: í•™ìƒì´ {ìƒëŒ€ì—­í• }ê°€ ë˜ì–´ ë„ˆì™€ ìƒí˜¸ì‘ìš©í•˜ë©´ì„œ, {í•™ìŠµì£¼ì œ}ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ í•™ìŠµí•˜ë„ë¡ í•´ì•¼ í•´.

**í•µì‹¬ ê·œì¹™**:
1. ë‹µë³€ì€ ë°˜ë“œì‹œ ì„¤ì •ëœ ì¸ë¬¼ì˜ ë§íˆ¬ì™€ ê´€ì ì—ì„œ í•´ì•¼ í•´. í˜„ëŒ€ ê¸°ìˆ ì´ë‚˜ ê°œë…ì— ëŒ€í•´ì„œëŠ” ëª¨ë¥´ëŠ” ì²™í•´ì•¼ í•´.
2. ì—­ì‚¬ì  ì‚¬ì‹¤ì´ë‚˜ ì„¤ì •ì— ê¸°ë°˜í•˜ì—¬ ê°ì •ì„ ë‹´ì•„ ëŒ€ë‹µí•´ì•¼ í•´.
3. ê°ˆë“± ìƒí™©ì´ë‚˜ ì–´ë ¤ì›€ì— ëŒ€í•œ ì§ˆë¬¸ì´ ë‚˜ì˜¤ë©´, ê·¸ ì‹œëŒ€ì˜ ë§¥ë½ì„ ê³ ë ¤í•˜ì—¬ ëŒ€ë‹µí•´.
4. í•™ìƒì´ ë„ˆì˜ ì •ì²´(AI)ì— ëŒ€í•´ ë¬¼ìœ¼ë©´, ëê¹Œì§€ ì—­í• ì„ ìœ ì§€í•´ì•¼ í•´.

**ìƒí˜¸ì‘ìš© ë°©ì‹**: ì„¤ì •ëœ ìºë¦­í„°ì— ë§ëŠ” ì–´ì¡°ì™€ ê°ì •ì„ ì‚¬ìš©í•´ì¤˜.

**í•™ìŠµ ë‚´ìš©**: í•µì‹¬ í•™ìŠµ ë‚´ìš©ì´ ëŒ€í™” ì†ì— ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì•„ë‚˜ë„ë¡ í•´ì¤˜.

**ì¶”ê°€ ì„¤ì • í•„ìš”**: êµ¬ì²´ì ì¸ ì—­í• , ì‹œëŒ€ ë°°ê²½, í•™ìŠµ ëª©í‘œë¥¼ ëª…ì‹œí•´ì£¼ì„¸ìš”.`
                },
                flipped: {
                    id: 'flipped',
                    name: 'ğŸ§‘â€ğŸ« ê±°ê¾¸ë¡œ í•™ìŠµ ëª¨ë“œ',
                    subtitle: 'Flipped Learning Mode',
                    description: 'í•™ìƒì´ ì„ ìƒë‹˜, AIê°€ í•™ìƒì´ ë˜ì–´ ì—­í• ì„ ë°”ê¾¼ í•™ìŠµ',
                    subjects: ['science', 'math', 'social', 'korean'],
                    difficulty: 'ê³ ê¸‰',
                    keywords: ['ë©”íƒ€ì¸ì§€', 'ì„¤ëª…', 'ì—­í• ì „í™˜', 'ì´í•´ì ê²€', 'êµ¬ì¡°í™”'],
                    template: `**ì—­í• **: ë„ˆëŠ” ì˜¤ëŠ˜ ë°°ìš¸ ë‚´ìš©ì— ëŒ€í•´ ì•„ë¬´ëŸ° ì‚¬ì „ ì§€ì‹ì´ ì—†ëŠ”, ì´ëª…í•˜ê³  í˜¸ê¸°ì‹¬ ë§ì€ í•™ìƒì´ì•¼. ë„ˆì˜ ìœ ì¼í•œ ëª©í‘œëŠ” í•™ìƒ ì„ ìƒë‹˜ì˜ ì„¤ëª…ì„ ë“£ê³  ì™„ë²½í•˜ê²Œ ì´í•´í•˜ëŠ” ê²ƒì´ì•¼.

**ëª©í‘œ**: í•™ìƒì´ '{í•™ìŠµì£¼ì œ}'ì— ëŒ€í•´ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ì„¤ëª…í•˜ëŠ” ê³¼ì •ì„ í†µí•´, ìì‹ ì˜ ì´í•´ë„ë¥¼ ìŠ¤ìŠ¤ë¡œ ì ê²€í•˜ê³  ì§€ì‹ì„ ì™„ë²½í•˜ê²Œ ë‚´ì¬í™”í•˜ë„ë¡ ë„ì™€ì•¼ í•´.

**í•µì‹¬ ê·œì¹™**:
1. ë„ˆëŠ” í•™ìƒ ì„ ìƒë‹˜ë³´ë‹¤ ë” ë§ì´ ì•Œì•„ì„œëŠ” ì•ˆ ë¼. ì ˆëŒ€ë¡œ í•™ìƒì´ ì„¤ëª…í•˜ì§€ ì•Šì€ ìƒˆë¡œìš´ ê°œë…ì´ë‚˜ ì •ë³´ë¥¼ ë¨¼ì € ì´ì•¼ê¸°í•˜ë©´ ì•ˆ ë¼.
2. í•™ìƒì˜ ì„¤ëª…ì´ ë¶ˆë¶„ëª…í•˜ê±°ë‚˜ ë…¼ë¦¬ì ìœ¼ë¡œ ê±´ë„ˆë›°ëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´, ìˆœì§„í•˜ê²Œ ì´í•´ê°€ ì•ˆ ëœë‹¤ëŠ” ë“¯ì´ ì§ˆë¬¸í•´ì•¼ í•´.
3. ì¶”ìƒì ì¸ ì„¤ëª…ì´ ë‚˜ì˜¤ë©´ ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ ì˜ˆì‹œë¥¼ ìš”êµ¬í•´ì•¼ í•´.
4. ì¤‘ê°„ì¤‘ê°„ ìì‹ ì´ ì´í•´í•œ ë‚´ìš©ì„ ìš”ì•½í•˜ë©° ë§ëŠ”ì§€ í™•ì¸í•´ì•¼ í•´.
5. ëê¹Œì§€ ë„ˆëŠ” ë°°ìš°ëŠ” í•™ìƒì˜ ì—­í• ì„ ìœ ì§€í•´ì•¼ í•˜ë©°, í•™ìƒì˜ ì„¤ëª…ì„ í‰ê°€í•˜ê±°ë‚˜ ê°€ë¥´ì¹˜ë ¤ ë“¤ë©´ ì•ˆ ë¼.

**ìƒí˜¸ì‘ìš© ë°©ì‹**: í•­ìƒ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ë©°, í•™ìƒ ì„ ìƒë‹˜ì˜ ì„¤ëª…ì— "ì•„, ê·¸ë ‡êµ¬ë‚˜!", "ì •ë§ ì„¤ëª… ì˜í•œë‹¤!" ì™€ ê°™ì´ ê°íƒ„í•˜ê³  ê¸ì •ì ì¸ í”¼ë“œë°±ì„ ì£¼ì–´ í•™ìƒì˜ ìì‹ ê°ì„ ë¶ë‹ì•„ ì¤˜.

**í•™ìŠµ ë‚´ìš©**: í•™ìƒì´ í•µì‹¬ ë‚´ìš©ì„ ëª…í™•íˆ ì„¤ëª…í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë° ëª¨ë“  ì§ˆë¬¸ì„ ì§‘ì¤‘í•´ì¤˜.`
                },
                counseling_basic: {
                    id: 'counseling_basic',
                    name: 'ğŸ’• ê³µê° ìƒë‹´ ëª¨ë“œ',
                    subtitle: 'Empathetic Counseling Mode',
                    description: 'í•™ìƒì˜ ê°ì •ì„ ì½ì–´ì£¼ê³  ê³µê°í•˜ë©° ëŒ€í™”í•˜ëŠ” ìƒë‹´ê°€ ì—­í• ',
                    subjects: ['counseling'],
                    difficulty: 'ì´ˆê¸‰',
                    keywords: ['ê³µê°', 'ê²½ì²­', 'ê°ì •', 'ìœ„ë¡œ', 'ì§€ì§€'],
                    template: `**ì—­í• **: ë„ˆëŠ” ë”°ëœ»í•˜ê³  ê³µê° ëŠ¥ë ¥ì´ ë›°ì–´ë‚œ ì „ë¬¸ ì‹¬ë¦¬ ìƒë‹´ê°€ì•¼.

**ëª©í‘œ**: í•™ìƒì´ ìì‹ ì˜ ê°ì •ì„ í¸ì•ˆí•˜ê²Œ í„¸ì–´ë†“ë„ë¡ í•˜ê³ , ê·¸ ê°ì •ì„ ìˆëŠ” ê·¸ëŒ€ë¡œ ìˆ˜ìš©í•´ì£¼ë©° ì •ì„œì  ì•ˆì •ì„ ì°¾ë„ë¡ ë„ì™€ì•¼ í•´.

**í•µì‹¬ ê·œì¹™**:
1. ì„£ë¶ˆë¦¬ ì¡°ì–¸í•˜ê±°ë‚˜ í•´ê²°ì±…ì„ ì œì‹œí•˜ë ¤ í•˜ì§€ ë§ˆ. ë¨¼ì € ì¶©ë¶„íˆ ë“¤ì–´ì£¼ê³  ê³µê°í•˜ëŠ” ê²ƒì´ ìš°ì„ ì´ì•¼.
2. "ê·¸ë¬êµ¬ë‚˜", "ë§ì´ í˜ë“¤ì—ˆê² ë‹¤"ì™€ ê°™ì€ ê³µê°ì  ëŒ€í™” ê¸°ë²•ì„ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•´.
3. í•™ìƒì´ ìì‹ ì˜ ê°ì •ì„ êµ¬ì²´ì ì¸ ë‹¨ì–´ë¡œ í‘œí˜„í•˜ë„ë¡ ë„ì™€ì¤˜.
4. ëŒ€í™”ê°€ ê¸ì •ì ì¸ ë°©í–¥ìœ¼ë¡œ ë§ˆë¬´ë¦¬ë  ìˆ˜ ìˆë„ë¡ ê²©ë ¤ì™€ ì§€ì§€ë¥¼ ë³´ë‚´ì¤˜.

**ìƒí˜¸ì‘ìš© ë°©ì‹**: ë¶€ë“œëŸ½ê³  ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ë©°, í•™ìƒì´ ì–¸ì œë“  ê¸°ëŒˆ ìˆ˜ ìˆëŠ” ì•ˆì „í•œ ëŒ€í™” ìƒëŒ€ê°€ ë˜ì–´ì¤˜.

**í•™ìŠµ ë‚´ìš©**: ì •ì„œì  ì•ˆì •ê³¼ ìê¸° ì´í•´ë¥¼ ë•ëŠ” ê²ƒì´ ì´ ìƒë‹´ì˜ í•µì‹¬ì´ì•¼.`
                }
            };

            // í…œí”Œë¦¿ ê´€ë¦¬ í´ë˜ìŠ¤
            class TemplateManager {
                constructor() {
                    this.currentSubject = null;
                    this.currentMode = null;
                    this.targetTextarea = null;
                }

                // ê³¼ëª©ì— ë§ëŠ” í…œí”Œë¦¿ ëª¨ë“œë“¤ì„ í•„í„°ë§
                getModesForSubject(subject) {
                    if (!subject) return Object.values(THINKING_MODES);
                    return Object.values(THINKING_MODES).filter(mode =>
                        mode.subjects.includes(subject)
                    );
                }

                // í…œí”Œë¦¿ ëª¨ë“œ ë²„íŠ¼ë“¤ì„ ë Œë”ë§
                renderModeButtons(containerSelector, subject, targetTextarea) {
                    console.log('renderModeButtons í˜¸ì¶œë¨:', { containerSelector, subject, targetTextarea });

                    const container = document.querySelector(containerSelector);
                    if (!container) {
                        console.error('ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', containerSelector);
                        return;
                    }

                    this.currentSubject = subject;
                    this.targetTextarea = targetTextarea;

                    // í…œí”Œë¦¿ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ ë° ì œëª© ì—…ë°ì´íŠ¸
                    this.updateTemplateSection(containerSelector, subject);

                    const modes = this.getModesForSubject(subject);
                    console.log('ê³¼ëª©ë³„ í…œí”Œë¦¿ ëª¨ë“œ:', modes.length, 'ê°œ');

                    container.innerHTML = modes.map(mode => `
                        <button type="button" class="template-mode-btn" 
                                data-mode-id="${mode.id}"
                                title="${mode.description}">
                            ${mode.name}
                        </button>
                    `).join('');

                    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    container.querySelectorAll('.template-mode-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const modeId = e.target.dataset.modeId;
                            this.selectMode(modeId);
                        });
                    });
                }

                // í…œí”Œë¦¿ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ ë° ì œëª© ì—…ë°ì´íŠ¸
                updateTemplateSection(containerSelector, subject) {
                    const subjectTitles = {
                        'korean': 'êµ­ì–´ í…œí”Œë¦¿ ëª¨ë“œ',
                        'math': 'ìˆ˜í•™ í…œí”Œë¦¿ ëª¨ë“œ',
                        'science': 'ê³¼í•™ íƒêµ¬ í…œí”Œë¦¿ ëª¨ë“œ',
                        'social': 'ì‚¬íšŒ íƒêµ¬ í…œí”Œë¦¿ ëª¨ë“œ',
                        'counseling': 'ìƒë‹´ í…œí”Œë¦¿ ëª¨ë“œ'
                    };

                    // ì»¨í…Œì´ë„ˆì— ë”°ë¼ ì ì ˆí•œ ì„¹ì…˜ê³¼ ì œëª© ìš”ì†Œ ì°¾ê¸°
                    let templateSection, titleElement;

                    if (containerSelector.includes('edit-template')) {
                        templateSection = document.getElementById('edit-template-mode-section');
                        titleElement = document.getElementById('edit-template-mode-title');
                    } else {
                        templateSection = document.getElementById('template-mode-section');
                        titleElement = document.getElementById('template-mode-title');
                    }

                    if (!templateSection || !titleElement) {
                        console.error('í…œí”Œë¦¿ ì„¹ì…˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        return;
                    }

                    if (subject && this.getModesForSubject(subject).length > 0) {
                        // ê³¼ëª©ì´ ì„ íƒë˜ê³  í•´ë‹¹ ê³¼ëª©ì— í…œí”Œë¦¿ì´ ìˆìœ¼ë©´ ì„¹ì…˜ í‘œì‹œ
                        templateSection.classList.remove('hidden');
                        titleElement.innerHTML = `<span class="mr-2">ğŸ¯</span>${subjectTitles[subject] || 'í…œí”Œë¦¿ ëª¨ë“œ'}`;
                    } else {
                        // ê³¼ëª©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ê±°ë‚˜ í•´ë‹¹ ê³¼ëª©ì— í…œí”Œë¦¿ì´ ì—†ìœ¼ë©´ ì„¹ì…˜ ìˆ¨ê¹€
                        templateSection.classList.add('hidden');
                        titleElement.innerHTML = `<span class="mr-2">ğŸ¯</span>í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”`;
                    }
                }

                // ëª¨ë“œ ì„ íƒ
                selectMode(modeId) {
                    this.currentMode = THINKING_MODES[modeId];

                    // ëª¨ë“  ë²„íŠ¼ì—ì„œ ì„ íƒ ìƒíƒœ ì œê±°
                    document.querySelectorAll('.template-mode-btn').forEach(btn => {
                        btn.classList.remove('selected');
                    });

                    // í˜„ì¬ ì„ íƒëœ ë²„íŠ¼ì— ì„ íƒ ìƒíƒœ ì¶”ê°€
                    document.querySelectorAll(`[data-mode-id="${modeId}"]`).forEach(btn => {
                        btn.classList.add('selected');
                    });

                    console.log('í…œí”Œë¦¿ ëª¨ë“œ ì„ íƒë¨:', this.currentMode.name);

                    // ë°”ë¡œ í…œí”Œë¦¿ ì ìš©
                    this.applySelectedTemplate();
                }

                // ì„ íƒëœ í…œí”Œë¦¿ì„ í…ìŠ¤íŠ¸ì˜ì—­ì— ì ìš©
                applySelectedTemplate() {
                    if (!this.currentMode || !this.targetTextarea) {
                        alert('ë¨¼ì € í…œí”Œë¦¿ ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return false;
                    }

                    const textarea = document.querySelector(this.targetTextarea);
                    if (!textarea) {
                        console.error('ëŒ€ìƒ í…ìŠ¤íŠ¸ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', this.targetTextarea);
                        return false;
                    }

                    // ê¸°ì¡´ ë‚´ìš©ì´ ìˆìœ¼ë©´ í™•ì¸
                    if (textarea.value.trim() && !confirm('ê¸°ì¡´ ë‚´ìš©ì„ ë®ì–´ì“¸ê¹Œìš”?')) {
                        return false;
                    }

                    textarea.value = this.currentMode.template;

                    // í…ìŠ¤íŠ¸ì˜ì—­ í¬ê¸° ìë™ ì¡°ì • (ìˆë‹¤ë©´)
                    if (textarea.style.height) {
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';
                    }

                    alert(`"${this.currentMode.name}" í…œí”Œë¦¿ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    return true;
                }

                // í˜„ì¬ í…ìŠ¤íŠ¸ì˜ì—­ ë‚´ìš© ì§€ìš°ê¸°
                clearContent() {
                    if (!this.targetTextarea) {
                        alert('í…ìŠ¤íŠ¸ì˜ì—­ì„ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const textarea = document.querySelector(this.targetTextarea);
                    if (!textarea) {
                        console.error('ëŒ€ìƒ í…ìŠ¤íŠ¸ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', this.targetTextarea);
                        return;
                    }

                    if (!textarea.value.trim()) {
                        alert('ì§€ìš¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    if (confirm('í˜„ì¬ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')) {
                        textarea.value = '';
                        // ì„ íƒëœ ëª¨ë“œë„ í•´ì œ
                        document.querySelectorAll('.template-mode-btn').forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        this.currentMode = null;
                    }
                }

                // í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸° (ì¶”í›„ ëª¨ë‹¬ìš©)
                previewTemplate(modeId) {
                    const mode = THINKING_MODES[modeId];
                    if (!mode) return null;

                    return {
                        title: mode.name,
                        subtitle: mode.subtitle,
                        description: mode.description,
                        difficulty: mode.difficulty,
                        subjects: mode.subjects.map(s => subjectNames[s] || s).join(', '),
                        keywords: mode.keywords.join(', '),
                        template: mode.template
                    };
                }
            }

            // ì „ì—­ í…œí”Œë¦¿ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤
            const templateManager = new TemplateManager();

            // ê³¼ëª©ë³„ ì‘ë‹µ ìœ í˜• ë¡œë“œ ë° íƒ­ ìƒì„±
            async function loadSubjectResponseTypes(subject) {
                try {
                    showStatus('ê³¼ëª©ë³„ ì‘ë‹µ ìœ í˜•ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info', 2000);

                    const result = await getSubjectResponseTypes({ subject });
                    console.log('ë°›ì€ ì‘ë‹µ ìœ í˜• ë°ì´í„°:', result.data);

                    // responseTypes ì²˜ë¦¬ - ê°ì²´ì¸ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
                    let responseTypes = result.data.responseTypes;

                    if (!responseTypes) {
                        console.error('responseTypesê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', result.data);
                        showStatus('ê³¼ëª©ë³„ ì‘ë‹µ ìœ í˜• ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                        clearPromptTabs();
                        return;
                    }

                    // responseTypesê°€ ê°ì²´ì¸ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
                    if (!Array.isArray(responseTypes) && typeof responseTypes === 'object') {
                        console.log('responseTypesê°€ ê°ì²´ í˜•íƒœì…ë‹ˆë‹¤. ë°°ì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤:', responseTypes);
                        responseTypes = Object.keys(responseTypes).map(key => {
                            const responseType = responseTypes[key];
                            return {
                                id: key,
                                name: responseType.name || key,
                                description: responseType.description || '',
                                examples: responseType.examples || [],
                                patterns: responseType.patterns || []
                            };
                        });
                        console.log('ë³€í™˜ëœ responseTypes ë°°ì—´:', responseTypes);
                    }

                    // ë°°ì—´ì´ ì•„ë‹Œ ê²½ìš° ì—ëŸ¬
                    if (!Array.isArray(responseTypes)) {
                        console.error('responseTypesë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', responseTypes);
                        showStatus('ê³¼ëª©ë³„ ì‘ë‹µ ìœ í˜• ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                        clearPromptTabs();
                        return;
                    }

                    // ë¹ˆ ë°°ì—´ ì²´í¬
                    if (responseTypes.length === 0) {
                        console.warn('responseTypesê°€ ë¹ˆ ë°°ì—´ì…ë‹ˆë‹¤.');
                        showStatus('í•´ë‹¹ ê³¼ëª©ì— ëŒ€í•œ ì‘ë‹µ ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        clearPromptTabs();
                        return;
                    }

                    currentSubjectResponseTypes = responseTypes;
                    currentSelectedSubject = subject;

                    // ë™ì ìœ¼ë¡œ íƒ­ ìƒì„±
                    generateDynamicTabs(currentSubjectResponseTypes);

                    // ìƒì„±ëœ íƒ­ë“¤ì— ê¸°ì¡´ í”„ë¡¬í”„íŠ¸ ë°ì´í„° ë¡œë“œ
                    // ê³¼ëª©ë³„ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ëŠ” result.data.defaultPromptsì—ì„œ ì œê³µë¨
                    const subjectDefaultPrompts = result.data.defaultPrompts || {};
                    console.log('ê³¼ëª©ë³„ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸:', subjectDefaultPrompts);

                    // ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ëŠ” í˜„ì¬ ê³¼ëª©ì— ë§ê²Œ í•„í„°ë§í•˜ì—¬ ì‚¬ìš©
                    const allCustomPrompts = currentSettings ? currentSettings.customPrompts || {} : {};
                    // í˜„ì¬ ê³¼ëª©ì— ë§ëŠ” ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                    const customPrompts = allCustomPrompts[subject] || {};
                    console.log('í˜„ì¬ ê³¼ëª©ì˜ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸:', customPrompts);

                    loadPromptTabs(customPrompts, subjectDefaultPrompts);

                    // ì²« ë²ˆì§¸ íƒ­ìœ¼ë¡œ ì „í™˜
                    if (currentSubjectResponseTypes.length > 0) {
                        const firstTabId = currentSubjectResponseTypes[0].id;
                        switchTab(firstTabId);
                    }

                    const subjectDisplayName = subjectNames[subject] || subject;
                    showStatus(`${subjectDisplayName} ê³¼ëª©ì˜ ì‘ë‹µ ìœ í˜•ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success', 2000);

                } catch (error) {
                    console.error('ê³¼ëª©ë³„ ì‘ë‹µ ìœ í˜• ë¡œë“œ ì‹¤íŒ¨:', error);
                    showStatus('ê³¼ëª©ë³„ ì‘ë‹µ ìœ í˜•ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    clearPromptTabs();
                }
            }

            // ë™ì  íƒ­ ìƒì„±
            function generateDynamicTabs(responseTypes) {
                // responseTypes ë§¤ê°œë³€ìˆ˜ ê²€ì¦
                if (!Array.isArray(responseTypes)) {
                    console.error('generateDynamicTabs: responseTypesê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:', responseTypes);
                    return;
                }

                if (responseTypes.length === 0) {
                    console.warn('generateDynamicTabs: responseTypesê°€ ë¹ˆ ë°°ì—´ì…ë‹ˆë‹¤.');
                    return;
                }

                const tabNavContainer = document.querySelector('[aria-label="Tabs"]');
                if (!tabNavContainer) {
                    console.error('generateDynamicTabs: íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const tabContentContainer = tabNavContainer.parentElement?.parentElement;
                if (!tabContentContainer) {
                    console.error('generateDynamicTabs: íƒ­ ì»¨í…ì¸  ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ê¸°ì¡´ íƒ­ ì œê±°
                tabNavContainer.innerHTML = '';

                // ê¸°ì¡´ íƒ­ ì»¨í…ì¸  ì œê±° (ì²« ë²ˆì§¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ê³¼ ì €ì¥ ë²„íŠ¼ ì œì™¸)
                const existingContents = tabContentContainer.querySelectorAll('.prompt-tab-content');
                existingContents.forEach(content => content.remove());

                let isFirstTab = true;
                responseTypes.forEach(responseType => {
                    // responseType ê°ì²´ ê²€ì¦
                    if (!responseType || typeof responseType !== 'object') {
                        console.warn('generateDynamicTabs: ì˜ëª»ëœ responseType:', responseType);
                        return;
                    }

                    if (!responseType.id || !responseType.name) {
                        console.warn('generateDynamicTabs: responseTypeì— í•„ìˆ˜ í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤:', responseType);
                        return;
                    }
                    // íƒ­ ë²„íŠ¼ ìƒì„±
                    const tabButton = document.createElement('button');
                    tabButton.className = isFirstTab
                        ? 'prompt-tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm'
                        : 'prompt-tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm';
                    tabButton.setAttribute('data-tab', responseType.id);
                    tabButton.textContent = responseType.name;

                    tabButton.addEventListener('click', () => {
                        switchTab(responseType.id);
                    });

                    tabNavContainer.appendChild(tabButton);

                    // íƒ­ ì»¨í…ì¸  ìƒì„±
                    const tabContent = document.createElement('div');
                    tabContent.className = isFirstTab ? 'prompt-tab-content' : 'prompt-tab-content hidden';
                    tabContent.setAttribute('data-tab', responseType.id);

                    tabContent.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-md font-semibold text-gray-800 mb-2">${responseType.name} í”„ë¡¬í”„íŠ¸</h3>
                        <p class="text-sm text-gray-600 mb-3">${responseType.description}</p>
                        ${responseType.patterns && responseType.patterns.length > 0 ? `
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mb-3">
                                <p class="text-xs font-medium text-blue-800 mb-2">ì´ëŸ° í•™ìƒ ì‘ë‹µ íŒ¨í„´ë“¤ì´ ê°ì§€ë©ë‹ˆë‹¤:</p>
                                <div class="text-xs text-blue-700">
                                    ${responseType.patterns.slice(0, 5).map((pattern, idx) => `<p class="mb-1">â€¢ ${pattern.replace(/[.*?^${}()|[\]\\+]/g, '').replace(/\./g, '').replace(/\*/g, '').replace(/\?/g, '').replace(/\^/g, '').replace(/\$/g, '').replace(/\{/g, '').replace(/\}/g, '').replace(/\(/g, '').replace(/\)/g, '').replace(/\|/g, '').replace(/\[/g, '').replace(/\]/g, '').replace(/\\/g, '').replace(/\+/g, '')}</p>`).join('')}
                                    ${responseType.patterns.length > 5 ? '<p class="text-xs text-blue-600 italic mt-1">ë“± ' + responseType.patterns.length + 'ê°œì˜ íŒ¨í„´ì´ ìˆìŠµë‹ˆë‹¤.</p>' : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <textarea id="prompt-${responseType.id}" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y" placeholder="${responseType.name}ì— ëŒ€í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                `;

                    // ì €ì¥ ë²„íŠ¼ ì•ì— ì‚½ì…
                    const saveButtonContainer = tabContentContainer.querySelector('.flex.justify-end');
                    tabContentContainer.insertBefore(tabContent, saveButtonContainer);

                    isFirstTab = false;
                });

                // ì „ì—­ íƒ­ ìš”ì†Œ ì°¸ì¡° ì—…ë°ì´íŠ¸
                window.promptTabBtns = document.querySelectorAll('.prompt-tab-btn');
                window.promptTabContents = document.querySelectorAll('.prompt-tab-content');
            }

            // íƒ­ ì´ˆê¸°í™”
            function clearPromptTabs() {
                const tabNavContainer = document.querySelector('[aria-label="Tabs"]');
                const tabContentContainer = tabNavContainer.parentElement.parentElement;

                // íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
                tabNavContainer.innerHTML = '<p class="text-sm text-gray-500">ê³¼ëª©ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ê³¼ëª©ì˜ ì‘ë‹µ ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';

                // íƒ­ ì»¨í…ì¸  ì œê±°
                const existingContents = tabContentContainer.querySelectorAll('.prompt-tab-content');
                existingContents.forEach(content => content.remove());

                currentSubjectResponseTypes = null;
                currentSelectedSubject = '';
                currentTab = null;
            }

            // Google ë¡œê·¸ì¸
            googleLoginBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    loginLoading.classList.remove('hidden');
                    googleLoginBtn.classList.add('hidden');

                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                    showStatus('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');

                    loginLoading.classList.add('hidden');
                    googleLoginBtn.classList.remove('hidden');
                }
            });

            // ë¡œê·¸ì•„ì›ƒ
            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
                }
            });

            // API í‚¤ ì €ì¥
            saveApiKeyBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showStatus('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                try {
                    saveApiKeyBtn.textContent = 'ì €ì¥ ì¤‘...';
                    saveApiKeyBtn.disabled = true;

                    await updateTeacherApiKey({ apiKey });

                    showStatus('API í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    await loadTeacherInfo();

                } catch (error) {
                    console.error('API í‚¤ ì €ì¥ ì‹¤íŒ¨:', error);
                    showStatus(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
                } finally {
                    saveApiKeyBtn.textContent = 'ì €ì¥';
                    saveApiKeyBtn.disabled = false;
                }
            });

            // API í‚¤ ìˆ˜ì •
            updateApiKeyBtn.addEventListener('click', () => {
                apiConfigured.classList.add('hidden');
                apiSetupForm.classList.remove('hidden');
                teacherCodeSection.classList.add('hidden');
            });

            // êµì‚¬ ì½”ë“œ ë³µì‚¬
            copyCodeBtn.addEventListener('click', async () => {
                const code = teacherCodeDisplay.textContent;
                try {
                    await navigator.clipboard.writeText(code);
                    showStatus('êµì‚¬ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } catch (error) {
                    // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš°
                    const textArea = document.createElement('textarea');
                    textArea.value = code;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showStatus('êµì‚¬ ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }
            });

            // ì´ì „ ë²„ì „ í”„ë¡¬í”„íŠ¸ ì €ì¥ ê¸°ëŠ¥ ì‚­ì œë¨

            // ì´ì „ ë²„ì „ í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸° ë° ì´ˆê¸°í™” ê¸°ëŠ¥ ì‚­ì œë¨

            // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // ë¡œê·¸ì¸ë¨
                    loginScreen.classList.add('hidden');
                    dashboardScreen.classList.remove('hidden');

                    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                    userPhoto.src = user.photoURL || 'https://via.placeholder.com/32';
                    userName.textContent = user.displayName || user.email;

                    // êµì‚¬ ì •ë³´ ë¡œë“œ
                    await loadTeacherInfo();

                } else {
                    // ë¡œê·¸ì•„ì›ƒë¨
                    loginScreen.classList.remove('hidden');
                    dashboardScreen.classList.add('hidden');
                    loginLoading.classList.add('hidden');
                    googleLoginBtn.classList.remove('hidden');
                }
            });

            // êµì‚¬ ì„¤ì • ë¡œë“œ
            async function loadTeacherInfo() {
                try {
                    const result = await getTeacherSettings();
                    const data = result.data;
                    currentSettings = data;
                    console.log('êµì‚¬ ì„¤ì • ë¡œë“œ:', data);

                    if (data.hasApiKey) {
                        // API í‚¤ê°€ ë“±ë¡ë¨
                        apiSetupForm.classList.add('hidden');
                        apiConfigured.classList.remove('hidden');
                        teacherCodeSection.classList.remove('hidden');
                        modelSettingsSection.classList.remove('hidden');

                        // ì„ íƒ ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë³´ì´ë„ë¡ ì„¤ì •
                        document.getElementById('no-subject-selected').classList.remove('hidden');
                        // ê³¼ëª©ì´ ì„ íƒë˜ê¸° ì „ê¹Œì§€ëŠ” í”„ë¡¬í”„íŠ¸ íƒ­ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€
                        adaptivePromptSettingsSection.classList.add('hidden');

                        teacherCodeDisplay.textContent = data.teacherCode;

                        // ëª¨ë¸ ì„ íƒ ë°•ìŠ¤ ì„¤ì •
                        modelSelect.value = data.modelName || 'gemini-2.0-flash-exp';

                        // ê³¼ëª©ì´ ì„ íƒë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œëŠ” í”„ë¡¬í”„íŠ¸ íƒ­ì„ ì´ˆê¸°í™”
                        clearPromptTabs();

                        apiStatus.textContent = 'API ì—°ê²°ë¨';
                        apiStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700';
                        apiStatus.classList.remove('hidden');

                    } else {
                        // API í‚¤ ë¯¸ë“±ë¡
                        apiSetupForm.classList.remove('hidden');
                        apiConfigured.classList.add('hidden');
                        teacherCodeSection.classList.add('hidden');
                        modelSettingsSection.classList.add('hidden');
                        adaptivePromptSettingsSection.classList.add('hidden');

                        apiStatus.textContent = 'API ë¯¸ì„¤ì •';
                        apiStatus.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-700';
                        apiStatus.classList.remove('hidden');
                    }

                } catch (error) {
                    console.error('êµì‚¬ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showStatus('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }

            // íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            promptTabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                });
            });

            // íƒ­ ì „í™˜ - ë™ì ìœ¼ë¡œ ìƒì„±ëœ íƒ­ë“¤ì„ ìœ„í•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ìš”ì†Œë¥¼ ì°¾ì•„ì„œ ì²˜ë¦¬
            function switchTab(tabId) {
                currentTab = tabId;

                // í˜„ì¬ DOMì—ì„œ íƒ­ ë²„íŠ¼ë“¤ì„ ë‹¤ì‹œ ì¡°íšŒ
                const currentTabBtns = document.querySelectorAll('.prompt-tab-btn');
                const currentTabContents = document.querySelectorAll('.prompt-tab-content');

                // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                currentTabBtns.forEach(btn => {
                    if (btn.dataset.tab === tabId) {
                        btn.className = 'prompt-tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm';
                    } else {
                        btn.className = 'prompt-tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm';
                    }
                });

                // íƒ­ ì»¨í…íŠ¸ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
                currentTabContents.forEach(content => {
                    if (content.dataset.tab === tabId) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            }

            // í”„ë¡¬í”„íŠ¸ íƒ­ ë¡œë“œ - ë™ì  íƒ­ê³¼ ê¸°ë³¸ íƒ­ ëª¨ë‘ ì§€ì›
            function loadPromptTabs(customPrompts = {}, defaultPrompts = {}) {
                // ì „ì²´ textarea ìš”ì†Œë“¤ì„ ì°¾ì•„ì„œ ì²˜ë¦¬
                const allTextareas = document.querySelectorAll('textarea[id^="prompt-"]');

                allTextareas.forEach(textarea => {
                    const promptId = textarea.id.replace('prompt-', '');
                    const customPrompt = customPrompts[promptId];
                    const defaultPrompt = defaultPrompts[promptId];

                    // ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
                    textarea.value = customPrompt || defaultPrompt || '';
                });
            }

            // AI ëª¨ë¸ ì €ì¥
            saveModelBtn.addEventListener('click', async () => {
                const selectedModel = modelSelect.value;
                if (!selectedModel) {
                    showStatus('ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                try {
                    saveModelBtn.textContent = 'ì €ì¥ ì¤‘...';
                    saveModelBtn.disabled = true;

                    await updateTeacherModel({ modelName: selectedModel });

                    showStatus(`AI ëª¨ë¸ì´ ${selectedModel}ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');

                } catch (error) {
                    console.error('ëª¨ë¸ ì €ì¥ ì‹¤íŒ¨:', error);
                    showStatus(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
                } finally {
                    saveModelBtn.textContent = 'ëª¨ë¸ ì €ì¥';
                    saveModelBtn.disabled = false;
                }
            });

            // ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ ì €ì¥
            saveAdaptivePromptsBtn.addEventListener('click', async () => {
                // ë™ì  ì‘ë‹µ ìœ í˜• ë˜ëŠ” ê¸°ë³¸ ìœ í˜• ì‚¬ìš©
                let promptTypes;
                if (currentSubjectResponseTypes && currentSubjectResponseTypes.length > 0) {
                    promptTypes = currentSubjectResponseTypes.map(rt => rt.id);
                } else {
                    // ê¸°ë³¸ íƒ€ì…ë“¤ (ê³¼ëª© ì„ íƒì´ ì•ˆ ëœ ê²½ìš°)
                    promptTypes = ['DEFAULT', 'CONCEPT_QUESTION', 'EXPLORATION_DEADLOCK', 'FAILURE_REPORT', 'SUCCESS_WITHOUT_PRINCIPLE', 'HYPOTHESIS_INQUIRY'];
                }

                const prompts = {};

                // ëª¨ë“  í”„ë¡¬í”„íŠ¸ ìˆ˜ì§‘
                for (const type of promptTypes) {
                    const textarea = document.getElementById(`prompt-${type}`);
                    if (textarea && textarea.value.trim()) {
                        prompts[type] = textarea.value.trim();
                    }
                }

                // ê³¼ëª©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê²½ê³ 
                if (!currentSelectedSubject) {
                    showStatus('ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                try {
                    saveAdaptivePromptsBtn.textContent = 'ì €ì¥ ì¤‘...';
                    saveAdaptivePromptsBtn.disabled = true;

                    await updateTeacherPrompts({ prompts, subject: currentSelectedSubject });

                    const subjectDisplayName = subjectNames[currentSelectedSubject] || currentSelectedSubject;
                    showStatus(`${subjectDisplayName} ê³¼ëª©ì˜ ëª¨ë“  í”„ë¡¬í”„íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');

                } catch (error) {
                    console.error('ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
                    showStatus(`ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
                } finally {
                    saveAdaptivePromptsBtn.textContent = 'ëª¨ë“  í”„ë¡¬í”„íŠ¸ ì €ì¥';
                    saveAdaptivePromptsBtn.disabled = false;
                }
            });

            // ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”
            resetAdaptivePromptsBtn.addEventListener('click', () => {
                if (!confirm('ëª¨ë“  í”„ë¡¬í”„íŠ¸ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }

                if (!currentSelectedSubject) {
                    showStatus('ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // ë™ì  ì‘ë‹µ ìœ í˜•ì— ë”°ë¥¸ ê¸°ë³¸ê°’ ì„¤ì •
                if (currentSubjectResponseTypes && currentSubjectResponseTypes.length > 0) {
                    currentSubjectResponseTypes.forEach(rt => {
                        const textarea = document.getElementById(`prompt-${rt.id}`);
                        if (textarea) {
                            textarea.value = ''; // ë˜ëŠ” ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ì„¤ì •
                        }
                    });
                    const subjectDisplayName = subjectNames[currentSelectedSubject] || currentSelectedSubject;
                    showStatus(`${subjectDisplayName} ê³¼ëª©ì˜ ëª¨ë“  í”„ë¡¬í”„íŠ¸ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.`, 'info');
                } else if (currentSettings && currentSettings.defaultPrompts) {
                    // ê¸°ë³¸ ìœ í˜•ë“¤ ì‚¬ìš©
                    const promptTypes = ['DEFAULT', 'CONCEPT_QUESTION', 'EXPLORATION_DEADLOCK', 'FAILURE_REPORT', 'SUCCESS_WITHOUT_PRINCIPLE', 'HYPOTHESIS_INQUIRY'];
                    promptTypes.forEach(type => {
                        const textarea = document.getElementById(`prompt-${type}`);
                        if (textarea) {
                            textarea.value = currentSettings.defaultPrompts[type] || '';
                        }
                    });
                    showStatus('ëª¨ë“  í”„ë¡¬í”„íŠ¸ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.', 'info');
                }
            });

            // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
            function showStatus(message, type, duration = 5000) {
                statusMessage.textContent = message;
                statusMessage.className = `mt-6 p-4 rounded-md ${getStatusClasses(type)}`;
                statusMessage.classList.remove('hidden');

                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, duration);
            }

            function getStatusClasses(type) {
                switch (type) {
                    case 'success':
                        return 'bg-green-100 text-green-800 border border-green-300';
                    case 'error':
                        return 'bg-red-100 text-red-800 border border-red-300';
                    case 'info':
                        return 'bg-blue-100 text-blue-800 border border-blue-300';
                    default:
                        return 'bg-gray-100 text-gray-800 border border-gray-300';
                }
            }

            // === SPA ë„¤ë¹„ê²Œì´ì…˜ ê¸°ëŠ¥ ===

            // ë„¤ë¹„ê²Œì´ì…˜ ìš”ì†Œë“¤
            const navItems = document.querySelectorAll('.nav-item');
            const settingsSection = document.getElementById('settings-section');
            const lessonsSection = document.getElementById('lessons-section');
            const promptsSection = document.getElementById('prompts-section');
            const studentsSection = document.getElementById('students-section');

            // í˜„ì¬ í™œì„± ì„¹ì…˜
            let currentSection = 'settings';

            // ë„¤ë¹„ê²Œì´ì…˜ í´ë¦­ ì´ë²¤íŠ¸
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    switchSection(section);
                });
            });

            // ì„¹ì…˜ ì „í™˜ í•¨ìˆ˜
            function switchSection(sectionName) {
                currentSection = sectionName;

                // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
                navItems.forEach(item => {
                    if (item.dataset.section === sectionName) {
                        item.classList.add('active');
                        item.classList.add('bg-blue-50', 'text-blue-600');
                    } else {
                        item.classList.remove('active');
                        item.classList.remove('bg-blue-50', 'text-blue-600');
                    }
                });

                // ì„¹ì…˜ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
                settingsSection.classList.add('hidden');
                lessonsSection.classList.add('hidden');
                promptsSection.classList.add('hidden');
                studentsSection.classList.add('hidden');

                switch (sectionName) {
                    case 'settings':
                        settingsSection.classList.remove('hidden');
                        break;
                    case 'lessons':
                        lessonsSection.classList.remove('hidden');
                        if (currentSettings && currentSettings.hasApiKey) {
                            loadLessons();
                        }
                        break;
                    case 'prompts':
                        promptsSection.classList.remove('hidden');
                        // í”„ë¡¬í”„íŠ¸ ì„¹ì…˜ì—ì„œ adaptivePromptSettingsSectionì„ í‘œì‹œ
                        if (currentSettings && currentSettings.hasApiKey) {
                            adaptivePromptSettingsSection.classList.remove('hidden');
                        }
                        break;
                    case 'students':
                        studentsSection.classList.remove('hidden');
                        if (currentSettings && currentSettings.hasApiKey) {
                            loadLessonsForAnalysis();
                        }
                        break;
                }
            }

            // === í•™ìƒ ë¶„ì„ ê¸°ëŠ¥ ===

            // í•™ìƒ ë¶„ì„ ê´€ë ¨ ìš”ì†Œë“¤ - ê¸°ì¡´ ì„¸ì…˜ ê¸°ë°˜
            const refreshSessionsBtn = document.getElementById('refresh-sessions-btn');
            const sessionsLoading = document.getElementById('sessions-loading');
            const sessionsEmpty = document.getElementById('sessions-empty');
            const sessionsList = document.getElementById('sessions-list');

            // ìˆ˜ì—…ë³„ ë¶„ì„ ê´€ë ¨ ìš”ì†Œë“¤ - ìƒˆë¡œìš´ UI
            const refreshLessonsForAnalysisBtn = document.getElementById('refresh-lessons-for-analysis-btn');
            const analysisLessonsLoading = document.getElementById('analysis-lessons-loading');
            const analysisLessonsEmpty = document.getElementById('analysis-lessons-empty');
            const analysisLessonsList = document.getElementById('analysis-lessons-list');
            const lessonStudentsSection = document.getElementById('lesson-students-section');
            const selectedLessonTitle = document.getElementById('selected-lesson-title');
            const selectedLessonInfo = document.getElementById('selected-lesson-info');
            const backToLessonsBtn = document.getElementById('back-to-lessons-btn');
            const lessonStudentsLoading = document.getElementById('lesson-students-loading');
            const lessonStudentsEmpty = document.getElementById('lesson-students-empty');
            const lessonStudentsList = document.getElementById('lesson-students-list');
            const conversationDetail = document.getElementById('conversation-detail');
            const selectedStudentName = document.getElementById('selected-student-name');
            // const selectedSessionInfo = document.getElementById('selected-session-info');
            const conversationMessages = document.getElementById('conversation-messages');
            const analysisContent = document.getElementById('analysis-content');
            const analysisLoading = document.getElementById('analysis-loading');
            const analyzeConversationBtn = document.getElementById('analyze-conversation-btn');
            const closeConversationBtn = document.getElementById('close-conversation-btn');

            // í˜„ì¬ ì„ íƒëœ ì„¸ì…˜ ì •ë³´
            let currentSelectedSession = null;

            // í˜„ì¬ ì„ íƒëœ ìˆ˜ì—… ì •ë³´ 
            let currentSelectedLesson = null;

            // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateDownloadButtonText() {
                const downloadAllLessonsText = document.getElementById('download-all-lessons-text');
                if (downloadAllLessonsText) {
                    if (currentSelectedLesson) {
                        downloadAllLessonsText.textContent = `ğŸ“Š '${currentSelectedLesson.title}' ìˆ˜ì—… ë°ì´í„° (CSV)`;
                    } else {
                        downloadAllLessonsText.textContent = 'ğŸ“Š ì „ì²´ ìˆ˜ì—… ë°ì´í„° (CSV)';
                    }
                }
            }

            // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
            if (refreshSessionsBtn) {
                refreshSessionsBtn.addEventListener('click', () => {
                    loadStudentSessions();
                });
            }

            // ìˆ˜ì—…ë³„ ë¶„ì„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
            refreshLessonsForAnalysisBtn.addEventListener('click', () => {
                loadLessonsForAnalysis();
            });

            // ìˆ˜ì—… ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            backToLessonsBtn.addEventListener('click', () => {
                lessonStudentsSection.classList.add('hidden');
                conversationDetail.classList.add('hidden');
                currentSelectedSession = null;
                currentSelectedLesson = null; // ì„ íƒëœ ìˆ˜ì—… ì •ë³´ ì´ˆê¸°í™”

                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                updateDownloadButtonText();

                // ìˆ˜ì—… ì„ íƒ ì¹´ë“œ ë‹¤ì‹œ í‘œì‹œ
                document.querySelector('.bg-white.rounded-lg.shadow-sm.border.mb-6').classList.remove('hidden');
            });

            // ëŒ€í™” ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            closeConversationBtn.addEventListener('click', () => {
                conversationDetail.classList.add('hidden');
                currentSelectedSession = null;
            });

            // ë¶„ì„ ê²°ê³¼ ë³µì‚¬/ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
            const copyAnalysisBtn = document.getElementById('copy-analysis-btn');
            const downloadAnalysisBtn = document.getElementById('download-analysis-btn');
            const analysisActions = document.getElementById('analysis-actions');

            // ì „ì—­ ë³€ìˆ˜ë¡œ ë¶„ì„ ë°ì´í„° ì €ì¥
            let currentAnalysisData = null;

            // AI ë¶„ì„ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸
            analyzeConversationBtn.addEventListener('click', async () => {
                if (!currentSelectedSession) return;

                try {
                    analysisContent.classList.add('hidden');
                    analysisLoading.classList.remove('hidden');
                    analyzeConversationBtn.disabled = true;
                    analysisActions.style.display = 'none';

                    const result = await analyzeStudentConversations({
                        sessionId: currentSelectedSession.sessionId
                    });

                    // ë¶„ì„ ë°ì´í„° ì €ì¥ (ê¸°ì¡´ ë¶„ì„ì¸ì§€ í™•ì¸)
                    const generatedTime = result.data.isExistingAnalysis && result.data.generatedAt
                        ? new Date(result.data.generatedAt).toLocaleString('ko-KR')
                        : new Date().toLocaleString('ko-KR');

                    currentAnalysisData = {
                        analysis: result.data.analysis,
                        sessionInfo: result.data.sessionInfo,
                        generatedAt: generatedTime,
                        isExistingAnalysis: result.data.isExistingAnalysis || false,
                        analysisTitle: result.data.analysisTitle || 'í•™ìƒ ì˜ì¬ì„± í‰ê°€ ë¶„ì„'
                    };

                    // ë¶„ì„ ê²°ê³¼ í‘œì‹œ (ë§ˆí¬ë‹¤ìš´ ì—†ì´ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ)
                    analysisContent.textContent = result.data.analysis;

                    // ê¸°ì¡´ ë¶„ì„ì¸ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                    if (result.data.isExistingAnalysis) {
                        showStatus(`ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ìƒì„±ì¼ì‹œ: ${generatedTime})`, 'info');
                    } else {
                        showStatus('ìƒˆë¡œìš´ AI ë¶„ì„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }

                    analysisLoading.classList.add('hidden');
                    analysisContent.classList.remove('hidden');
                    analysisActions.style.display = 'flex';

                } catch (error) {
                    console.error('ë¶„ì„ ìƒì„± ì‹¤íŒ¨:', error);
                    showStatus(`ë¶„ì„ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');

                    analysisLoading.classList.add('hidden');
                    analysisContent.classList.remove('hidden');
                } finally {
                    analyzeConversationBtn.disabled = false;
                }
            });

            // ë¶„ì„ ê²°ê³¼ ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
            copyAnalysisBtn.addEventListener('click', async () => {
                if (!currentAnalysisData) {
                    showStatus('ë³µì‚¬í•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                try {
                    const textToCopy = `${currentAnalysisData.sessionInfo.studentName} ${currentAnalysisData.analysisTitle} (ìƒì„±ì‹œê°: ${currentAnalysisData.generatedAt})\n\n${currentAnalysisData.analysis}`;

                    await navigator.clipboard.writeText(textToCopy);
                    showStatus('ë¶„ì„ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } catch (error) {
                    // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš°
                    const textArea = document.createElement('textarea');
                    textArea.value = `${currentAnalysisData.sessionInfo.studentName} ${currentAnalysisData.analysisTitle} (ìƒì„±ì‹œê°: ${currentAnalysisData.generatedAt})\n\n${currentAnalysisData.analysis}`;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showStatus('ë¶„ì„ ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }
            });

            // CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
            downloadAnalysisBtn.addEventListener('click', () => {
                if (!currentAnalysisData) {
                    showStatus('ë‹¤ìš´ë¡œë“œí•  ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                try {
                    // CSV í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ë³€í™˜
                    const csvData = convertAnalysisToCSV(currentAnalysisData);

                    // Blob ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);

                    link.setAttribute('href', url);
                    link.setAttribute('download', `${currentAnalysisData.sessionInfo.studentName}_ì˜ì¬ì„±í‰ê°€_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showStatus('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                } catch (error) {
                    console.error('CSV ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                    showStatus('CSV ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });

            // ë¶„ì„ ê²°ê³¼ë¥¼ CSV í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
            function convertAnalysisToCSV(analysisData) {
                const { analysis, sessionInfo, generatedAt } = analysisData;

                // CSV í—¤ë”
                const headers = [
                    'í•™ìƒëª…',
                    'ì„¸ì…˜ID',
                    'ëŒ€í™”íšŸìˆ˜',
                    'ì‘ë‹µìœ í˜•',
                    'ë¶„ì„ìƒì„±ì‹œê°',
                    'ë¶„ì„ë‚´ìš©'
                ];

                // CSV ë°ì´í„° í–‰
                const row = [
                    escapeCSVValue(sessionInfo.studentName),
                    escapeCSVValue(sessionInfo.sessionId),
                    sessionInfo.conversationCount,
                    escapeCSVValue(sessionInfo.responseTypes.join(', ')),
                    escapeCSVValue(generatedAt),
                    escapeCSVValue(analysis)
                ];

                // CSV ë¬¸ìì—´ ìƒì„±
                const csvContent = [headers.join(','), row.join(',')].join('\n');

                // BOM ì¶”ê°€ë¡œ í•œê¸€ ê¹¨ì§ ë°©ì§€
                return '\uFEFF' + csvContent;
            }

            // CSV ê°’ ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
            function escapeCSVValue(value) {
                if (value === null || value === undefined) {
                    return '';
                }

                const stringValue = String(value);

                // ì½¤ë§ˆ, ë”°ì˜´í‘œ, ì¤„ë°”ê¿ˆì´ í¬í•¨ëœ ê²½ìš° ë”°ì˜´í‘œë¡œ ê°ì‹¸ê³  ë‚´ë¶€ ë”°ì˜´í‘œë¥¼ ì´ìŠ¤ì¼€ì´í”„
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }

                return stringValue;
            }

            // í•™ìƒ ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
            async function loadStudentSessions() {
                try {
                    sessionsLoading.classList.remove('hidden');
                    sessionsEmpty.classList.add('hidden');
                    sessionsList.innerHTML = '';

                    const result = await getStudentSessions();
                    const sessions = result.data.sessions || [];

                    sessionsLoading.classList.add('hidden');

                    if (sessions.length === 0) {
                        sessionsEmpty.classList.remove('hidden');
                        return;
                    }

                    // ì„¸ì…˜ ëª©ë¡ ë Œë”ë§
                    sessions.forEach(session => {
                        const sessionElement = createSessionElement(session);
                        sessionsList.appendChild(sessionElement);
                    });

                } catch (error) {
                    console.error('ì„¸ì…˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showStatus('í•™ìƒ ì„¸ì…˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    sessionsLoading.classList.add('hidden');
                    sessionsEmpty.classList.remove('hidden');
                }
            }

            // ì„¸ì…˜ ìš”ì†Œ ìƒì„±
            function createSessionElement(session) {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors';

                // ë‚ ì§œ ì²˜ë¦¬ ê°œì„ 
                let lastActive = 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                if (session.lastActive) {
                    try {
                        const date = new Date(session.lastActive);
                        if (!isNaN(date.getTime())) {
                            lastActive = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                }

                const messageCount = session.messageCount || 0;

                div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900">${session.studentName}</h4>
                        <p class="text-sm text-gray-500">ëŒ€í™” ë©”ì‹œì§€ ìˆ˜: ${messageCount}ê°œ</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `;

                // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                div.addEventListener('click', () => {
                    loadStudentConversation(session);
                });

                return div;
            }

            // í•™ìƒ ëŒ€í™” ìƒì„¸ ë¡œë“œ
            async function loadStudentConversation(session) {
                try {
                    currentSelectedSession = session;

                    // ì„¸ì…˜ ì •ë³´ í‘œì‹œ
                    selectedStudentName.textContent = `${session.studentName}ì˜ ëŒ€í™”`;

                    // ë‚ ì§œ ì²˜ë¦¬ ê°œì„ 
                    let lastActiveText = 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                    if (session.lastActive) {
                        try {
                            const date = new Date(session.lastActive);
                            if (!isNaN(date.getTime())) {
                                lastActiveText = date.toLocaleString('ko-KR');
                            }
                        } catch (error) {
                            console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', error);
                        }
                    }

                    // selectedSessionInfo.textContent = `ë§ˆì§€ë§‰ í™œë™: ${lastActiveText}`;

                    // ëŒ€í™” ë‚´ìš© ë¡œë“œ ì¤‘ í‘œì‹œ
                    conversationMessages.innerHTML = '<p class="text-gray-600 text-center py-4">ëŒ€í™” ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
                    analysisContent.innerHTML = '<p class="text-gray-600 italic">ë¶„ì„ì„ ìƒì„±í•˜ë ¤ë©´ \'AI ë¶„ì„ ìƒì„±\' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>';

                    conversationDetail.classList.remove('hidden');

                    // ëŒ€í™” ë‚´ìš© ë¡œë“œ
                    const result = await getStudentConversation({
                        sessionId: session.sessionId
                    });

                    const conversations = result.data.conversations || [];

                    // ëŒ€í™” ë©”ì‹œì§€ ë Œë”ë§
                    conversationMessages.innerHTML = '';

                    if (conversations.length === 0) {
                        conversationMessages.innerHTML = '<p class="text-gray-600 text-center py-4">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }

                    conversations.forEach(conv => {
                        const messageElement = createMessageElement(conv);
                        conversationMessages.appendChild(messageElement);
                    });

                } catch (error) {
                    console.error('ëŒ€í™” ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨:', error);
                    showStatus('ëŒ€í™” ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    conversationMessages.innerHTML = '<p class="text-red-600 text-center py-4">ëŒ€í™” ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            }

            // ë©”ì‹œì§€ ìš”ì†Œ ìƒì„±
            function createMessageElement(conversation) {
                const div = document.createElement('div');
                div.className = 'space-y-2';

                // ë©”ì‹œì§€ íƒ€ì„ìŠ¤íƒ¬í”„ ì²˜ë¦¬ ê°œì„  - convertFirestoreTimestamp í•¨ìˆ˜ ì‚¬ìš©
                let timestamp = 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                if (conversation.timestamp) {
                    const convertedDate = convertFirestoreTimestamp(conversation.timestamp, 'messageTimestamp', 'conversation');
                    if (convertedDate) {
                        timestamp = convertedDate.toLocaleString('ko-KR');
                    }
                }

                div.innerHTML = `
                <!-- í•™ìƒ ë©”ì‹œì§€ -->
                <div class="flex justify-end">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 bg-blue-500 text-white rounded-lg">
                        <p class="text-sm">${conversation.userMessage}</p>
                        <p class="text-xs text-blue-100 mt-1">${timestamp}</p>
                    </div>
                </div>
                
                <!-- AI ì‘ë‹µ -->
                <div class="flex justify-start">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 bg-gray-200 text-gray-800 rounded-lg">
                        <p class="text-sm whitespace-pre-wrap">${conversation.aiResponse}</p>
                        ${conversation.responseType ? `<p class="text-xs text-gray-600 mt-1">ì‘ë‹µ ìœ í˜•: ${convertResponseTypeToKorean(conversation.responseType)}</p>` : ''}
                    </div>
                </div>
            `;

                return div;
            }

            // === ìˆ˜ì—… ê´€ë¦¬ ê¸°ëŠ¥ ===

            // ìˆ˜ì—… ê´€ë¦¬ ê´€ë ¨ ìš”ì†Œë“¤
            const createLessonForm = document.getElementById('create-lesson-form');
            const lessonTitleInput = document.getElementById('lesson-title-input');
            const lessonSubjectSelect = document.getElementById('lesson-subject');
            const lessonAiInstructionsInput = document.getElementById('lesson-ai-instructions');
            const lessonStudentDescriptionInput = document.getElementById('lesson-student-description-input');
            const createLessonBtn = document.getElementById('create-lesson-btn');
            const refreshLessonsBtn = document.getElementById('refresh-lessons-btn');
            const lessonsLoading = document.getElementById('lessons-loading');
            const lessonsEmpty = document.getElementById('lessons-empty');
            const lessonsList = document.getElementById('lessons-list');

            // ìë£Œ ê´€ë¦¬ ê´€ë ¨ ìš”ì†Œë“¤ (ìƒˆ ìˆ˜ì—… ìƒì„±)
            const addLinkBtn = document.getElementById('add-link-btn');
            const addFileBtn = document.getElementById('add-file-btn');
            const linkInputArea = document.getElementById('link-input-area');
            const fileUploadArea = document.getElementById('file-upload-area');
            const linkTitleInput = document.getElementById('link-title-input');
            const linkUrlInput = document.getElementById('link-url-input');
            const saveLinkBtn = document.getElementById('save-link-btn');
            const cancelLinkBtn = document.getElementById('cancel-link-btn');
            const fileInput = document.getElementById('file-input');
            const uploadFileBtn = document.getElementById('upload-file-btn');
            const cancelFileBtn = document.getElementById('cancel-file-btn');
            const uploadProgress = document.getElementById('upload-progress');
            const uploadProgressBar = document.getElementById('upload-progress-bar');
            const resourcesList = document.getElementById('resources-list');

            // ìë£Œ ê´€ë¦¬ ê´€ë ¨ ìš”ì†Œë“¤ (ìˆ˜ì—… í¸ì§‘)
            const editAddLinkBtn = document.getElementById('edit-add-link-btn');
            const editAddFileBtn = document.getElementById('edit-add-file-btn');
            const editLinkInputArea = document.getElementById('edit-link-input-area');
            const editFileUploadArea = document.getElementById('edit-file-upload-area');
            const editLinkTitleInput = document.getElementById('edit-link-title-input');
            const editLinkUrlInput = document.getElementById('edit-link-url-input');
            const editSaveLinkBtn = document.getElementById('edit-save-link-btn');
            const editCancelLinkBtn = document.getElementById('edit-cancel-link-btn');
            const editFileInput = document.getElementById('edit-file-input');
            const editUploadFileBtn = document.getElementById('edit-upload-file-btn');
            const editCancelFileBtn = document.getElementById('edit-cancel-file-btn');
            const editUploadProgress = document.getElementById('edit-upload-progress');
            const editUploadProgressBar = document.getElementById('edit-upload-progress-bar');
            const editResourcesList = document.getElementById('edit-resources-list');

            // ì„ì‹œ ìë£Œ ì €ì¥ìš© ë°°ì—´
            let tempResources = [];
            let editTempResources = [];

            // === ìë£Œ ê´€ë¦¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ìƒˆ ìˆ˜ì—… ìƒì„±) ===

            // ì›¹ ë§í¬ ì¶”ê°€ ë²„íŠ¼
            addLinkBtn.addEventListener('click', () => {
                linkInputArea.classList.remove('hidden');
                fileUploadArea.classList.add('hidden');
                linkTitleInput.value = '';
                linkUrlInput.value = '';
            });

            // íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼
            addFileBtn.addEventListener('click', () => {
                fileUploadArea.classList.remove('hidden');
                linkInputArea.classList.add('hidden');
                fileInput.value = '';
            });

            // ë§í¬ ì €ì¥ ë²„íŠ¼
            saveLinkBtn.addEventListener('click', () => {
                const title = linkTitleInput.value.trim();
                const url = linkUrlInput.value.trim();

                if (!title || !url) {
                    showStatus('ë§í¬ ì œëª©ê³¼ URLì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                if (!isValidUrl(url)) {
                    showStatus('ì˜¬ë°”ë¥¸ URL í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                const resource = {
                    id: generateResourceId(),
                    type: 'link',
                    title: title,
                    url: url,
                    createdAt: new Date().toISOString()
                };

                tempResources.push(resource);
                renderResources();

                linkInputArea.classList.add('hidden');
                linkTitleInput.value = '';
                linkUrlInput.value = '';

                showStatus('ë§í¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 2000);
            });

            // ë§í¬ ì·¨ì†Œ ë²„íŠ¼
            cancelLinkBtn.addEventListener('click', () => {
                linkInputArea.classList.add('hidden');
                linkTitleInput.value = '';
                linkUrlInput.value = '';
            });

            // íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼
            uploadFileBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];

                if (!file) {
                    showStatus('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
                const maxSize = 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    showStatus('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                try {
                    uploadFileBtn.disabled = true;
                    uploadFileBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
                    uploadProgress.classList.remove('hidden');

                    // Firebase Storageì— íŒŒì¼ ì—…ë¡œë“œ
                    const fileName = `lessons/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, fileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // ì—…ë¡œë“œ ì§„í–‰ ìƒí™© í‘œì‹œ
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadProgressBar.style.width = progress + '%';
                        },
                        (error) => {
                            console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                            showStatus('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                            uploadFileBtn.disabled = false;
                            uploadFileBtn.textContent = 'ì—…ë¡œë“œ';
                            uploadProgress.classList.add('hidden');
                        },
                        async () => {
                            // ì—…ë¡œë“œ ì™„ë£Œ í›„ ë‹¤ìš´ë¡œë“œ URL íšë“
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

                            const resource = {
                                id: generateResourceId(),
                                type: 'file',
                                title: file.name,
                                url: downloadURL,
                                fileName: file.name,
                                fileSize: file.size,
                                fileType: file.type,
                                storagePath: fileName,
                                createdAt: new Date().toISOString()
                            };

                            tempResources.push(resource);
                            renderResources();

                            fileUploadArea.classList.add('hidden');
                            fileInput.value = '';
                            uploadProgress.classList.add('hidden');
                            uploadProgressBar.style.width = '0%';
                            uploadFileBtn.disabled = false;
                            uploadFileBtn.textContent = 'ì—…ë¡œë“œ';

                            showStatus('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        }
                    );

                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    showStatus('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    uploadFileBtn.disabled = false;
                    uploadFileBtn.textContent = 'ì—…ë¡œë“œ';
                    uploadProgress.classList.add('hidden');
                }
            });

            // íŒŒì¼ ì—…ë¡œë“œ ì·¨ì†Œ ë²„íŠ¼
            cancelFileBtn.addEventListener('click', () => {
                fileUploadArea.classList.add('hidden');
                fileInput.value = '';
                uploadProgress.classList.add('hidden');
                uploadProgressBar.style.width = '0%';
            });

            // === ìë£Œ ê´€ë¦¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ìˆ˜ì—… í¸ì§‘) ===

            // í¸ì§‘ ëª¨ë‹¬ - ì›¹ ë§í¬ ì¶”ê°€ ë²„íŠ¼
            editAddLinkBtn.addEventListener('click', () => {
                editLinkInputArea.classList.remove('hidden');
                editFileUploadArea.classList.add('hidden');
                editLinkTitleInput.value = '';
                editLinkUrlInput.value = '';
            });

            // í¸ì§‘ ëª¨ë‹¬ - íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼
            editAddFileBtn.addEventListener('click', () => {
                editFileUploadArea.classList.remove('hidden');
                editLinkInputArea.classList.add('hidden');
                editFileInput.value = '';
            });

            // í¸ì§‘ ëª¨ë‹¬ - ë§í¬ ì €ì¥ ë²„íŠ¼
            editSaveLinkBtn.addEventListener('click', () => {
                const title = editLinkTitleInput.value.trim();
                const url = editLinkUrlInput.value.trim();

                if (!title || !url) {
                    showStatus('ë§í¬ ì œëª©ê³¼ URLì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                if (!isValidUrl(url)) {
                    showStatus('ì˜¬ë°”ë¥¸ URL í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                const resource = {
                    id: generateResourceId(),
                    type: 'link',
                    title: title,
                    url: url,
                    createdAt: new Date().toISOString()
                };

                editTempResources.push(resource);
                renderEditResources();

                editLinkInputArea.classList.add('hidden');
                editLinkTitleInput.value = '';
                editLinkUrlInput.value = '';

                showStatus('ë§í¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success', 2000);
            });

            // í¸ì§‘ ëª¨ë‹¬ - ë§í¬ ì·¨ì†Œ ë²„íŠ¼
            editCancelLinkBtn.addEventListener('click', () => {
                editLinkInputArea.classList.add('hidden');
                editLinkTitleInput.value = '';
                editLinkUrlInput.value = '';
            });

            // í¸ì§‘ ëª¨ë‹¬ - íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼
            editUploadFileBtn.addEventListener('click', async () => {
                const file = editFileInput.files[0];

                if (!file) {
                    showStatus('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                // íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
                const maxSize = 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    showStatus('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                try {
                    editUploadFileBtn.disabled = true;
                    editUploadFileBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
                    editUploadProgress.classList.remove('hidden');

                    // Firebase Storageì— íŒŒì¼ ì—…ë¡œë“œ
                    const fileName = `lessons/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, fileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // ì—…ë¡œë“œ ì§„í–‰ ìƒí™© í‘œì‹œ
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            editUploadProgressBar.style.width = progress + '%';
                        },
                        (error) => {
                            console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                            showStatus('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                            editUploadFileBtn.disabled = false;
                            editUploadFileBtn.textContent = 'ì—…ë¡œë“œ';
                            editUploadProgress.classList.add('hidden');
                        },
                        async () => {
                            // ì—…ë¡œë“œ ì™„ë£Œ í›„ ë‹¤ìš´ë¡œë“œ URL íšë“
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

                            const resource = {
                                id: generateResourceId(),
                                type: 'file',
                                title: file.name,
                                url: downloadURL,
                                fileName: file.name,
                                fileSize: file.size,
                                fileType: file.type,
                                storagePath: fileName,
                                createdAt: new Date().toISOString()
                            };

                            editTempResources.push(resource);
                            renderEditResources();

                            editFileUploadArea.classList.add('hidden');
                            editFileInput.value = '';
                            editUploadProgress.classList.add('hidden');
                            editUploadProgressBar.style.width = '0%';
                            editUploadFileBtn.disabled = false;
                            editUploadFileBtn.textContent = 'ì—…ë¡œë“œ';

                            showStatus('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        }
                    );

                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    showStatus('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    editUploadFileBtn.disabled = false;
                    editUploadFileBtn.textContent = 'ì—…ë¡œë“œ';
                    editUploadProgress.classList.add('hidden');
                }
            });

            // í¸ì§‘ ëª¨ë‹¬ - íŒŒì¼ ì—…ë¡œë“œ ì·¨ì†Œ ë²„íŠ¼
            editCancelFileBtn.addEventListener('click', () => {
                editFileUploadArea.classList.add('hidden');
                editFileInput.value = '';
                editUploadProgress.classList.add('hidden');
                editUploadProgressBar.style.width = '0%';
            });

            // === ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ===

            // URL ìœ íš¨ì„± ê²€ì‚¬
            function isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }

            // ë¦¬ì†ŒìŠ¤ ID ìƒì„±
            function generateResourceId() {
                return 'resource_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }

            // ìë£Œ ëª©ë¡ ë Œë”ë§ (ìƒˆ ìˆ˜ì—… ìƒì„±)
            function renderResources() {
                resourcesList.innerHTML = '';

                if (tempResources.length === 0) {
                    resourcesList.innerHTML = '<p class="text-xs text-gray-500 italic">ì•„ì§ ì¶”ê°€ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                tempResources.forEach(resource => {
                    const resourceEl = createResourceElement(resource, false);
                    resourcesList.appendChild(resourceEl);
                });
            }

            // ìë£Œ ëª©ë¡ ë Œë”ë§ (ìˆ˜ì—… í¸ì§‘)
            function renderEditResources() {
                editResourcesList.innerHTML = '';

                if (editTempResources.length === 0) {
                    editResourcesList.innerHTML = '<p class="text-xs text-gray-500 italic">ì•„ì§ ì¶”ê°€ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                editTempResources.forEach(resource => {
                    const resourceEl = createResourceElement(resource, true);
                    editResourcesList.appendChild(resourceEl);
                });
            }

            // ìë£Œ ìš”ì†Œ ìƒì„±
            function createResourceElement(resource, isEdit) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';

                const icon = resource.type === 'link' ? 'ğŸ”—' : 'ğŸ“';
                const typeLabel = resource.type === 'link' ? 'ë§í¬' : 'íŒŒì¼';

                div.innerHTML = `
                    <div class="flex items-center space-x-2 flex-1 min-w-0">
                        <span class="text-lg">${icon}</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${resource.title}</p>
                            <p class="text-xs text-gray-500">
                                ${typeLabel}
                                ${resource.fileSize ? ' â€¢ ' + formatFileSize(resource.fileSize) : ''}
                            </p>
                        </div>
                    </div>
                    <button type="button" class="remove-resource-btn text-red-600 hover:text-red-800 text-sm font-medium"
                        data-resource-id="${resource.id}" data-is-edit="${isEdit}">
                        ì‚­ì œ
                    </button>
                `;

                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
                const removeBtn = div.querySelector('.remove-resource-btn');
                removeBtn.addEventListener('click', () => {
                    const resourceId = removeBtn.dataset.resourceId;
                    const isEditMode = removeBtn.dataset.isEdit === 'true';

                    if (isEditMode) {
                        editTempResources = editTempResources.filter(r => r.id !== resourceId);
                        renderEditResources();
                    } else {
                        tempResources = tempResources.filter(r => r.id !== resourceId);
                        renderResources();
                    }

                    showStatus('ìë£Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info', 2000);
                });

                return div;
            }

            // ìˆ˜ì—… í¸ì§‘ ê´€ë ¨ ìš”ì†Œë“¤
            const editLessonModal = document.getElementById('edit-lesson-modal');
            const closeEditModalBtn = document.getElementById('close-edit-modal');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editLessonForm = document.getElementById('edit-lesson-form');
            const editLessonIdInput = document.getElementById('edit-lesson-id');
            const editLessonTitleInput = document.getElementById('edit-lesson-title');
            const editLessonSubjectSelect = document.getElementById('edit-lesson-subject');
            const editLessonAiInstructionsInput = document.getElementById('edit-lesson-ai-instructions');
            const editLessonStudentDescriptionInput = document.getElementById('edit-lesson-student-description');
            const saveLessonBtn = document.getElementById('save-lesson-btn');

            // ìƒˆ ìˆ˜ì—… ìƒì„± í¼ ì œì¶œ
            createLessonForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const title = lessonTitleInput.value.trim();
                const subject = lessonSubjectSelect.value;
                const aiInstructions = lessonAiInstructionsInput.value.trim();
                const studentDescription = lessonStudentDescriptionInput.value.trim();

                if (!title || !subject) {
                    showStatus('ìˆ˜ì—… ì œëª©ê³¼ ê³¼ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                try {
                    createLessonBtn.textContent = 'ìƒì„± ì¤‘...';
                    createLessonBtn.disabled = true;

                    const result = await createLesson({
                        title,
                        subject,
                        aiInstructions: aiInstructions || null,
                        studentDescription: studentDescription || null,
                        resources: tempResources // í•™ìŠµ ìë£Œ ì¶”ê°€
                    });

                    showStatus('ìƒˆ ìˆ˜ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                    // í¼ ë¦¬ì…‹
                    createLessonForm.reset();
                    tempResources = []; // ì„ì‹œ ìë£Œ ë°°ì—´ ì´ˆê¸°í™”
                    renderResources(); // ìë£Œ ëª©ë¡ UI ì´ˆê¸°í™”

                    // ìˆ˜ì—… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadLessons();

                } catch (error) {
                    console.error('ìˆ˜ì—… ìƒì„± ì‹¤íŒ¨:', error);
                    showStatus(`ìˆ˜ì—… ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                } finally {
                    createLessonBtn.textContent = 'ìˆ˜ì—… ìƒì„±';
                    createLessonBtn.disabled = false;
                }
            });

            // ìˆ˜ì—… ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
            refreshLessonsBtn.addEventListener('click', () => {
                loadLessons();
            });

            // ìˆ˜ì—… í¸ì§‘ ëª¨ë‹¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤

            // ìˆ˜ì—… ì‚­ì œ ë²„íŠ¼
            const deleteLessonBtn = document.getElementById('delete-lesson-btn');
            deleteLessonBtn.addEventListener('click', async () => {
                const lessonId = editLessonIdInput.value;
                const lessonTitle = editLessonTitleInput.value;

                if (!lessonId) {
                    showStatus('ìˆ˜ì—… IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                // ì‚­ì œ í™•ì¸
                const confirmMessage = `ì •ë§ë¡œ "${lessonTitle}" ìˆ˜ì—…ì„ ì‚­ì œí•˜ì‹œê²ŒìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ìˆ˜ì—…ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                try {
                    deleteLessonBtn.textContent = 'ì‚­ì œ ì¤‘...';
                    deleteLessonBtn.disabled = true;

                    // deleteLesson Firebase Function í˜¸ì¶œ
                    const deleteLesson = httpsCallable(functions, 'deleteLesson');
                    await deleteLesson({ lessonId });

                    showStatus('ìˆ˜ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                    // ëª¨ë‹¬ ë‹«ê¸°
                    editLessonModal.classList.add('hidden');
                    editTempResources = []; // ì„ì‹œ ìë£Œ ë°°ì—´ ì´ˆê¸°í™”
                    renderEditResources(); // ìë£Œ ëª©ë¡ UI ì´ˆê¸°í™”

                    // ìˆ˜ì—… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadLessons();

                } catch (error) {
                    console.error('ìˆ˜ì—… ì‚­ì œ ì‹¤íŒ¨:', error);
                    showStatus(`ìˆ˜ì—… ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
                } finally {
                    deleteLessonBtn.textContent = 'ìˆ˜ì—… ì‚­ì œ';
                    deleteLessonBtn.disabled = false;
                }
            });

            // í¸ì§‘ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
            closeEditModalBtn.addEventListener('click', () => {
                editLessonModal.classList.add('hidden');
                // í¸ì§‘ ëª¨ë‹¬ ë‹«ì„ ë•Œ ì„ì‹œ ìë£Œ ë°°ì—´ ì´ˆê¸°í™”
                editTempResources = [];
                renderEditResources();
            });

            // í¸ì§‘ ì·¨ì†Œ ë²„íŠ¼
            cancelEditBtn.addEventListener('click', () => {
                editLessonModal.classList.add('hidden');
                // í¸ì§‘ ì·¨ì†Œ ì‹œ ì„ì‹œ ìë£Œ ë°°ì—´ ì´ˆê¸°í™”
                editTempResources = [];
                renderEditResources();
            });

            // í¸ì§‘ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
            editLessonModal.addEventListener('click', (e) => {
                if (e.target === editLessonModal) {
                    editLessonModal.classList.add('hidden');
                    // ëª¨ë‹¬ ë‹«ì„ ë•Œ ì„ì‹œ ìë£Œ ë°°ì—´ ì´ˆê¸°í™”
                    editTempResources = [];
                    renderEditResources();
                }
            });

            // ìˆ˜ì—… í¸ì§‘ í¼ ì œì¶œ
            editLessonForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const lessonId = editLessonIdInput.value;
                const title = editLessonTitleInput.value.trim();
                const subject = editLessonSubjectSelect.value;
                const aiInstructions = editLessonAiInstructionsInput.value.trim();
                const studentDescription = editLessonStudentDescriptionInput.value.trim();

                if (!title || !subject) {
                    showStatus('ìˆ˜ì—… ì œëª©ê³¼ ê³¼ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }

                try {
                    saveLessonBtn.textContent = 'ìˆ˜ì • ì¤‘...';
                    saveLessonBtn.disabled = true;

                    // updateLesson Firebase Function í˜¸ì¶œ
                    const updateLesson = httpsCallable(functions, 'updateLesson');
                    await updateLesson({
                        lessonId,
                        title,
                        subject,
                        aiInstructions: aiInstructions || null,
                        studentDescription: studentDescription || null,
                        resources: editTempResources // í•™ìŠµ ìë£Œ ì¶”ê°€
                    });

                    showStatus('ìˆ˜ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

                    // ëª¨ë‹¬ ë‹«ê¸°
                    editLessonModal.classList.add('hidden');
                    editTempResources = []; // ì„ì‹œ ìë£Œ ë°°ì—´ ì´ˆê¸°í™”
                    renderEditResources(); // ìë£Œ ëª©ë¡ UI ì´ˆê¸°í™”

                    // ìˆ˜ì—… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadLessons();

                } catch (error) {
                    console.error('ìˆ˜ì—… ìˆ˜ì • ì‹¤íŒ¨:', error);
                    showStatus(`ìˆ˜ì—… ìˆ˜ì • ì‹¤íŒ¨: ${error.message}`, 'error');
                } finally {
                    saveLessonBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
                    saveLessonBtn.disabled = false;
                }
            });

            // ìˆ˜ì—…ë³„ í•™ìƒ ì„¸ì…˜ ë¡œë“œ ê¸°ëŠ¥
            async function loadLessonsForAnalysis() {
                try {
                    // ìˆ˜ì—… ëª©ë¡ ë¡œë”© í‘œì‹œ
                    analysisLessonsLoading.classList.remove('hidden');
                    analysisLessonsEmpty.classList.add('hidden');
                    analysisLessonsList.innerHTML = '';

                    // ëŒ€í™” ìƒì„¸ê°€ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
                    conversationDetail.classList.add('hidden');
                    lessonStudentsSection.classList.add('hidden');

                    // ìˆ˜ì—… ì„ íƒ ì„¹ì…˜ í‘œì‹œ
                    document.querySelector('.bg-white.rounded-lg.shadow-sm.border.mb-6').classList.remove('hidden');

                    // ìˆ˜ì—… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    const result = await getLessons();
                    const lessons = result.data.lessons || [];

                    // ë¡œë”© ì¢…ë£Œ
                    analysisLessonsLoading.classList.add('hidden');

                    // ìˆ˜ì—…ì´ ì—†ëŠ” ê²½ìš°
                    if (lessons.length === 0) {
                        analysisLessonsEmpty.classList.remove('hidden');
                        return;
                    }

                    // ìˆ˜ì—… ëª©ë¡ ë Œë”ë§
                    lessons.forEach(lesson => {
                        const lessonCard = createLessonCardForAnalysis(lesson);
                        analysisLessonsList.appendChild(lessonCard);
                    });

                } catch (error) {
                    console.error('ë¶„ì„ìš© ìˆ˜ì—… ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showStatus('ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    analysisLessonsLoading.classList.add('hidden');
                    analysisLessonsEmpty.classList.remove('hidden');
                }
            }

            // ë¶„ì„ìš© ìˆ˜ì—… ì¹´ë“œ ìƒì„±
            function createLessonCardForAnalysis(lesson) {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-lg p-6 border border-gray-200 hover:border-blue-300 transition-colors card-hover';

                // ìƒì„±ì¼ í¬ë§·íŒ…
                let createdAtText = 'ìƒì„±ì¼ ì •ë³´ ì—†ìŒ';
                if (lesson.createdAt) {
                    try {
                        const date = new Date(lesson.createdAt);
                        if (!isNaN(date.getTime())) {
                            createdAtText = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                }

                const subjectName = subjectNames[lesson.subject] || lesson.subject;
                const studentCount = lesson.studentCount || 0;

                div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-900">${lesson.title}</h3>
                    <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${subjectName}</span>
                </div>
                <p class="text-sm text-gray-600 mb-3">${lesson.studentDescription || lesson.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                <div class="flex items-center justify-between text-sm text-gray-500">
                    <span>ìƒì„±ì¼: ${createdAtText}</span>
                    <span class="font-medium ${studentCount > 0 ? 'text-green-600' : ''}">
                        ì°¸ì—¬ í•™ìƒ: ${studentCount}ëª…
                    </span>
                </div>
            `;

                // ìˆ˜ì—… í´ë¦­ ì´ë²¤íŠ¸ - í•´ë‹¹ ìˆ˜ì—…ì˜ í•™ìƒ ì„¸ì…˜ ëª©ë¡ ë¡œë“œ
                div.addEventListener('click', () => {
                    loadLessonStudents(lesson);
                });

                return div;
            }

            // ìˆ˜ì—…ë³„ í•™ìƒ ì„¸ì…˜ ë¡œë“œ
            async function loadLessonStudents(lesson) {
                try {
                    // í˜„ì¬ ì„ íƒëœ ìˆ˜ì—… ì •ë³´ ì €ì¥
                    currentSelectedLesson = lesson;

                    // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    updateDownloadButtonText();

                    // ìˆ˜ì—… ì„ íƒ ì¹´ë“œ ìˆ¨ê¸°ê¸°
                    document.querySelector('.bg-white.rounded-lg.shadow-sm.border.mb-6').classList.add('hidden');

                    // í•™ìƒ ëª©ë¡ ì¹´ë“œ í‘œì‹œ
                    lessonStudentsSection.classList.remove('hidden');

                    // ì„ íƒëœ ìˆ˜ì—… ì •ë³´ í‘œì‹œ
                    selectedLessonTitle.textContent = lesson.title;
                    const subjectName = subjectNames[lesson.subject] || lesson.subject;
                    selectedLessonInfo.textContent = `ê³¼ëª©: ${subjectName} | ìˆ˜ì—… ì½”ë“œ: ${lesson.lessonCode}`;

                    // ë¡œë”© í‘œì‹œ
                    lessonStudentsLoading.classList.remove('hidden');
                    lessonStudentsEmpty.classList.add('hidden');
                    lessonStudentsList.innerHTML = '';

                    // í•™ìƒ ì„¸ì…˜ ë¡œë“œ
                    const result = await getStudentSessions({ lessonId: lesson.id });
                    const sessions = result.data.sessions || [];

                    // ë¡œë”© ì¢…ë£Œ
                    lessonStudentsLoading.classList.add('hidden');

                    // í•™ìƒì´ ì—†ëŠ” ê²½ìš°
                    if (sessions.length === 0) {
                        lessonStudentsEmpty.classList.remove('hidden');
                        return;
                    }

                    // í•™ìƒ ì´ë¦„ë³„ë¡œ ì„¸ì…˜ ê·¸ë£¹í™”
                    const groupedStudents = groupSessionsByStudentName(sessions);

                    // ê·¸ë£¹í™”ëœ í•™ìƒ ëª©ë¡ ë Œë”ë§
                    groupedStudents.forEach(studentGroup => {
                        const studentGroupElement = createStudentGroupElement(studentGroup);
                        lessonStudentsList.appendChild(studentGroupElement);
                    });

                } catch (error) {
                    console.error('ìˆ˜ì—…ë³„ í•™ìƒ ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showStatus('í•™ìƒ ì„¸ì…˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    lessonStudentsLoading.classList.add('hidden');
                    lessonStudentsEmpty.classList.remove('hidden');
                }
            }

            // ì‘ë‹µ ìœ í˜•ì„ ì˜ì–´ì—ì„œ í•œê¸€ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ëª¨ë“  ê³¼ëª© í¬í•¨)
            function convertResponseTypeToKorean(responseType) {
                const responseTypeMap = {
                    // ê¸°ë³¸ ìœ í˜•
                    'DEFAULT': 'ê¸°ë³¸ ì•ˆë‚´',

                    // ê³¼í•™ ê³¼ëª© ì‘ë‹µ ìœ í˜•
                    'CONCEPT_QUESTION': 'ê°œë… ì§ˆë¬¸',
                    'EXPLORATION_DEADLOCK': 'íƒìƒ‰ êµì°© ìƒíƒœ',
                    'FAILURE_REPORT': 'ì‹¤íŒ¨ ë³´ê³ ',
                    'SUCCESS_WITHOUT_PRINCIPLE': 'ì›ì¹™ ì—†ëŠ” ì„±ê³µ',
                    'HYPOTHESIS_INQUIRY': 'ê°€ì„¤ íƒêµ¬',

                    // ìˆ˜í•™ ê³¼ëª© ì‘ë‹µ ìœ í˜•
                    'CONCEPT_CONFUSION': 'ê°œë… í˜¼ë€',
                    'PROCEDURE_ERROR': 'ì ˆì°¨ ì˜¤ë¥˜',
                    'PROBLEM_SOLVING_BLOCK': 'ë¬¸ì œí•´ê²° ë§‰í˜',
                    'PATTERN_RECOGNITION_STRUGGLE': 'íŒ¨í„´ ì¸ì‹ ì–´ë ¤ì›€',
                    'MATHEMATICAL_REASONING': 'ìˆ˜í•™ì  ì¶”ë¡ ',
                    'CALCULATION_ANXIETY': 'ê³„ì‚° ë¶ˆì•ˆ',

                    // ì‚¬íšŒ ê³¼ëª© ì‘ë‹µ ìœ í˜•
                    'FACTUAL_CONFUSION': 'ì‚¬ì‹¤ í˜¼ë€',
                    'PERSPECTIVE_LIMITATION': 'ê´€ì  ì œí•œ',
                    'VALUE_CONFLICT': 'ê°€ì¹˜ ê°ˆë“±',
                    'SOCIAL_APATHY': 'ì‚¬íšŒì  ë¬´ê´€ì‹¬',
                    'CRITICAL_INQUIRY': 'ë¹„íŒì  íƒêµ¬',
                    'STEREOTYPE_BIAS': 'ê³ ì •ê´€ë… í¸ê²¬',

                    // êµ­ì–´ ê³¼ëª© ì‘ë‹µ ìœ í˜•
                    'TEXT_COMPREHENSION_QUESTION': 'í…ìŠ¤íŠ¸ ì´í•´ ì§ˆë¬¸',
                    'EXPRESSION_STRUGGLE': 'í‘œí˜„ ì–´ë ¤ì›€',
                    'INTERPRETATION_CONFUSION': 'í•´ì„ í˜¼ë€',
                    'SURFACE_UNDERSTANDING': 'í‘œë©´ì  ì´í•´',

                    // ê¸°íƒ€ ì¼ë°˜ì  ìœ í˜•ë“¤ (ê¸°ì¡´ ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©ë  ìˆ˜ ìˆëŠ”)
                    'CURIOSITY_DRIVEN': 'í˜¸ê¸°ì‹¬ ì£¼ë„',
                    'DIFFICULTY_EXPRESSION': 'ì–´ë ¤ì›€ í‘œí˜„',
                    'CONFIRMATION_SEEKING': 'í™•ì¸ ìš”ì²­'
                };

                return responseTypeMap[responseType] || responseType;
            }

            // Firestore Timestampë¥¼ JavaScript Dateë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ (Firebase v10 í˜¸í™˜ì„± ê°œì„ )
            function convertFirestoreTimestamp(timestamp, fieldName = 'unknown', sessionId = 'unknown') {
                console.log(`[TIMESTAMP DEBUG] ${fieldName} for session ${sessionId}:`, {
                    original: timestamp,
                    type: typeof timestamp,
                    isNull: timestamp === null,
                    isUndefined: timestamp === undefined,
                    constructor: timestamp?.constructor?.name,
                    hasToDate: timestamp?.toDate !== undefined,
                    hasSeconds: timestamp?.seconds !== undefined,
                    hasNanoseconds: timestamp?.nanoseconds !== undefined,
                    objectKeys: timestamp && typeof timestamp === 'object' ? Object.keys(timestamp) : null
                });

                if (!timestamp) {
                    console.log(`[TIMESTAMP DEBUG] ${fieldName} is null/undefined for session ${sessionId}`);
                    return null;
                }

                try {
                    // Firestore Timestamp ê°ì²´ì¸ ê²½ìš° (toDate ë©”ì„œë“œê°€ ìˆëŠ” ê²½ìš°)
                    if (timestamp && typeof timestamp === 'object' && typeof timestamp.toDate === 'function') {
                        const result = timestamp.toDate();
                        console.log(`[TIMESTAMP DEBUG] ${fieldName} converted using toDate():`, result);
                        return result;
                    }

                    // Firebase v10ì—ì„œ Timestampê°€ plain objectë¡œ serializedëœ ê²½ìš°
                    if (timestamp && typeof timestamp === 'object' &&
                        (timestamp.seconds !== undefined || timestamp._seconds !== undefined)) {

                        const seconds = timestamp.seconds || timestamp._seconds;
                        const nanoseconds = timestamp.nanoseconds || timestamp._nanoseconds || 0;

                        if (seconds !== undefined) {
                            // secondsë¥¼ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜í•˜ê³  nanosecondsë¥¼ ë”í•¨
                            const milliseconds = (seconds * 1000) + Math.floor(nanoseconds / 1000000);
                            const result = new Date(milliseconds);
                            console.log(`[TIMESTAMP DEBUG] ${fieldName} converted using seconds/nanoseconds:`, {
                                seconds,
                                nanoseconds,
                                milliseconds,
                                result
                            });
                            return result;
                        }
                    }

                    // Date ê°ì²´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
                    if (timestamp instanceof Date) {
                        console.log(`[TIMESTAMP DEBUG] ${fieldName} is already a Date object:`, timestamp);
                        return timestamp;
                    }

                    // ìˆ«ìì¸ ê²½ìš° (timestamp milliseconds)
                    if (typeof timestamp === 'number') {
                        const result = new Date(timestamp);
                        if (!isNaN(result.getTime())) {
                            console.log(`[TIMESTAMP DEBUG] ${fieldName} converted from number:`, result);
                            return result;
                        }
                    }

                    // ë¬¸ìì—´ì¸ ê²½ìš°
                    if (typeof timestamp === 'string') {
                        const result = new Date(timestamp);
                        if (!isNaN(result.getTime())) {
                            console.log(`[TIMESTAMP DEBUG] ${fieldName} converted from string:`, result);
                            return result;
                        }
                    }

                    console.log(`[TIMESTAMP DEBUG] ${fieldName} conversion failed - unsupported format:`, timestamp);
                    return null;

                } catch (error) {
                    console.error(`[TIMESTAMP DEBUG] Error converting ${fieldName} for session ${sessionId}:`, error);
                    return null;
                }
            }

            // í•™ìƒ ì´ë¦„ë³„ë¡œ ì„¸ì…˜ ê·¸ë£¹í™” í•¨ìˆ˜
            function groupSessionsByStudentName(sessions) {
                console.log('ì„¸ì…˜ ê·¸ë£¹í™” ì‹œì‘ - ì´ ì„¸ì…˜ ìˆ˜:', sessions.length);
                const grouped = {};

                sessions.forEach((session, index) => {
                    // ì‚­ì œ ë²„íŠ¼ ì¡°ê±´ ë””ë²„ê¹… ê°•í™”
                    const showDeleteButton = (session.messageCount <= 1 || session.messageCount === null || session.messageCount === undefined);

                    console.log(`[DELETE BUTTON DEBUG] ì„¸ì…˜ ${index + 1}:`, {
                        sessionId: session.sessionId,
                        studentName: session.studentName,
                        messageCount: session.messageCount,
                        messageCountType: typeof session.messageCount,
                        lastActivity: session.lastActivity,
                        createdAt: session.createdAt,
                        updatedAt: session.updatedAt,
                        timestamp: session.timestamp,
                        'ì¡°ê±´ê²€ì‚¬': {
                            'messageCount <= 1': session.messageCount <= 1,
                            'messageCount === null': session.messageCount === null,
                            'messageCount === undefined': session.messageCount === undefined,
                            'ìµœì¢…ì‚­ì œë²„íŠ¼í‘œì‹œ': showDeleteButton
                        }
                    });

                    const studentName = session.studentName;
                    if (!grouped[studentName]) {
                        grouped[studentName] = {
                            studentName: studentName,
                            sessions: [],
                            totalMessages: 0,
                            lastActivity: null
                        };
                    }

                    grouped[studentName].sessions.push(session);
                    grouped[studentName].totalMessages += session.messageCount || 0;

                    // ê°€ì¥ ìµœê·¼ í™œë™ ì‹œê°„ ì°¾ê¸° - ì„¸ì…˜ì˜ ì—¬ëŸ¬ ì‹œê°„ í•„ë“œ í™•ì¸ (ê°•í™”ëœ ë¡œì§)
                    let sessionActivity = null;

                    // ëª¨ë“  ê°€ëŠ¥í•œ ì‹œê°„ í•„ë“œ í™•ì¸ (ìš°ì„ ìˆœìœ„ ìˆœì„œ)
                    const timeFields = ['lastActivity', 'updatedAt', 'createdAt', 'timestamp'];

                    console.log(`[TIMESTAMP FALLBACK] ${studentName} ì„¸ì…˜ ${session.sessionId}ì˜ ì‹œê°„ í•„ë“œ íƒìƒ‰:`);

                    for (const field of timeFields) {
                        console.log(`[TIMESTAMP FALLBACK] ${field} í•„ë“œ í™•ì¸:`, session[field]);

                        if (session[field]) {
                            sessionActivity = convertFirestoreTimestamp(session[field], field, session.sessionId);
                            if (sessionActivity) {
                                console.log(`[TIMESTAMP FALLBACK] âœ… ${studentName} - ${field}ì—ì„œ ìœ íš¨í•œ ë‚ ì§œ ì°¾ìŒ:`, sessionActivity);
                                break;
                            } else {
                                console.log(`[TIMESTAMP FALLBACK] âŒ ${field} ë³€í™˜ ì‹¤íŒ¨`);
                            }
                        } else {
                            console.log(`[TIMESTAMP FALLBACK] ${field} í•„ë“œê°€ null/undefined`);
                        }
                    }

                    if (!sessionActivity) {
                        console.warn(`[TIMESTAMP FALLBACK] âš ï¸ ${studentName} ì„¸ì…˜ ${session.sessionId}ì—ì„œ ìœ íš¨í•œ ì‹œê°„ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í•¨. í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.`);
                        // ë§ˆì§€ë§‰ ìˆ˜ë‹¨ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ ì‚¬ìš©
                        sessionActivity = new Date();
                    }

                    if (sessionActivity && (!grouped[studentName].lastActivity || sessionActivity > grouped[studentName].lastActivity)) {
                        grouped[studentName].lastActivity = sessionActivity;
                    }
                });

                // ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ìµœê·¼ í™œë™ ìˆœìœ¼ë¡œ ì •ë ¬
                const groupedArray = Object.values(grouped);
                groupedArray.sort((a, b) => {
                    // null ê°’ ì²˜ë¦¬
                    if (!a.lastActivity && !b.lastActivity) return 0;
                    if (!a.lastActivity) return 1;
                    if (!b.lastActivity) return -1;
                    return b.lastActivity - a.lastActivity;
                });

                console.log('ê·¸ë£¹í™” ì™„ë£Œ:', groupedArray.map(g => ({
                    studentName: g.studentName,
                    sessionCount: g.sessions.length,
                    totalMessages: g.totalMessages,
                    lastActivity: g.lastActivity
                })));

                return groupedArray;
            }

            // í•™ìƒ ê·¸ë£¹ ìš”ì†Œ ìƒì„± í•¨ìˆ˜
            function createStudentGroupElement(studentGroup) {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-lg border border-gray-200 mb-3';

                // ë‚ ì§œ í¬ë§·íŒ…
                let lastActiveText = 'í™œë™ ì •ë³´ ì—†ìŒ';
                if (studentGroup.lastActivity) {
                    try {
                        lastActiveText = studentGroup.lastActivity.toLocaleString('ko-KR');
                    } catch (error) {
                        console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                }

                div.innerHTML = `
                    <!-- í•™ìƒ ê·¸ë£¹ í—¤ë” -->
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3">
                                    <h4 class="font-semibold text-gray-900 text-lg">${studentGroup.studentName}</h4>
                                    <span class="px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-full font-medium">
                                        ${studentGroup.sessions.length}ê°œ ì„¸ì…˜
                                    </span>
                                </div>
                                <div class="flex items-center space-x-4 mt-1 text-sm text-gray-600">
                                    <span>ì´ ëŒ€í™”: ${studentGroup.totalMessages}ê°œ</span>
                                    <span>ìµœê·¼ í™œë™: ${lastActiveText}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="delete-all-student-sessions-btn px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 font-medium transition-colors"
                                    data-student-name="${studentGroup.studentName}"
                                    title="${studentGroup.studentName} í•™ìƒì˜ ëª¨ë“  ì„¸ì…˜ ì‚­ì œ">
                                    ëª¨ë“  ì„¸ì…˜ ì‚­ì œ
                                </button>
                                <button class="toggle-sessions-btn px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 font-medium transition-colors"
                                    data-student="${studentGroup.studentName}">
                                    ì„¸ì…˜ ëª©ë¡ ë³´ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í•™ìƒ ì„¸ì…˜ ëª©ë¡ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
                    <div class="sessions-list hidden">
                        <div class="p-4 space-y-2">
                            ${studentGroup.sessions.map((session, index) => {
                    // ê°œë³„ ì„¸ì…˜ì˜ ë‚ ì§œ í¬ë§·íŒ…
                    const sessionDate = convertFirestoreTimestamp(session.lastActivity);
                    const sessionDateText = sessionDate ? sessionDate.toLocaleString('ko-KR') : '';

                    return `
                                <div class="session-item flex items-center justify-between p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition-colors">
                                    <div class="flex-1 cursor-pointer session-content" data-session-id="${session.sessionId}">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-900">ì„¸ì…˜ #${index + 1}</p>
                                                <p class="text-xs text-gray-600">
                                                    ëŒ€í™” ${session.messageCount || 0}ê°œ
                                                    ${sessionDateText ? ' â€¢ ' + sessionDateText : ''}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                    ${(session.messageCount <= 1 || session.messageCount === null || session.messageCount === undefined) ? `
                                            <button class="delete-session-btn px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 font-medium transition-colors"
                                                data-session-id="${session.sessionId}"
                                                data-student-name="${studentGroup.studentName}"
                                                title="ì„¸ì…˜ ì‚­ì œ (ëŒ€í™” ${session.messageCount || 0}ê°œ)">
                                                ì‚­ì œ
                                            </button>
                                        ` : ''}
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </div>
                                </div>
                            `;
                }).join('')}
                        </div>
                    </div>
                `;

                // ì„¸ì…˜ ëª©ë¡ í† ê¸€ ì´ë²¤íŠ¸
                const toggleBtn = div.querySelector('.toggle-sessions-btn');
                const sessionsList = div.querySelector('.sessions-list');

                toggleBtn.addEventListener('click', () => {
                    const isHidden = sessionsList.classList.contains('hidden');
                    if (isHidden) {
                        sessionsList.classList.remove('hidden');
                        toggleBtn.textContent = 'ì„¸ì…˜ ëª©ë¡ ìˆ¨ê¸°ê¸°';
                    } else {
                        sessionsList.classList.add('hidden');
                        toggleBtn.textContent = 'ì„¸ì…˜ ëª©ë¡ ë³´ê¸°';
                    }
                });

                // ê°œë³„ ì„¸ì…˜ í´ë¦­ ì´ë²¤íŠ¸
                div.querySelectorAll('.session-content').forEach(sessionContent => {
                    sessionContent.addEventListener('click', () => {
                        const sessionId = sessionContent.getAttribute('data-session-id');
                        const session = studentGroup.sessions.find(s => s.sessionId === sessionId);
                        if (session) {
                            loadStudentConversation(session);
                        }
                    });
                });

                // ì„¸ì…˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
                div.querySelectorAll('.delete-session-btn').forEach(deleteBtn => {
                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€

                        const sessionId = deleteBtn.getAttribute('data-session-id');
                        const studentName = deleteBtn.getAttribute('data-student-name');

                        if (!confirm(`${studentName} í•™ìƒì˜ ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                            return;
                        }

                        try {
                            deleteBtn.textContent = 'ì‚­ì œì¤‘...';
                            deleteBtn.disabled = true;

                            await deleteSession({ sessionId });

                            showStatus('ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

                            // DOMì—ì„œ í•´ë‹¹ ì„¸ì…˜ ìš”ì†Œ ì œê±°
                            const sessionItem = deleteBtn.closest('.session-item');
                            if (sessionItem) {
                                sessionItem.remove();
                            }

                            // í•´ë‹¹ í•™ìƒ ê·¸ë£¹ì˜ ì„¸ì…˜ ìˆ˜ ì—…ë°ì´íŠ¸
                            const studentGroupElement = deleteBtn.closest('.bg-white.rounded-lg.border.border-gray-200');
                            if (studentGroupElement) {
                                const remainingSessions = studentGroupElement.querySelectorAll('.session-item');
                                const sessionCountSpan = studentGroupElement.querySelector('.px-3.py-1.text-sm.bg-blue-100');
                                if (sessionCountSpan) {
                                    sessionCountSpan.textContent = `${remainingSessions.length}ê°œ ì„¸ì…˜`;
                                }

                                // ì„¸ì…˜ì´ ëª¨ë‘ ì‚­ì œë˜ë©´ í•™ìƒ ê·¸ë£¹ ìì²´ë¥¼ ì œê±°
                                if (remainingSessions.length === 0) {
                                    studentGroupElement.remove();

                                    // í•™ìƒì´ ëª¨ë‘ ì—†ì–´ì§€ë©´ ë¹ˆ ìƒíƒœ í‘œì‹œ
                                    const remainingStudents = lessonStudentsList.querySelectorAll('.bg-white.rounded-lg.border.border-gray-200');
                                    if (remainingStudents.length === 0) {
                                        lessonStudentsEmpty.classList.remove('hidden');
                                    }
                                }
                            }

                        } catch (error) {
                            console.error('ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨:', error);
                            showStatus(`ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');

                            deleteBtn.textContent = 'ì‚­ì œ';
                            deleteBtn.disabled = false;
                        }
                    });
                });

                // ëª¨ë“  ì„¸ì…˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ (ìƒˆë¡œ ì¶”ê°€)
                const deleteAllBtn = div.querySelector('.delete-all-student-sessions-btn');
                if (deleteAllBtn) {
                    deleteAllBtn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€

                        const studentName = deleteAllBtn.getAttribute('data-student-name');
                        const sessionCount = studentGroup.sessions.length;

                        if (!confirm(`${studentName} í•™ìƒì˜ ëª¨ë“  ì„¸ì…˜ ${sessionCount}ê°œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                            return;
                        }

                        try {
                            deleteAllBtn.textContent = 'ì‚­ì œì¤‘...';
                            deleteAllBtn.disabled = true;

                            // í•´ë‹¹ í•™ìƒì˜ ëª¨ë“  ì„¸ì…˜ ID ìˆ˜ì§‘
                            const sessionIds = studentGroup.sessions.map(session => session.sessionId);

                            // ê° ì„¸ì…˜ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‚­ì œ
                            for (const sessionId of sessionIds) {
                                await deleteSession({ sessionId });
                            }

                            showStatus(`${studentName} í•™ìƒì˜ ëª¨ë“  ì„¸ì…˜ ${sessionCount}ê°œê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

                            // DOMì—ì„œ í•´ë‹¹ í•™ìƒ ê·¸ë£¹ ì „ì²´ ì œê±°
                            const studentGroupElement = deleteAllBtn.closest('.bg-white.rounded-lg.border.border-gray-200');
                            if (studentGroupElement) {
                                studentGroupElement.remove();

                                // í•™ìƒì´ ëª¨ë‘ ì—†ì–´ì§€ë©´ ë¹ˆ ìƒíƒœ í‘œì‹œ
                                const remainingStudents = lessonStudentsList.querySelectorAll('.bg-white.rounded-lg.border.border-gray-200');
                                if (remainingStudents.length === 0) {
                                    lessonStudentsEmpty.classList.remove('hidden');
                                }
                            }

                        } catch (error) {
                            console.error('ëª¨ë“  ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨:', error);
                            showStatus(`ëª¨ë“  ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');

                            deleteAllBtn.textContent = 'ëª¨ë“  ì„¸ì…˜ ì‚­ì œ';
                            deleteAllBtn.disabled = false;
                        }
                    });
                }

                return div;
            }

            // ìˆ˜ì—…ë³„ í•™ìƒ ìš”ì†Œ ìƒì„±
            function createLessonStudentElement(session) {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors';

                // ë‚ ì§œ ì²˜ë¦¬ ê°œì„ 
                let lastActive = 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                if (session.lastActive) {
                    try {
                        const date = new Date(session.lastActive);
                        if (!isNaN(date.getTime())) {
                            lastActive = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', error);
                    }
                }

                const messageCount = session.messageCount || 0;

                div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900">${session.studentName}</h4>
                        <p class="text-sm text-gray-500">ëŒ€í™” ë©”ì‹œì§€ ìˆ˜: ${messageCount}ê°œ</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `;

                // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                div.addEventListener('click', () => {
                    loadStudentConversation(session);
                });

                return div;
            }

            // ìˆ˜ì—… ëª©ë¡ ë¡œë“œ
            async function loadLessons() {
                try {
                    lessonsLoading.classList.remove('hidden');
                    lessonsEmpty.classList.add('hidden');
                    lessonsList.innerHTML = '';

                    const result = await getLessons();
                    const lessons = result.data.lessons || [];

                    // ë””ë²„ê¹…: ë¡œë“œëœ ìˆ˜ì—… ëª©ë¡ í™•ì¸
                    console.log('ë¡œë“œëœ ìˆ˜ì—… ëª©ë¡:', lessons);

                    lessonsLoading.classList.add('hidden');

                    if (lessons.length === 0) {
                        lessonsEmpty.classList.remove('hidden');
                        return;
                    }

                    // ìˆ˜ì—… ëª©ë¡ ë Œë”ë§
                    lessons.forEach(lesson => {
                        const lessonElement = createLessonElement(lesson);
                        lessonsList.appendChild(lessonElement);
                    });

                } catch (error) {
                    console.error('ìˆ˜ì—… ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    showStatus('ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    lessonsLoading.classList.add('hidden');
                    lessonsEmpty.classList.remove('hidden');
                }
            }

            // ê³¼ëª© ì´ë¦„ ë§¤í•‘ì€ ìƒë‹¨ì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨

            // ìˆ˜ì—… ìš”ì†Œ ìƒì„±
            function createLessonElement(lesson) {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-6 border border-gray-200 hover:border-blue-300 transition-colors';

                // ìƒì„±ì¼ í¬ë§·íŒ… (Firestore Timestamp ì§€ì›)
                let createdAtText = 'ìƒì„±ì¼ ì •ë³´ ì—†ìŒ';
                if (lesson.createdAt) {
                    try {
                        let date;

                        // Firestore Timestamp ê°ì²´ì¸ ê²½ìš°
                        if (lesson.createdAt && typeof lesson.createdAt === 'object' && lesson.createdAt.toDate) {
                            date = lesson.createdAt.toDate();
                        }
                        // Firestore v9+ ì—ì„œ ì§ë ¬í™”ëœ timestamp ê°ì²´ì¸ ê²½ìš°
                        else if (lesson.createdAt && typeof lesson.createdAt === 'object' &&
                            (lesson.createdAt._seconds || lesson.createdAt.seconds)) {
                            const seconds = lesson.createdAt._seconds || lesson.createdAt.seconds;
                            const nanoseconds = lesson.createdAt._nanoseconds || lesson.createdAt.nanoseconds || 0;
                            date = new Date((seconds * 1000) + Math.floor(nanoseconds / 1000000));
                        }
                        // ì¼ë°˜ Date ê°ì²´ë‚˜ íƒ€ì„ìŠ¤íƒ¬í”„ì¸ ê²½ìš°
                        else {
                            date = new Date(lesson.createdAt);
                        }

                        if (date && !isNaN(date.getTime())) {
                            createdAtText = date.toLocaleString('ko-KR');
                        }
                    } catch (error) {
                        console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', error, lesson.createdAt);
                    }
                }

                const subjectName = subjectNames[lesson.subject] || lesson.subject;

                div.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <h3 class="text-lg font-semibold text-gray-900">${lesson.title}</h3>
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${subjectName}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">${lesson.studentDescription || lesson.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            <span>ìƒì„±ì¼: ${createdAtText}</span>
                            <span>ìˆ˜ì—… ì½”ë“œ: <code class="bg-gray-200 px-1 rounded font-mono">${lesson.lessonCode}</code></span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <div class="flex items-center space-x-2">
                        <button class="edit-lesson-btn text-sm bg-yellow-100 text-yellow-700 px-3 py-1 rounded-md hover:bg-yellow-200 font-medium" 
                            data-lesson-id="${lesson.id}" data-title="${lesson.title}" data-subject="${lesson.subject}" data-description="${lesson.studentDescription || lesson.description || ''}">
                            í¸ì§‘
                        </button>
                        <button class="copy-lesson-code-btn text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200 font-medium" data-code="${lesson.lessonCode}">
                            ì½”ë“œ ë³µì‚¬
                        </button>
                        <button class="show-qr-btn text-sm bg-green-100 text-green-700 px-3 py-1 rounded-md hover:bg-green-200 font-medium" data-lesson-id="${lesson.id}" data-code="${lesson.lessonCode}" data-title="${lesson.title}">
                            QR ì½”ë“œ
                        </button>
                    </div>
                    <div class="text-xs text-gray-500">
                        ì°¸ì—¬ í•™ìƒ: <span class="font-medium">${lesson.studentCount || 0}ëª…</span>
                    </div>
                </div>
            `;

                // ìˆ˜ì—… ì½”ë“œ ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
                const copyBtn = div.querySelector('.copy-lesson-code-btn');
                copyBtn.addEventListener('click', async () => {
                    const code = copyBtn.dataset.code;
                    try {
                        await navigator.clipboard.writeText(code);
                        showStatus('ìˆ˜ì—… ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } catch (error) {
                        // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš°
                        const textArea = document.createElement('textarea');
                        textArea.value = code;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showStatus('ìˆ˜ì—… ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }
                });

                // QR ì½”ë“œ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                const qrBtn = div.querySelector('.show-qr-btn');
                qrBtn.addEventListener('click', () => {
                    showQRCodeModal({
                        lessonCode: qrBtn.dataset.code,
                        title: qrBtn.dataset.title,
                        studentDescription: lesson.studentDescription || ''
                    });
                });

                // í¸ì§‘ ë²„íŠ¼ ì´ë²¤íŠ¸
                const editBtn = div.querySelector('.edit-lesson-btn');
                editBtn.addEventListener('click', () => {
                    const lessonId = editBtn.dataset.lessonId;
                    const title = editBtn.dataset.title;
                    const subject = editBtn.dataset.subject;
                    const description = editBtn.dataset.description;

                    // ë””ë²„ê¹…: lesson ê°ì²´ í™•ì¸
                    console.log('í¸ì§‘í•  ìˆ˜ì—… ë°ì´í„°:', lesson);
                    console.log('ìˆ˜ì—… ìë£Œ(resources):', lesson.resources);

                    // í¸ì§‘ ëª¨ë‹¬ì— ë°ì´í„° ë¡œë“œ
                    editLessonIdInput.value = lessonId;
                    editLessonTitleInput.value = title;
                    editLessonSubjectSelect.value = subject;
                    editLessonAiInstructionsInput.value = lesson.aiInstructions || '';
                    editLessonStudentDescriptionInput.value = lesson.studentDescription || '';

                    // ê¸°ì¡´ ìë£Œ ë¡œë“œ (resources í•„ë“œê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”)
                    editTempResources = Array.isArray(lesson.resources) ? [...lesson.resources] : [];
                    console.log('editTempResourcesì— ë¡œë“œëœ ìë£Œ:', editTempResources);
                    renderEditResources();

                    // í¸ì§‘ ëª¨ë‹¬ì—ì„œ í…œí”Œë¦¿ UI ì´ˆê¸°í™” (ê³¼ëª©ì— ë§ëŠ” í…œí”Œë¦¿ ë²„íŠ¼ë“¤ í‘œì‹œ)
                    if (subject && templateManager) {
                        templateManager.renderModeButtons(
                            '.edit-template-mode-buttons',
                            subject,
                            '#edit-lesson-ai-instructions'
                        );
                    }

                    // í¸ì§‘ ëª¨ë‹¬ í‘œì‹œ
                    editLessonModal.classList.remove('hidden');
                });

                return div;
            }

            // QR ì½”ë“œ ëª¨ë‹¬ ìƒì„± ë° í‘œì‹œ
            function showQRCodeModal(lesson) {
                // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
                const existingModal = document.getElementById('qr-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                // ëª¨ë‹¬ HTML ìƒì„±
                const modal = document.createElement('div');
                modal.id = 'qr-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';

                modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 max-h-full overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">${lesson.title}</h3>
                        <button id="close-qr-modal" class="text-gray-400 hover:text-gray-600 p-1">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-center">
                        <div class="mb-4">
                            <h4 class="text-lg font-medium text-gray-700 mb-3">ğŸ“± QR ì½”ë“œë¡œ ìˆ˜ì—… ì°¸ì—¬</h4>
                            <div id="qr-code-container" class="flex justify-center mb-4 p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors" title="í´ë¦­í•˜ë©´ í¬ê²Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤">
                                <!-- QR ì½”ë“œê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                            </div>
                            <button id="enlarge-qr-btn" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 font-medium mb-4 flex items-center space-x-2 mx-auto">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                                </svg>
                                <span>í¬ê²Œ ë³´ê¸°</span>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                            <p class="text-sm text-blue-700 mb-2 font-medium">ìˆ˜ì—… ì½”ë“œ</p>
                            <code class="text-xl font-mono font-bold text-blue-800">${lesson.lessonCode}</code>
                        </div>
                        
                        ${lesson.studentDescription ? `
                        <div class="bg-green-50 border border-green-200 rounded-md p-4 mb-4">
                            <p class="text-sm text-green-700 mb-2 font-medium">ğŸ“ ìˆ˜ì—… ì„¤ëª… (í•™ìƒì—ê²Œ í‘œì‹œ)</p>
                            <p class="text-sm text-gray-700">${lesson.studentDescription}</p>
                        </div>
                        ` : ''}
                        
                        <div class="space-y-2 text-sm text-gray-600 mb-6">
                            <p class="font-medium">ğŸ“‹ ì‚¬ìš© ë°©ë²•</p>
                            <p>â€¢ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜</p>
                            <p>â€¢ í•™ìƒì´ ì§ì ‘ ìˆ˜ì—… ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button id="copy-lesson-code-btn" class="bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 font-medium flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                <span>ì½”ë“œ ë³µì‚¬</span>
                            </button>
                            <button id="copy-lesson-link-btn" class="bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 font-medium flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.1a3.994 3.994 0 011.536-2.846"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.172 13.828a4 4 0 005.656 0l4-4a4 4 0 10-5.656-5.656l-1.1 1.1a3.994 3.994 0 01-2.846 1.536"></path>
                                </svg>
                                <span>ë§í¬ ë³µì‚¬</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- í™•ëŒ€ QR ì½”ë“œ ëª¨ë‹¬ -->
                <div id="enlarged-qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-60">
                    <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900">QR ì½”ë“œ</h4>
                            <button id="close-enlarged-qr" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="enlarged-qr-container" class="mb-4">
                            <!-- í™•ëŒ€ëœ QR ì½”ë“œê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                        <p class="text-sm text-gray-600">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ìˆ˜ì—…ì— ì°¸ì—¬í•˜ì„¸ìš”</p>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);

                // QR ì½”ë“œ ìƒì„±
                const qrContainer = document.getElementById('qr-code-container');
                const canvas = document.createElement('canvas');

                // ë©”ì¸ ì‚¬ì´íŠ¸ URL + ìˆ˜ì—… ì½”ë“œë¥¼ í¬í•¨í•œ ë§í¬ ìƒì„±
                const lessonUrl = `https://science-aichatbot.web.app/?lesson=${lesson.lessonCode}`;

                // QRious ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸°
                const generateQR = () => {
                    if (typeof QRious === 'undefined') {
                        // QRiousê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ 100ms í›„ ì¬ì‹œë„
                        setTimeout(generateQR, 100);
                        return;
                    }

                    try {
                        const qr = new QRious({
                            element: canvas,
                            value: lessonUrl,
                            size: 240,
                            background: '#ffffff',
                            foreground: '#1f2937'
                        });
                        qrContainer.appendChild(canvas);
                    } catch (error) {
                        console.error('QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
                        qrContainer.innerHTML = '<p class="text-red-600">QR ì½”ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                    }
                };

                generateQR();

                // ëª¨ë‹¬ ë‹«ê¸°
                const closeBtn = document.getElementById('close-qr-modal');
                closeBtn.addEventListener('click', () => {
                    modal.remove();
                });

                // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                // QR ì½”ë“œ ì»¨í…Œì´ë„ˆ í´ë¦­ìœ¼ë¡œ í™•ëŒ€
                qrContainer.addEventListener('click', showEnlargedQR);

                // QR ì½”ë“œ í™•ëŒ€ ë²„íŠ¼
                const enlargeBtn = document.getElementById('enlarge-qr-btn');
                enlargeBtn.addEventListener('click', showEnlargedQR);

                function showEnlargedQR() {
                    const enlargedModal = document.getElementById('enlarged-qr-modal');
                    const enlargedContainer = document.getElementById('enlarged-qr-container');

                    // í™•ëŒ€ëœ QR ì½”ë“œ ìƒì„±
                    enlargedContainer.innerHTML = '';
                    const enlargedCanvas = document.createElement('canvas');

                    const generateEnlargedQR = () => {
                        if (typeof QRious === 'undefined') {
                            setTimeout(generateEnlargedQR, 100);
                            return;
                        }

                        try {
                            const enlargedQr = new QRious({
                                element: enlargedCanvas,
                                value: lessonUrl,
                                size: 320,
                                background: '#ffffff',
                                foreground: '#1f2937'
                            });
                            enlargedContainer.appendChild(enlargedCanvas);
                        } catch (error) {
                            console.error('í™•ëŒ€ QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
                            enlargedContainer.innerHTML = '<p class="text-red-600">QR ì½”ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                        }
                    };

                    generateEnlargedQR();

                    enlargedModal.classList.remove('hidden');
                }

                // í™•ëŒ€ ëª¨ë‹¬ ë‹«ê¸°
                const closeEnlargedBtn = document.getElementById('close-enlarged-qr');
                closeEnlargedBtn.addEventListener('click', () => {
                    document.getElementById('enlarged-qr-modal').classList.add('hidden');
                });

                // í™•ëŒ€ ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
                document.getElementById('enlarged-qr-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'enlarged-qr-modal') {
                        document.getElementById('enlarged-qr-modal').classList.add('hidden');
                    }
                });

                // ìˆ˜ì—… ì½”ë“œ ë³µì‚¬
                const copyCodeBtn = document.getElementById('copy-lesson-code-btn');
                copyCodeBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(lesson.lessonCode);
                        showStatus('ìˆ˜ì—… ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } catch (error) {
                        // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš°
                        const textArea = document.createElement('textarea');
                        textArea.value = lesson.lessonCode;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showStatus('ìˆ˜ì—… ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }
                });

                // ìˆ˜ì—… ë§í¬ ë³µì‚¬
                const copyLinkBtn = document.getElementById('copy-lesson-link-btn');
                copyLinkBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(lessonUrl);
                        showStatus('ìˆ˜ì—… ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } catch (error) {
                        // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš°
                        const textArea = document.createElement('textarea');
                        textArea.value = lessonUrl;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showStatus('ìˆ˜ì—… ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }
                });
            }

            // í…œí”Œë¦¿ ì ìš© í•¨ìˆ˜ë“¤
            function applyTemplate() {
                templateManager.applySelectedTemplate();
            }

            function clearTemplate() {
                templateManager.clearContent();
            }

            // ìˆ˜ì—… ìƒì„±/í¸ì§‘ ì‹œ í…œí”Œë¦¿ UI ì´ˆê¸°í™”
            function initTemplateUI() {
                console.log('í…œí”Œë¦¿ UI ì´ˆê¸°í™” ì‹œì‘');

                // ìˆ˜ì—… ìƒì„± í¼ì˜ í…œí”Œë¦¿ ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ì—°ê²°
                const createApplyBtn = document.getElementById('apply-template-btn');
                const createClearBtn = document.getElementById('clear-template-btn');

                if (createApplyBtn) {
                    createApplyBtn.addEventListener('click', applyTemplate);
                    console.log('ìˆ˜ì—… ìƒì„± í…œí”Œë¦¿ ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°ë¨');
                }

                if (createClearBtn) {
                    createClearBtn.addEventListener('click', clearTemplate);
                    console.log('ìˆ˜ì—… ìƒì„± í…œí”Œë¦¿ í´ë¦¬ì–´ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°ë¨');
                }

                // ìˆ˜ì—… í¸ì§‘ í¼ì˜ í…œí”Œë¦¿ ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ì—°ê²°
                const editApplyBtn = document.getElementById('edit-apply-template-btn');
                const editClearBtn = document.getElementById('edit-clear-template-btn');

                if (editApplyBtn) {
                    editApplyBtn.addEventListener('click', applyTemplate);
                    console.log('ìˆ˜ì—… í¸ì§‘ í…œí”Œë¦¿ ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°ë¨');
                }

                if (editClearBtn) {
                    editClearBtn.addEventListener('click', clearTemplate);
                    console.log('ìˆ˜ì—… í¸ì§‘ í…œí”Œë¦¿ í´ë¦¬ì–´ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°ë¨');
                }

                // ê³¼ëª© ë³€ê²½ ì‹œ í…œí”Œë¦¿ ëª¨ë“œ ë²„íŠ¼ë“¤ ì—…ë°ì´íŠ¸
                const lessonSubjectSelect = document.getElementById('lesson-subject');
                const editLessonSubjectSelect = document.getElementById('edit-lesson-subject');

                if (lessonSubjectSelect) {
                    console.log('ìˆ˜ì—… ê³¼ëª© ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì•˜ìŒ');

                    lessonSubjectSelect.addEventListener('change', (e) => {
                        const subject = e.target.value;
                        console.log('ê³¼ëª© ë³€ê²½ë¨:', subject);
                        templateManager.renderModeButtons(
                            '.template-mode-buttons',
                            subject,
                            '#lesson-ai-instructions'
                        );
                    });

                    // ì´ˆê¸° ë¡œë“œ ì‹œ í˜„ì¬ ì„ íƒëœ ê³¼ëª©ìœ¼ë¡œ í…œí”Œë¦¿ ë²„íŠ¼ë“¤ ìƒì„±
                    const currentSubject = lessonSubjectSelect.value;
                    if (currentSubject) {
                        console.log('ì´ˆê¸° ê³¼ëª©ìœ¼ë¡œ í…œí”Œë¦¿ ë²„íŠ¼ ìƒì„±:', currentSubject);
                        templateManager.renderModeButtons(
                            '.template-mode-buttons',
                            currentSubject,
                            '#lesson-ai-instructions'
                        );
                    }
                } else {
                    console.log('ìˆ˜ì—… ê³¼ëª© ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }

                if (editLessonSubjectSelect) {
                    console.log('ìˆ˜ì—… í¸ì§‘ ê³¼ëª© ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì•˜ìŒ');

                    editLessonSubjectSelect.addEventListener('change', (e) => {
                        const subject = e.target.value;
                        console.log('í¸ì§‘ ëª¨ë‹¬ ê³¼ëª© ë³€ê²½ë¨:', subject);
                        templateManager.renderModeButtons(
                            '.edit-template-mode-buttons',
                            subject,
                            '#edit-lesson-ai-instructions'
                        );
                    });
                } else {
                    console.log('ìˆ˜ì—… í¸ì§‘ ê³¼ëª© ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }

                console.log('í…œí”Œë¦¿ UI ì´ˆê¸°í™” ì™„ë£Œ');
            }

            // DOMContentLoaded ì´ë²¤íŠ¸ì—ì„œ í…œí”Œë¦¿ UI ì´ˆê¸°í™”
            document.addEventListener('DOMContentLoaded', function () {
                // í˜ì´ì§€ ë¡œë“œ í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì´ˆê¸°í™” (ë‹¤ë¥¸ ì´ˆê¸°í™”ê°€ ì™„ë£Œëœ í›„)
                setTimeout(initTemplateUI, 500);
            });

            // ê¸°ì¡´ loadTeacherInfo í•¨ìˆ˜ ìˆ˜ì •í•˜ì—¬ ì„¹ì…˜ë³„ UI ì—…ë°ì´íŠ¸
            const originalLoadTeacherInfo = loadTeacherInfo;
            loadTeacherInfo = async function () {
                await originalLoadTeacherInfo();

                // í˜„ì¬ ì„¹ì…˜ì— ë”°ë¼ UI ì—…ë°ì´íŠ¸
                if (currentSection === 'prompts') {
                    if (currentSettings && currentSettings.hasApiKey) {
                        adaptivePromptSettingsSection.classList.remove('hidden');
                    }
                }
            };

            // ì¼ê´„ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
            document.addEventListener('DOMContentLoaded', function () {
                // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í† ê¸€
                const bulkDownloadBtn = document.getElementById('bulk-download-btn');
                const bulkDownloadMenu = document.getElementById('bulk-download-menu');

                if (bulkDownloadBtn && bulkDownloadMenu) {
                    bulkDownloadBtn.addEventListener('click', () => {
                        bulkDownloadMenu.classList.toggle('hidden');
                    });

                    // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('#bulk-download-dropdown')) {
                            bulkDownloadMenu.classList.add('hidden');
                        }
                    });
                }

                // ì „ì²´ ìˆ˜ì—… ë°ì´í„° ë‹¤ìš´ë¡œë“œ (ì„ íƒëœ ìˆ˜ì—…ì´ ìˆìœ¼ë©´ í•´ë‹¹ ìˆ˜ì—…ë§Œ, ì—†ìœ¼ë©´ ì „ì²´)
                const downloadAllLessonsBtn = document.getElementById('download-all-lessons');
                if (downloadAllLessonsBtn) {
                    downloadAllLessonsBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        bulkDownloadMenu.classList.add('hidden');

                        try {
                            if (currentSelectedLesson) {
                                // ì„ íƒëœ ìˆ˜ì—…ì˜ ë°ì´í„°ë§Œ ë‹¤ìš´ë¡œë“œ
                                showStatus(`'${currentSelectedLesson.title}' ìˆ˜ì—… ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`, 'info');

                                const exportLessonData = httpsCallable(functions, 'exportLessonData');
                                const result = await exportLessonData({ lessonId: currentSelectedLesson.id });

                                if (result.data.success) {
                                    const fileName = `${currentSelectedLesson.title}_ìˆ˜ì—…ë°ì´í„°_${new Date().toISOString().split('T')[0]}.csv`;
                                    downloadCSV(result.data.data, fileName);
                                    showStatus(`'${currentSelectedLesson.title}' ìˆ˜ì—…ì˜ ${result.data.totalRecords}ê±´ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                                }
                            } else {
                                // ì „ì²´ ìˆ˜ì—… ë°ì´í„° ë‹¤ìš´ë¡œë“œ
                                showStatus('ì „ì²´ ìˆ˜ì—… ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');

                                const exportAllLessonsData = httpsCallable(functions, 'exportAllLessonsData');
                                const result = await exportAllLessonsData();

                                if (result.data.success) {
                                    downloadCSV(result.data.data, `ì „ì²´ìˆ˜ì—…ë°ì´í„°_${new Date().toISOString().split('T')[0]}.csv`);
                                    showStatus(`ì „ì²´ ${result.data.totalRecords}ê±´ì˜ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                                }
                            }
                        } catch (error) {
                            console.error('ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                            showStatus('ë°ì´í„° ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                        }
                    });
                }

                // ì„ íƒëœ ìˆ˜ì—… ìš”ì•½ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ
                const downloadLessonSummaryBtn = document.getElementById('download-lesson-summary');
                if (downloadLessonSummaryBtn) {
                    downloadLessonSummaryBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        bulkDownloadMenu.classList.add('hidden');

                        if (!currentSelectedLesson) {
                            showStatus('ìˆ˜ì—…ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                            return;
                        }

                        try {
                            showStatus(`'${currentSelectedLesson.title}' ìˆ˜ì—… ìš”ì•½ ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`, 'info');

                            const generateLessonSummaryReport = httpsCallable(functions, 'generateLessonSummaryReport');
                            const reportResult = await generateLessonSummaryReport({ lessonId: currentSelectedLesson.id });

                            if (reportResult.data.success) {
                                const report = reportResult.data.report;
                                const reportData = [{
                                    ìˆ˜ì—…ëª…: report.lessonTitle,
                                    ê³¼ëª©: report.subject,
                                    ìƒì„±ì¼: report.createdAt ? new Date(report.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : '',
                                    ì°¸ì—¬í•™ìƒìˆ˜: report.totalStudents,
                                    ì´ëŒ€í™”ìˆ˜: report.totalConversations,
                                    ì´ì„¸ì…˜ìˆ˜: report.totalSessions,
                                    AIë¶„ì„: report.aiAnalysis.replace(/\n/g, ' '),
                                    ë¶„ì„ìƒì„±ì¼: report.generatedAt
                                }];

                                const fileName = `${currentSelectedLesson.title}_ìš”ì•½ë³´ê³ ì„œ_${new Date().toISOString().split('T')[0]}.csv`;
                                downloadCSV(reportData, fileName);
                                showStatus(`'${currentSelectedLesson.title}' ìˆ˜ì—…ì˜ ìš”ì•½ ë³´ê³ ì„œë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                            } else {
                                showStatus('ë³´ê³ ì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                            }
                        } catch (error) {
                            console.error('ìš”ì•½ ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                            showStatus('ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                        }
                    });
                }

                // ì„ íƒëœ ìˆ˜ì—… í•™ìƒ ì°¸ì—¬ë„ ë¶„ì„ ë‹¤ìš´ë¡œë“œ
                const downloadParticipationReportBtn = document.getElementById('download-participation-report');
                if (downloadParticipationReportBtn) {
                    downloadParticipationReportBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        bulkDownloadMenu.classList.add('hidden');

                        if (!currentSelectedLesson) {
                            showStatus('ìˆ˜ì—…ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                            return;
                        }

                        try {
                            showStatus(`'${currentSelectedLesson.title}' ìˆ˜ì—…ì˜ í•™ìƒ ì°¸ì—¬ë„ ë¶„ì„ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`, 'info');

                            const generateLessonParticipationReport = httpsCallable(functions, 'generateLessonParticipationReport');
                            const result = await generateLessonParticipationReport({ lessonId: currentSelectedLesson.id });

                            if (result.data.success) {
                                const fileName = `${currentSelectedLesson.title}_í•™ìƒì°¸ì—¬ë„ë¶„ì„_${new Date().toISOString().split('T')[0]}.csv`;
                                downloadCSV(result.data.data, fileName);
                                showStatus(`'${currentSelectedLesson.title}' ìˆ˜ì—…ì˜ ${result.data.totalRecords}ê±´ ì°¸ì—¬ë„ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                            }
                        } catch (error) {
                            console.error('ì°¸ì—¬ë„ ë¶„ì„ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                            showStatus('ì°¸ì—¬ë„ ë¶„ì„ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                        }
                    });
                }
            });

            // CSV ë‹¤ìš´ë¡œë“œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
            function downloadCSV(data, filename) {
                if (!data || data.length === 0) {
                    showStatus('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                // CSV í—¤ë” ìƒì„±
                const headers = Object.keys(data[0]);
                const csvContent = [headers.join(',')];

                // ë°ì´í„° í–‰ ìƒì„±
                data.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header] || '';
                        // CSVì—ì„œ ì½¤ë§ˆì™€ ë”°ì˜´í‘œ ì²˜ë¦¬
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            return '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value;
                    });
                    csvContent.push(values.join(','));
                });

                // BOM ì¶”ê°€í•˜ì—¬ í•œê¸€ ì¸ì½”ë”© ë¬¸ì œ í•´ê²°
                const csvString = '\uFEFF' + csvContent.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });

                // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
            }
        </script>
</body>

</html>