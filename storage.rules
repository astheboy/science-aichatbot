rules_version = '2';

// Firebase Storage Security Rules for Science AI Chatbot
// ì´ ê·œì¹™ì€ êµìœ¡ìš© AI ì±—ë´‡ì˜ íŒŒì¼ ì—…ë¡œë“œ ë° ì ‘ê·¼ì„ ê´€ë¦¬í•©ë‹ˆë‹¤
// 30ì¼ í›„ ìë™ ë§Œë£Œë˜ëŠ” í…ŒìŠ¤íŠ¸ ëª¨ë“œ ëŒ€ì²´ìš© ê·œì¹™
service firebase.storage {
  match /b/{bucket}/o {
    
    // ğŸ“ êµì‚¬ ìˆ˜ì—… ìë£Œ (lessons/ ê²½ë¡œ)
    // teacher.htmlì—ì„œ ì‚¬ìš©ë˜ëŠ” íŒŒì¼ ì—…ë¡œë“œ ê²½ë¡œ
    match /lessons/{fileName} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì í—ˆìš© (í•™ìƒë“¤ì´ ìˆ˜ì—… ìë£Œì— ì ‘ê·¼)
      allow read: if true;
      
      // ì“°ê¸°: ì¸ì¦ëœ êµì‚¬ë§Œ í—ˆìš© (Google OAuth ë¡œê·¸ì¸ í•„ìš”)
      allow write: if request.auth != null 
        && request.auth.token.email != null
        && request.auth.token.email_verified == true
        // íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
        && request.resource.size < 10 * 1024 * 1024
        // ì§€ì› íŒŒì¼ í˜•ì‹ ì œí•œ
        && (
          request.resource.contentType.matches('image/.*') ||
          request.resource.contentType == 'application/pdf' ||
          request.resource.contentType == 'text/plain' ||
          request.resource.contentType.matches('application/.*document.*') ||
          request.resource.contentType.matches('application/.*presentation.*')
        );
    }
    
    // ğŸ“ í•™ìƒ ì œì¶œ ìë£Œ
    match /submissions/{lessonId}/{studentId}/{fileName} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì í—ˆìš©
      allow read: if true;
      
      // ì“°ê¸°: ê¸°ë³¸ì ìœ¼ë¡œ í—ˆìš© (í•™ìƒë“¤ì´ ììœ ë¡­ê²Œ ì œì¶œ ê°€ëŠ¥)
      // íŒŒì¼ í¬ê¸° ë° í˜•ì‹ ì œí•œ
      allow write: if request.resource.size < 5 * 1024 * 1024
        && (
          request.resource.contentType.matches('image/.*') ||
          request.resource.contentType == 'application/pdf' ||
          request.resource.contentType == 'text/plain'
        );
    }
    
    // ğŸ“Š QR ì½”ë“œ ì´ë¯¸ì§€
    match /qr_codes/{lessonId} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì í—ˆìš© (PNG íŒŒì¼ë§Œ)
      allow read: if true;
      
      // ì“°ê¸°: ì¸ì¦ëœ êµì‚¬ë§Œ í—ˆìš©
      allow write: if request.auth != null 
        && request.auth.token.email != null
        && request.resource.contentType.matches('image/.*');
    }
    
    // ğŸ¨ ì„ì‹œ íŒŒì¼ (contentExtractorê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì„ì‹œ ì €ì¥ì†Œ)
    match /temp/{fileName} {
      // ì½ê¸°: ëª¨ë“  ì‚¬ìš©ì í—ˆìš©
      allow read: if true;
      
      // ì“°ê¸°: ì¸ì¦ëœ ì‚¬ìš©ìë§Œ + ì†Œìš©ëŸ‰ ë°ì´í„°
      allow write: if request.auth != null
        && request.resource.size < 2 * 1024 * 1024; // 2MB ì œí•œ
    }
    
    // ğŸš« ê¸°íƒ€ ëª¨ë“  ê²½ë¡œëŠ” ì ‘ê·¼ ê¸ˆì§€
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
